<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sanitary & Storm Drain Calculator</title>

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #64748b;
      --light: #f8fafc;
      --dark: #0f172a;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #cbd5e1;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f1f5f9;
      color: var(--dark);
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    h1 {
      font-size: 2.2em;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .subtitle {
      font-size: 1.1em;
      opacity: 0.9;
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    @media (max-width: 900px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }
    
    .section {
      margin-bottom: 25px;
      padding: 20px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .section h2 {
      font-size: 1.5em;
      margin-bottom: 20px;
      color: var(--primary);
      border-bottom: 2px solid var(--border);
      padding-bottom: 10px;
    }
    
    .form-row {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      gap: 15px;
    }
    
    .form-row label {
      flex: 0 0 180px;
      font-weight: 500;
      margin: 0;
      text-align: right;
    }
    
    .form-row .input-group {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .form-row input, .form-row select {
      flex: 1;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid var(--border);
      background-color: white;
      color: var(--dark);
      font-size: 1em;
      min-width: 0;
    }
    
    .form-row input:focus, .form-row select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .form-row .unit {
      flex: 0 0 40px;
      font-weight: 500;
    }
    
    .checkbox-row {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .checkbox-row input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
    }
    
    button {
      padding: 12px 20px;
      border-radius: 5px;
      border: none;
      background-color: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 1em;
    }
    
    button:hover {
      background-color: var(--primary-dark);
    }
    
    button.secondary {
      background-color: var(--secondary);
    }
    
    button.secondary:hover {
      background-color: #475569;
    }
    
    .output {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8fafc;
      border-radius: 8px;
      white-space: pre-line;
      color: var(--dark);
      border-left: 4px solid var(--primary);
    }
    
    .output h3 {
      margin-top: 0;
      color: var(--primary);
    }
    
    .export-section {
      grid-column: 1 / -1;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .validation-error {
      color: var(--danger);
      font-size: 0.9em;
      margin-top: 5px;
      display: none;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      white-space: nowrap;
    }
    
    .tab.active {
      border-bottom: 3px solid var(--primary);
      font-weight: 600;
      color: var(--primary);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .summary-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }
    
    .summary-card h3 {
      margin-top: 0;
      color: var(--primary);
    }
    
    .cost-breakdown {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .cost-breakdown th, .cost-breakdown td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    .cost-breakdown th {
      background-color: #f1f5f9;
      font-weight: 600;
    }
    
    .cost-breakdown tr:last-child td {
      border-bottom: none;
      font-weight: 600;
      background-color: #f1f5f9;
    }
    
    .grey-header {
      background-color: #e0e0e0 !important;
      font-weight: bold !important;
    }
    
    .project-info {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    
    .disclaimer {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-size: 14px;
      color: #000000;
    }
    
    .material-costs {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
    }
    
    .labor-inputs {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
    }
    
    .productivity-info {
      background: #e8f4fd;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
      border-left: 4px solid var(--primary);
    }
    
    .productivity-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9em;
    }
    
    .productivity-table th, .productivity-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    .productivity-table th {
      background-color: #f1f5f9;
    }
    
    .pipe-size-group {
      display: none;
      margin-left: 20px;
      border-left: 2px solid #ddd;
      padding-left: 15px;
    }
    
    .pipe-size-group.active {
      display: block;
    }
    
    .material-type {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .material-type h4 {
      margin: 0 0 10px 0;
      color: var(--primary);
    }
    
    .section-header {
      background-color: #e9ecef;
      padding: 8px 15px;
      margin: 15px 0 10px 0;
      border-radius: 4px;
      font-weight: bold;
    }
    
    .formula-section {
      background: #f0f9ff;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid var(--primary);
    }
    
    .formula {
      font-family: monospace;
      background: #f8fafc;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      border-left: 3px solid var(--primary);
    }
    
    .help-step {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .help-step h4 {
      margin: 0 0 8px 0;
      color: var(--primary);
    }
    
    .reference-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 0.9em;
    }
    
    .reference-table th, .reference-table td {
      padding: 8px;
      text-align: left;
      border: 1px solid #ddd;
    }
    
    .reference-table th {
      background-color: #f1f5f9;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    h3 {
      margin-top: 25px;
      margin-bottom: 15px;
      color: var(--primary);
      font-size: 1.3em;
    }
    
    /* Fix for specific alignment issues */
    .material-costs .form-row {
      align-items: flex-start;
    }
    
    .material-costs .form-row label {
      padding-top: 10px;
    }

    .pipe-size-inputs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    
    .pipe-size-input {
      display: flex;
      flex-direction: column;
    }
    
    .pipe-size-input label {
      font-size: 0.9em;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .warning {
      color: var(--warning);
      font-weight: 500;
    }
    
    .error {
      color: var(--danger);
      font-weight: 500;
    }
    
    .system-costs {
      background: #f0f9ff;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    
    .system-costs h4 {
      margin-top: 0;
      color: var(--primary);
    }
    
    .pipe-cost-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    
    .pipe-cost-row select, .pipe-cost-row input {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }
    
    .pipe-cost-row .size-select {
      width: 80px;
    }
    
    .pipe-cost-row .cost-input {
      width: 120px;
    }
    
    .add-pipe-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    
    .remove-pipe-btn {
      background: var(--danger);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Sanitary & Storm Drain Calculator</h1>
      <div class="subtitle">Professional quantity takeoff for plumbing contractors and estimators</div>
      <div class="disclaimer">
        <strong>Note:</strong> This calculator uses practical approximations based on plumbing codes. 
        For formal design, consult the actual code provisions and a licensed engineer.
      </div>
    </header>
    
    <div class="tabs">
      <div class="tab active" onclick="switchTab('project')">Project Info</div>
      <div class="tab" onclick="switchTab('sanitary')">Sanitary System</div>
      <div class="tab" onclick="switchTab('storm')">Storm System</div>
      <div class="tab" onclick="switchTab('costs')">Costs & Labor</div>
      <div class="tab" onclick="switchTab('summary')">Summary & Export</div>
      <div class="tab" onclick="switchTab('help')">Help & Formulas</div>
    </div>
    
    <!-- Project Information Section -->
    <div id="project-tab" class="tab-content active">
      <div class="section">
        <h2>Project Information</h2>
        <div class="project-info">
          <div class="form-row">
            <label for="projectName">Project Name:</label>
            <div class="input-group">
              <input type="text" id="projectName" placeholder="Enter Project Name" value="Residential Plumbing Project">
            </div>
            <div class="validation-error" id="projectNameError">Project name is required</div>
          </div>
          <div class="form-row">
            <label for="clientName">Client Name:</label>
            <div class="input-group">
              <input type="text" id="clientName" placeholder="Enter Client Name" value="John Dela Cruz">
            </div>
          </div>
          <div class="form-row">
            <label for="projectLocation">Project Location:</label>
            <div class="input-group">
              <input type="text" id="projectLocation" placeholder="Enter Location" value="Manila, Philippines">
            </div>
          </div>
          <div class="form-row">
            <label for="preparedBy">Prepared By:</label>
            <div class="input-group">
              <input type="text" id="preparedBy" placeholder="Enter Name" value="Maria Santos, Civil Engineer">
            </div>
          </div>
          <div class="form-row">
            <label for="currency">Currency:</label>
            <div class="input-group">
              <select id="currency">
                <option value="PHP">Philippine Peso (₱)</option>
                <option value="USD">US Dollar ($)</option>
                <option value="EUR">Euro (€)</option>
                <option value="JPY">Japanese Yen (¥)</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="form-row">
          <label for="codeStandard">Plumbing Code Standard:</label>
          <div class="input-group">
            <select id="codeStandard">
              <option value="rnpcp">RNPCP (Philippines)</option>
              <option value="ipc">IPC (International)</option>
              <option value="upc">UPC (Uniform)</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <label for="units">Measurement Units:</label>
          <div class="input-group">
            <select id="units">
              <option value="metric">Metric (m, mm, L/s)</option>
              <option value="imperial">Imperial (ft, in, gpm)</option>
            </select>
          </div>
        </div>
        
        <div class="button-group">
          <button onclick="saveProject()">Save Project</button>
          <button class="secondary" onclick="loadProject()">Load Project</button>
        </div>
      </div>
    </div>
    
    <!-- Sanitary Input Section -->
    <div id="sanitary-tab" class="tab-content">
      <div class="section">
        <h2>Sanitary System</h2>
        
        <h3>Fixture Count</h3>
        <div class="form-row">
          <label for="wc">Water Closets:</label>
          <div class="input-group">
            <input type="number" id="wc" value="2" min="0">
          </div>
        </div>
        <div class="form-row">
          <label for="lav">Lavatories:</label>
          <div class="input-group">
            <input type="number" id="lav" value="2" min="0">
          </div>
        </div>
        <div class="form-row">
          <label for="sink">Kitchen Sinks:</label>
          <div class="input-group">
            <input type="number" id="sink" value="1" min="0">
          </div>
        </div>
        <div class="form-row">
          <label for="shower">Showers:</label>
          <div class="input-group">
            <input type="number" id="shower" value="1" min="0">
          </div>
        </div>
        <div class="form-row">
          <label for="tub">Bathtubs:</label>
          <div class="input-group">
            <input type="number" id="tub" value="1" min="0">
          </div>
        </div>
        <div class="form-row">
          <label for="urinal">Urinals:</label>
          <div class="input-group">
            <input type="number" id="urinal" value="0" min="0">
          </div>
        </div>
        <div class="form-row">
          <label for="floorDrain">Floor Drains:</label>
          <div class="input-group">
            <input type="number" id="floorDrain" value="2" min="0">
          </div>
        </div>
        
        <h3>Pipe System</h3>
        <div class="form-row">
          <label for="sanLength">Total Developed Length:</label>
          <div class="input-group">
            <input type="number" id="sanLength" value="50" min="0" step="0.1">
            <span class="unit" id="sanLengthUnit">m</span>
          </div>
        </div>
        <div class="form-row">
          <label for="sanPipeMaterial">Pipe Material:</label>
          <div class="input-group">
            <select id="sanPipeMaterial">
              <option value="pvc">PVC</option>
              <option value="castIron">Cast Iron</option>
              <option value="hdp">HDPE</option>
              <option value="abs">ABS</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <label for="sanPipeLength">Commercial Pipe Length:</label>
          <div class="input-group">
            <select id="sanPipeLength">
              <option value="3">3 m</option>
              <option value="6" selected>6 m</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <label for="sanSlope">Pipe Slope (%):</label>
          <div class="input-group">
            <input type="number" id="sanSlope" value="2" min="0.5" max="10" step="0.1">
          </div>
        </div>
        
        <h3>Accessories (optional - will calculate defaults if empty)</h3>
        <div class="form-row">
          <label for="traps">Traps:</label>
          <div class="input-group">
            <input type="number" id="traps" placeholder="Default = # of fixtures" min="0">
          </div>
        </div>
        <div class="form-row">
          <label for="vents">Vents:</label>
          <div class="input-group">
            <input type="number" id="vents" placeholder="Default = 1 per fixture" min="0">
          </div>
        </div>
        <div class="form-row">
          <label for="cleanouts">Cleanouts:</label>
          <div class="input-group">
            <input type="number" id="cleanouts" placeholder="Default = based on code standard" min="0">
          </div>
        </div>
        <div class="form-row">
          <label for="sanManholes">Manholes:</label>
          <div class="input-group">
            <input type="number" id="sanManholes" placeholder="Default = 1 per 50 m" min="0">
          </div>
        </div>
        <div class="form-row">
          <label for="sanFittings">Fittings/Elbows:</label>
          <div class="input-group">
            <input type="number" id="sanFittings" placeholder="Default = 1 per 10 m" min="0">
          </div>
        </div>
        
        <div class="button-group">
          <button onclick="calculateSanitary()">Calculate Sanitary System</button>
        </div>
        <div class="output" id="sanitaryOutput"></div>
      </div>
    </div>
    
    <!-- Storm Input Section -->
    <div id="storm-tab" class="tab-content">
      <div class="section">
        <h2>Storm Drain System</h2>
        
        <h3>Runoff Calculation</h3>
        <div class="form-row">
          <label for="roofArea">Roof Area:</label>
          <div class="input-group">
            <input type="number" id="roofArea" value="200" min="0" step="0.1">
            <span class="unit" id="roofAreaUnit">m²</span>
          </div>
        </div>
        <div class="form-row">
          <label for="pavementArea">Pavement Area:</label>
          <div class="input-group">
            <input type="number" id="pavementArea" value="0" min="0" step="0.1">
            <span class="unit" id="pavementAreaUnit">m²</span>
          </div>
        </div>
        <div class="form-row">
          <label for="coef">Runoff Coefficient (C):</label>
          <div class="input-group">
            <input type="number" id="coef" value="0.9" min="0.1" max="1" step="0.05">
          </div>
        </div>
        <div class="form-row">
          <label for="intensity">Rainfall Intensity:</label>
          <div class="input-group">
            <input type="number" id="intensity" value="50" min="1" step="1">
            <span class="unit" id="intensityUnit">mm/hr</span>
          </div>
        </div>
        
        <h3>Pipe System</h3>
        <div class="form-row">
          <label for="stormLength">Total Developed Length:</label>
          <div class="input-group">
            <input type="number" id="stormLength" value="60" min="0" step="0.1">
            <span class="unit" id="stormLengthUnit">m</span>
          </div>
        </div>
        <div class="form-row">
          <label for="stormPipeMaterial">Pipe Material:</label>
          <div class="input-group">
            <select id="stormPipeMaterial">
              <option value="pvc">PVC</option>
              <option value="corrugated">Corrugated HDPE</option>
              <option value="concrete">Concrete</option>
              <option value="castIron">Cast Iron</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <label for="stormPipeLength">Commercial Pipe Length:</label>
          <div class="input-group">
            <select id="stormPipeLength">
              <option value="3">3 m</option>
              <option value="6" selected>6 m</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <label for="stormSlope">Pipe Slope (%):</label>
          <div class="input-group">
            <input type="number" id="stormSlope" value="1" min="0.5" max="10" step="0.1">
          </div>
        </div>
        
        <h3>Accessories (optional - will calculate defaults if empty)</h3>
        <div class="form-row">
          <label for="downspouts">Downspouts:</label>
          <div class="input-group">
            <input type="number" id="downspouts" placeholder="Default = 1 per 100 m² roof" min="0">
          </div>
        </div>
        <div class="form-row">
          <label for="catchBasins">Catch Basins:</label>
          <div class="input-group">
            <input type="number" id="catchBasins" placeholder="Default = every 60 m" min="0">
          </div>
        </div>
        <div class="form-row">
          <label for="stormManholes">Manholes:</label>
          <div class="input-group">
            <input type="number" id="stormManholes" placeholder="Default = every 50 m" min="0">
          </div>
        </div>
        <div class="form-row">
          <label for="stormFittings">Fittings/Elbows:</label>
          <div class="input-group">
            <input type="number" id="stormFittings" placeholder="Default = 1 per 10 m" min="0">
          </div>
        </div>
        
        <div class="button-group">
          <button onclick="calculateStorm()">Calculate Storm Drain System</button>
        </div>
        <div class="output" id="stormOutput"></div>
      </div>
    </div>
    
    <!-- Costs & Labor Section -->
    <div id="costs-tab" class="tab-content">
      <div class="section">
        <h2>Costs & Labor Estimation</h2>
        
        <div class="material-costs">
          <h3>Material Costs</h3>
          
          <div class="system-costs">
            <h4>Sanitary System</h4>
            <div id="sanitaryPipesContainer">
              <!-- Dynamic sanitary pipes will be added here -->
            </div>
            <button class="add-pipe-btn" onclick="addSanitaryPipe()">+ Add Pipe</button>
          </div>
          
          <div class="system-costs">
            <h4>Storm Drain System</h4>
            <div id="stormPipesContainer">
              <!-- Dynamic storm pipes will be added here -->
            </div>
            <button class="add-pipe-btn" onclick="addStormPipe()">+ Add Pipe</button>
          </div>
          
          <div class="section-header">Accessories</div>
          
          <div class="form-row">
            <label for="trapCost">Trap Cost (each):</label>
            <div class="input-group">
              <input type="number" id="trapCost" value="15" min="0" step="0.01">
            </div>
          </div>
          <div class="form-row">
            <label for="ventCost">Vent Cost (each):</label>
            <div class="input-group">
              <input type="number" id="ventCost" value="8" min="0" step="0.01">
            </div>
          </div>
          <div class="form-row">
            <label for="cleanoutCost">Cleanout Cost (each):</label>
            <div class="input-group">
              <input type="number" id="cleanoutCost" value="25" min="0" step="0.01">
            </div>
          </div>
          <div class="form-row">
            <label for="manholeCost">Manhole Cost (each):</label>
            <div class="input-group">
              <input type="number" id="manholeCost" value="500" min="0" step="0.01">
            </div>
          </div>
          <div class="form-row">
            <label for="fittingCost">Fitting/Elbow Cost (each):</label>
            <div class="input-group">
              <input type="number" id="fittingCost" value="8" min="0" step="0.01">
            </div>
          </div>
          <div class="form-row">
            <label for="downspoutCost">Downspout Cost (each):</label>
            <div class="input-group">
              <input type="number" id="downspoutCost" value="45" min="0" step="0.01">
            </div>
          </div>
          <div class="form-row">
            <label for="catchBasinCost">Catch Basin Cost (each):</label>
            <div class="input-group">
              <input type="number" id="catchBasinCost" value="150" min="0" step="0.01">
            </div>
          </div>
        </div>
        
        <div class="labor-inputs">
          <h3>Labor Requirements</h3>
          <div class="form-row">
            <label for="productivityStandard">Productivity Standard:</label>
            <div class="input-group">
              <select id="productivityStandard">
                <option value="philippines">Manual/Low-tech</option>
                <option value="international">Mechanized/High-tech</option>
                <option value="custom">Custom Productivity Rates</option>
              </select>
            </div>
          </div>
          
          <div id="customProductivityRates" style="display: none;">
            <h4>Custom Productivity Rates</h4>
            <div class="form-row">
              <label for="customPipeLaying">Pipe Laying (m/day):</label>
              <div class="input-group">
                <input type="number" id="customPipeLaying" value="10" min="1" step="0.1">
              </div>
            </div>
            <div class="form-row">
              <label for="customManhole">Manhole Construction (units/day):</label>
              <div class="input-group">
                <input type="number" id="customManhole" value="0.8" min="0.1" step="0.1">
              </div>
            </div>
            <div class="form-row">
              <label for="customCatchBasin">Catch Basin (units/day):</label>
              <div class="input-group">
                <input type="number" id="customCatchBasin" value="1.2" min="0.1" step="0.1">
              </div>
            </div>
            <div class="form-row">
              <label for="customFitting">Fittings Installation (units/day):</label>
              <div class="input-group">
                <input type="number" id="customFitting" value="20" min="1" step="1">
              </div>
            </div>
          </div>
          
          <h4>Crew Composition</h4>
          <div class="form-row">
            <label for="pipeCrewPlumbers">Pipe Laying Crew (Plumbers):</label>
            <div class="input-group">
              <input type="number" id="pipeCrewPlumbers" value="1" min="1" step="1">
            </div>
          </div>
          <div class="form-row">
            <label for="pipeCrewHelpers">Pipe Laying Crew (Helpers):</label>
            <div class="input-group">
              <input type="number" id="pipeCrewHelpers" value="2" min="0" step="1">
            </div>
          </div>
          <div class="form-row">
            <label for="fittingCrewPlumbers">Fitting Crew (Plumbers):</label>
            <div class="input-group">
              <input type="number" id="fittingCrewPlumbers" value="1" min="1" step="1">
            </div>
          </div>
          <div class="form-row">
            <label for="fittingCrewHelpers">Fitting Crew (Helpers):</label>
            <div class="input-group">
              <input type="number" id="fittingCrewHelpers" value="1" min="0" step="1">
            </div>
          </div>
          
          <div class="form-row">
            <label for="plumberRate">Plumber Rate (per hour):</label>
            <div class="input-group">
              <input type="number" id="plumberRate" value="80" min="0" step="0.1">
            </div>
          </div>
          <div class="form-row">
            <label for="helperRate">Helper Rate (per hour):</label>
            <div class="input-group">
              <input type="number" id="helperRate" value="50" min="0" step="0.1">
            </div>
          </div>
          <div class="form-row">
            <label for="dailyHours">Daily Work Hours:</label>
            <div class="input-group">
              <input type="number" id="dailyHours" value="8" min="1" max="12">
            </div>
          </div>
          <div class="form-row">
            <label for="wasteFactor">Waste Factor (%):</label>
            <div class="input-group">
              <input type="number" id="wasteFactor" value="5" min="0" max="50">
            </div>
          </div>
          <div class="form-row">
            <label for="overhead">Overhead (%):</label>
            <div class="input-group">
              <input type="number" id="overhead" value="15" min="0" max="50">
            </div>
          </div>
          <div class="form-row">
            <label for="profitMargin">Profit Margin (%):</label>
            <div class="input-group">
              <input type="number" id="profitMargin" value="10" min="0" max="50">
            </div>
          </div>
        </div>
        
        <div class="productivity-info">
          <h3>Productivity Reference</h3>
          <table class="productivity-table">
            <thead>
              <tr>
                <th>Work Item</th>
                <th>Manual/Low-tech</th>
                <th>Mechanized/High-tech</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>PVC/HDPE Pipe Laying (m/day)</td>
                <td>10-15 m</td>
                <td>20-30 m</td>
              </tr>
              <tr>
                <td>Concrete Pipe Laying (m/day)</td>
                <td>4-6 m</td>
                <td>8-12 m</td>
              </tr>
              <tr>
                <td>Manhole Construction (units/day)</td>
                <td>0.6-1.0</td>
                <td>1-2</td>
              </tr>
              <tr>
                <td>Catch Basin (units/day)</td>
                <td>1-1.5</td>
                <td>2-3</td>
              </tr>
              <tr>
                <td>Fittings Installation (units/day)</td>
                <td>15-25</td>
                <td>30-50</td>
              </tr>
            </tbody>
          </table>
          <p><small>Note: Productivity rates are per crew, not per individual worker. Manual/Low-tech rates reflect manual labor while Mechanized/High-tech rates assume mechanized equipment.</small></p>
        </div>
        
        <div class="button-group">
          <button onclick="calculateCosts()">Calculate Total Costs</button>
        </div>
        <div class="output" id="costsOutput"></div>
      </div>
    </div>
    
    <!-- Summary Section -->
    <div id="summary-tab" class="tab-content">
      <div class="section">
        <h2>Project Summary</h2>
        
        <div class="summary-card">
          <h3>Sanitary System Summary</h3>
          <div id="sanitarySummary">Calculate sanitary system first</div>
        </div>
        
        <div class="summary-card">
          <h3>Storm System Summary</h3>
          <div id="stormSummary">Calculate storm system first</div>
        </div>
        
        <div class="summary-card">
          <h3>Cost Estimation</h3>
          <div id="costSummary">Calculate costs first</div>
          <table class="cost-breakdown" id="costTable">
            <tr>
              <th>Description</th>
              <th>Quantity</th>
              <th>Unit</th>
              <th>Unit Rate</th>
              <th>Amount</th>
            </tr>
          </table>
        </div>
        
        <div class="export-section">
          <button onclick="exportToPDF()">Export to PDF</button>
          <button onclick="exportToExcel()">Export to Excel</button>
        </div>
      </div>
    </div>
    
    <!-- Help & Formulas Section -->
    <div id="help-tab" class="tab-content">
      <div class="section">
        <h2>Help & Formulas</h2>
        
        <div class="help-step">
          <h4>How to Use This Calculator</h4>
          <p>Follow these steps to calculate your sanitary and storm drain systems:</p>
          <ol>
            <li><strong>Project Info:</strong> Enter basic project information and select your preferred units and code standard.</li>
            <li><strong>Sanitary System:</strong> Enter fixture counts and pipe system details. The calculator will determine DFU (Drainage Fixture Units) and recommend pipe sizes.</li>
            <li><strong>Storm System:</strong> Enter drainage areas and rainfall data. The calculator will determine runoff and recommend pipe sizes.</li>
            <li><strong>Costs & Labor:</strong> Enter material costs and labor rates. The calculator will provide a detailed cost breakdown.</li>
            <li><strong>Summary & Export:</strong> Review the complete project summary and export to PDF or Excel.</li>
          </ol>
        </div>
        
        <div class="formula-section">
          <h4>Calculation Formulas</h4>
          
          <h5>Sanitary System Calculations</h5>
          <div class="formula">
            Total DFU = Σ(Fixture Count × DFU Value per Fixture)
          </div>
          <p>Where DFU values are based on the selected plumbing code standard:</p>
          
          <table class="reference-table">
            <thead>
              <tr>
                <th>Fixture</th>
                <th>RNPCP (Philippines)</th>
                <th>IPC (International)</th>
                <th>UPC (Uniform)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Water Closet</td>
                <td>6</td>
                <td>4</td>
                <td>4</td>
              </tr>
              <tr>
                <td>Lavatory</td>
                <td>1</td>
                <td>1</td>
                <td>1</td>
              </tr>
              <tr>
                <td>Kitchen Sink</td>
                <td>2</td>
                <td>2</td>
                <td>2</td>
              </tr>
              <tr>
                <td>Shower</td>
                <td>2</td>
                <td>2</td>
                <td>2</td>
              </tr>
              <tr>
                <td>Bathtub</td>
                <td>2</td>
                <td>2</td>
                <td>2</td>
              </tr>
              <tr>
                <td>Urinal</td>
                <td>4</td>
                <td>4</td>
                <td>4</td>
              </tr>
              <tr>
                <td>Floor Drain</td>
                <td>2</td>
                <td>2</td>
                <td>2</td>
              </tr>
            </tbody>
          </table>
          
          <div class="formula">
            Peak Flow (L/s) = (Total DFU / 2) × 0.06308
          </div>
          <div class="formula">
            Peak Flow (gpm) = Total DFU / 7.5
          </div>
          
          <h5>Storm System Calculations</h5>
          <div class="formula">
            Q = (C × I × A) / 3600 (for metric units - L/s)
          </div>
          <div class="formula">
            Q = (C × I × A) / 96.23 (for imperial units - gpm)
          </div>
          <p>Where:</p>
          <ul>
            <li>Q = Peak runoff flow rate</li>
            <li>C = Runoff coefficient (0.1-1.0)</li>
            <li>I = Rainfall intensity (mm/hr or in/hr)</li>
            <li>A = Drainage area (m² or ft²)</li>
          </ul>
          
          <h5>Cost Calculations</h5>
          <div class="formula">
            Material Cost = Σ(Quantity × Unit Cost)
          </div>
          <div class="formula">
            Material Cost with Waste = Material Cost × (1 + Waste Factor)
          </div>
          <div class="formula">
            Labor Cost = Σ(Labor Days × Daily Rate)
          </div>
          <div class="formula">
            Subtotal = Material Cost with Waste + Labor Cost
          </div>
          <div class="formula">
            Overhead = Subtotal × Overhead Percentage
          </div>
          <div class="formula">
            Profit = (Subtotal + Overhead) × Profit Margin
          </div>
          <div class="formula">
            Total Project Cost = Subtotal + Overhead + Profit
          </div>
        </div>
        
        <div class="help-step">
          <h4>Standards References</h4>
          <p>This calculator is based on the following plumbing standards:</p>
          <ul>
            <li><strong>RNPCP:</strong> Revised National Plumbing Code of the Philippines</li>
            <li><strong>IPC:</strong> International Plumbing Code</li>
            <li><strong>UPC:</strong> Uniform Plumbing Code</li>
          </ul>
          <p>For formal design and construction, always consult the complete code provisions and work with a licensed engineer.</p>
        </div>
        
        <div class="help-step">
          <h4>Tips for Accurate Calculations</h4>
          <ul>
            <li>Always verify local rainfall intensity data for storm drain calculations</li>
            <li>Consider soil conditions and groundwater levels when selecting pipe materials</li>
            <li>Account for future expansion when sizing pipes</li>
            <li>Update material costs regularly to reflect current market prices</li>
            <li>Adjust productivity rates based on site-specific conditions</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize jsPDF
    const { jsPDF } = window.jspdf;
    
    // DFU tables for different codes
    const dfuTables = {
      rnpcp: { wc: 6, lav: 1, sink: 2, shower: 2, tub: 2, urinal: 4, floorDrain: 2 },
      ipc: { wc: 4, lav: 1, sink: 2, shower: 2, tub: 2, urinal: 4, floorDrain: 2 },
      upc: { wc: 4, lav: 1, sink: 2, shower: 2, tub: 2, urinal: 4, floorDrain: 2 }
    };
    
    // Pipe sizing data
    const pipeSizing = {
      sanitary: {
        pvc: { "2": 21, "3": 42, "4": 120, "6": 500 },
        castIron: { "2": 20, "3": 40, "4": 110, "6": 480 },
        hdp: { "2": 21, "3": 42, "4": 120, "6": 500 },
        abs: { "2": 21, "3": 42, "4": 120, "6": 500 }
      },
      storm: {
        pvc: { "4": 25, "6": 75, "8": 180, "10": 320 },
        corrugated: { "4": 30, "6": 80, "8": 200, "10": 350 },
        concrete: { "4": 25, "6": 75, "8": 180, "10": 320 },
        castIron: { "4": 25, "6": 75, "8": 180, "10": 320 }
      }
    };
    
    // Productivity rates (per crew per day)
    const productivityRates = {
      philippines: {
        pvcPipe: 12,        // meters per day
        hdpPipe: 12,        // meters per day
        absPipe: 12,        // meters per day
        castIronPipe: 8,    // meters per day
        concretePipe: 5,    // meters per day
        corrugatedPipe: 10, // meters per day
        manhole: 0.8,       // units per day
        catchBasin: 1.2,    // units per day
        fitting: 20,        // units per day
        trap: 25,           // units per day
        vent: 25,           // units per day
        cleanout: 15,       // units per day
        downspout: 8        // units per day
      },
      international: {
        pvcPipe: 25,        // meters per day
        hdpPipe: 25,        // meters per day
        absPipe: 25,        // meters per day
        castIronPipe: 15,   // meters per day
        concretePipe: 10,   // meters per day
        corrugatedPipe: 20, // meters per day
        manhole: 1.5,       // units per day
        catchBasin: 2.5,    // units per day
        fitting: 40,        // units per day
        trap: 50,           // units per day
        vent: 50,           // units per day
        cleanout: 30,       // units per day
        downspout: 15       // units per day
      }
    };

    // Accessory defaults based on plumbing codes
    const accessoryDefaults = {
      cleanouts: {
        rnpcp: runLength => Math.ceil(runLength / 30), // 30 m per RNPCP
        ipc: runLength => Math.ceil(runLength / (units === 'metric' ? 30.48 : 100)), // 100 ft per IPC
        upc: runLength => Math.ceil(runLength / (units === 'metric' ? 30.48 : 100)) // 100 ft per UPC
      },
      vents: {
        rnpcp: fixtureCount => fixtureCount,
        ipc: fixtureCount => fixtureCount,
        upc: fixtureCount => fixtureCount
      },
      traps: {
        rnpcp: fixtureCount => fixtureCount,
        ipc: fixtureCount => fixtureCount,
        upc: fixtureCount => fixtureCount
      }
    };

    // Debounce timer
    let debounceTimeout;

    // Initialize the calculator
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize units
      document.getElementById('units').addEventListener('change', updateUnits);
      updateUnits();
      
      // Productivity standard change handler
      document.getElementById('productivityStandard').addEventListener('change', function() {
        const customRatesDiv = document.getElementById('customProductivityRates');
        if (this.value === 'custom') {
          customRatesDiv.style.display = 'block';
        } else {
          customRatesDiv.style.display = 'none';
        }
      });
      
      // Add event listeners to cost inputs for auto-calculation with debouncing
      const costInputs = document.querySelectorAll('.material-costs input, .labor-inputs input');
      costInputs.forEach(input => {
        input.addEventListener('input', () => {
          clearTimeout(debounceTimeout);
          debounceTimeout = setTimeout(calculateCosts, 500);
        });
      });
      
      // Initialize pipe cost inputs
      initializePipeCosts();
    });
    
    // Initialize pipe costs based on system selections
    function initializePipeCosts() {
      // Add default pipes for sanitary system
      addSanitaryPipe();
      
      // Add default pipes for storm system
      addStormPipe();
    }
    
    // Add sanitary pipe cost input
    function addSanitaryPipe() {
      const container = document.getElementById('sanitaryPipesContainer');
      const pipeId = 'sanitaryPipe_' + Date.now();
      
      const pipeRow = document.createElement('div');
      pipeRow.className = 'pipe-cost-row';
      pipeRow.id = pipeId;
      
      // Get the selected material from sanitary system
      const material = document.getElementById('sanPipeMaterial').value;
      const materialName = getMaterialName(material);
      
      pipeRow.innerHTML = `
        <select class="size-select" onchange="updatePipeCost('${pipeId}')">
          <option value="2">2"</option>
          <option value="3">3"</option>
          <option value="4" selected>4"</option>
          <option value="6">6"</option>
        </select>
        <span>${materialName} Pipe Cost:</span>
        <input type="number" class="cost-input" value="${getDefaultPipeCost(material, '4')}" min="0" step="0.01" onchange="updatePipeCost('${pipeId}')">
        <button class="remove-pipe-btn" onclick="removePipe('${pipeId}')">Remove</button>
      `;
      
      container.appendChild(pipeRow);
    }
    
    // Add storm pipe cost input
    function addStormPipe() {
      const container = document.getElementById('stormPipesContainer');
      const pipeId = 'stormPipe_' + Date.now();
      
      const pipeRow = document.createElement('div');
      pipeRow.className = 'pipe-cost-row';
      pipeRow.id = pipeId;
      
      // Get the selected material from storm system
      const material = document.getElementById('stormPipeMaterial').value;
      const materialName = getMaterialName(material);
      
      pipeRow.innerHTML = `
        <select class="size-select" onchange="updatePipeCost('${pipeId}')">
          <option value="4" selected>4"</option>
          <option value="6">6"</option>
          <option value="8">8"</option>
          <option value="10">10"</option>
        </select>
        <span>${materialName} Pipe Cost:</span>
        <input type="number" class="cost-input" value="${getDefaultPipeCost(material, '4')}" min="0" step="0.01" onchange="updatePipeCost('${pipeId}')">
        <button class="remove-pipe-btn" onclick="removePipe('${pipeId}')">Remove</button>
      `;
      
      container.appendChild(pipeRow);
    }
    
    // Remove pipe cost input
    function removePipe(pipeId) {
      const pipeRow = document.getElementById(pipeId);
      if (pipeRow) {
        pipeRow.remove();
      }
    }
    
    // Update pipe cost when size changes
    function updatePipeCost(pipeId) {
      const pipeRow = document.getElementById(pipeId);
      if (!pipeRow) return;
      
      const sizeSelect = pipeRow.querySelector('.size-select');
      const costInput = pipeRow.querySelector('.cost-input');
      const size = sizeSelect.value;
      
      // Determine material based on pipe ID prefix
      let material;
      if (pipeId.startsWith('sanitaryPipe_')) {
        material = document.getElementById('sanPipeMaterial').value;
      } else if (pipeId.startsWith('stormPipe_')) {
        material = document.getElementById('stormPipeMaterial').value;
      }
      
      // Update cost with default value for the selected size
      costInput.value = getDefaultPipeCost(material, size);
    }
    
    // Get material display name
    function getMaterialName(material) {
      const materialNames = {
        pvc: 'PVC',
        castIron: 'Cast Iron',
        hdp: 'HDPE',
        abs: 'ABS',
        corrugated: 'Corrugated HDPE',
        concrete: 'Concrete'
      };
      return materialNames[material] || material.toUpperCase();
    }
    
    // Default pipe costs
    function getDefaultPipeCost(materialType, size) {
      const baseCosts = {
        'pvc': { '2': 25, '3': 35, '4': 50, '6': 85 },
        'castIron': { '2': 65, '3': 95, '4': 130, '6': 200 },
        'hdp': { '2': 32, '3': 45, '4': 65, '6': 110 },
        'abs': { '2': 28, '3': 40, '4': 55, '6': 90 },
        'corrugated': { '4': 15, '6': 25, '8': 40, '10': 60 },
        'concrete': { '4': 55, '6': 85, '8': 120, '10': 180 }
      };
      
      return baseCosts[materialType]?.[size] || 0;
    }
    
    // Tab switching function
    function switchTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(tabName + '-tab').classList.add('active');
      
      // Add active class to clicked tab
      event.target.classList.add('active');
      
      // Auto-calculate costs when switching to summary tab
      if (tabName === 'summary') {
        calculateCosts();
      }
    }
    
    // Unit conversion based on selection
    function updateUnits() {
      const units = document.getElementById('units').value;
      const isMetric = units === 'metric';
      
      // Update unit labels
      document.getElementById('sanLengthUnit').textContent = isMetric ? 'm' : 'ft';
      document.getElementById('roofAreaUnit').textContent = isMetric ? 'm²' : 'ft²';
      document.getElementById('pavementAreaUnit').textContent = isMetric ? 'm²' : 'ft²';
      document.getElementById('intensityUnit').textContent = isMetric ? 'mm/hr' : 'in/hr';
      document.getElementById('stormLengthUnit').textContent = isMetric ? 'm' : 'ft';
    }
    
    // Check flow velocity for pipe sizing
    function checkVelocity(flowRate, pipeSize, slope, isMetric, system) {
      const diameter = parseInt(pipeSize) * (isMetric ? 0.0254 : 1/12); // Convert to meters or feet
      const area = Math.PI * Math.pow(diameter/2, 2); // Cross-sectional area
      const velocity = flowRate / (isMetric ? area : area * 7.4805); // Convert L/s to cfs for imperial
      const minVelocity = system === 'sanitary' ? (isMetric ? 0.6 : 2) : (isMetric ? 1 : 3.3); // m/s or ft/s
      const maxVelocity = isMetric ? 3 : 10; // m/s or ft/s
      
      if (velocity < minVelocity) {
        return `Warning: Velocity (${velocity.toFixed(2)} ${isMetric ? 'm/s' : 'ft/s'}) below minimum recommended (${minVelocity} ${isMetric ? 'm/s' : 'ft/s'}). Risk of sedimentation.`;
      } else if (velocity > maxVelocity) {
        return `Warning: Velocity (${velocity.toFixed(2)} ${isMetric ? 'm/s' : 'ft/s'}) above maximum recommended (${maxVelocity} ${isMetric ? 'm/s' : 'ft/s'}). Risk of pipe erosion.`;
      }
      return '';
    }
    
    // Calculate sanitary system
    function calculateSanitary() {
      // Validate inputs
      if (!validateInputs('sanitary')) return;
      
      const code = document.getElementById('codeStandard').value;
      const dfu = dfuTables[code];
      const units = document.getElementById('units').value;
      
      // Calculate DFU
      let wc = parseInt(document.getElementById('wc').value) * dfu.wc;
      let lav = parseInt(document.getElementById('lav').value) * dfu.lav;
      let sink = parseInt(document.getElementById('sink').value) * dfu.sink;
      let shower = parseInt(document.getElementById('shower').value) * dfu.shower;
      let tub = parseInt(document.getElementById('tub').value) * dfu.tub;
      let urinal = parseInt(document.getElementById('urinal').value) * dfu.urinal;
      let floorDrain = parseInt(document.getElementById('floorDrain').value) * dfu.floorDrain;
      
      let totalDFU = wc + lav + sink + shower + tub + urinal + floorDrain;
      
      // Calculate flow rate
      let flowRate;
      
      if (units === 'metric') {
        flowRate = (totalDFU / 2) * 0.06308; // L/s
      } else {
        flowRate = totalDFU / 7.5; // gpm (approximate conversion)
      }
      
      // Determine pipe size based on DFU and slope
      const slope = parseFloat(document.getElementById('sanSlope').value);
      const material = document.getElementById('sanPipeMaterial').value;
      const pipeData = pipeSizing.sanitary[material];
      
      let recommendedSize = "2";
      for (const size in pipeData) {
        if (pipeData[size] * (slope/2) >= totalDFU) {
          recommendedSize = size;
          break;
        }
      }
      
      // If no pipe can handle the load at this slope, use the largest available
      if (recommendedSize === "2" && totalDFU > pipeData["2"] * (slope/2)) {
        const sizes = Object.keys(pipeData);
        recommendedSize = sizes[sizes.length - 1];
      }
      
      // Check velocity
      const velocityWarning = checkVelocity(flowRate, recommendedSize, slope, units === 'metric', 'sanitary');
      
      // Calculate pipe quantity
      const runLength = parseFloat(document.getElementById('sanLength').value);
      const pipeLen = parseFloat(document.getElementById('sanPipeLength').value);
      const pipeQty = Math.ceil(runLength / pipeLen);
      
      // Calculate accessories with code-specific defaults
      const fixtureCount = parseInt(document.getElementById('wc').value) + 
                          parseInt(document.getElementById('lav').value) + 
                          parseInt(document.getElementById('sink').value) + 
                          parseInt(document.getElementById('shower').value) + 
                          parseInt(document.getElementById('tub').value) + 
                          parseInt(document.getElementById('urinal').value) + 
                          parseInt(document.getElementById('floorDrain').value);
      
      const traps = document.getElementById('traps').value || accessoryDefaults.traps[code](fixtureCount);
      const vents = document.getElementById('vents').value || accessoryDefaults.vents[code](fixtureCount);
      const cleanouts = document.getElementById('cleanouts').value || accessoryDefaults.cleanouts[code](runLength);
      const manholes = document.getElementById('sanManholes').value || Math.ceil(runLength/50);
      const fittings = document.getElementById('sanFittings').value || Math.ceil(runLength/10);
      
      // Display results
      const flowUnit = units === 'metric' ? 'L/s' : 'gpm';
      const lengthUnit = units === 'metric' ? 'm' : 'ft';
      const pipeSizeInch = recommendedSize;
      const pipeSizeMM = parseInt(recommendedSize) * 25.4;
      
      let outputHTML = `
        <h3>Sanitary System Calculation Results</h3>
        <strong>Hydraulic Calculations:</strong>
        Total DFU (${code.toUpperCase()}): ${totalDFU}
        Peak Flow: ${flowRate.toFixed(2)} ${flowUnit}
        Recommended Pipe Size: ${pipeSizeInch}" (${pipeSizeMM} mm) ${material.toUpperCase()}
        Pipe Slope: ${slope}%
      `;
      
      if (velocityWarning) {
        outputHTML += `<p class="warning">${velocityWarning}</p>`;
      }
      
      outputHTML += `
        <strong>Quantity Takeoff:</strong>
        Total Run Length: ${runLength} ${lengthUnit}
        Commercial Pipe Length: ${pipeLen} m
        Pipe Quantity: ${pipeQty} pcs
        
        <strong>Accessories:</strong>
        Traps: ${traps}
        Vents: ${vents}
        Cleanouts: ${cleanouts}
        Manholes: ${manholes}
        Fittings/Elbows: ${fittings}
      `;
      
      document.getElementById('sanitaryOutput').innerHTML = outputHTML;
      
      // Store results for summary
      window.sanitaryResults = {
        totalDFU,
        flowRate,
        flowUnit,
        pipeSize: pipeSizeInch,
        pipeMaterial: material,
        pipeQty,
        runLength,
        lengthUnit,
        traps,
        vents,
        cleanouts,
        manholes,
        fittings
      };
      
      updateSanitarySummary();
    }
    
    // Calculate storm system
    function calculateStorm() {
      // Validate inputs
      if (!validateInputs('storm')) return;
      
      // Get inputs
      const roofArea = parseFloat(document.getElementById('roofArea').value);
      const pavementArea = parseFloat(document.getElementById('pavementArea').value);
      const C = parseFloat(document.getElementById('coef').value);
      const I = parseFloat(document.getElementById('intensity').value);
      const runLength = parseFloat(document.getElementById('stormLength').value);
      const pipeLen = parseFloat(document.getElementById('stormPipeLength').value);
      const slope = parseFloat(document.getElementById('stormSlope').value);
      const material = document.getElementById('stormPipeMaterial').value;
      const units = document.getElementById('units').value;
      
      // Calculate total area and flow
      const totalArea = roofArea + pavementArea;
      
      let Q;
      
      if (units === 'metric') {
        Q = (C * I * totalArea) / 3600; // L/s
      } else {
        Q = (C * I * totalArea) / 96.23; // gpm (conversion factor)
      }
      
      // Determine pipe size
      const pipeData = pipeSizing.storm[material] || pipeSizing.storm.pvc;
      
      let recommendedSize = "4";
      for (const size in pipeData) {
        if (pipeData[size] * (slope/2) >= Q) {
          recommendedSize = size;
          break;
        }
      }
      
      // If no pipe can handle the load at this slope, use the largest available
      if (recommendedSize === "4" && Q > pipeData["4"] * (slope/2)) {
        const sizes = Object.keys(pipeData);
        recommendedSize = sizes[sizes.length - 1];
      }
      
      // Check velocity
      const velocityWarning = checkVelocity(Q, recommendedSize, slope, units === 'metric', 'storm');
      
      // Calculate pipe quantity
      const pipeQty = Math.ceil(runLength / pipeLen);
      
      // Calculate accessories with defaults if not provided
      const downspouts = document.getElementById('downspouts').value || Math.ceil(roofArea/100);
      const catchBasins = document.getElementById('catchBasins').value || Math.ceil(runLength/60);
      const manholes = document.getElementById('stormManholes').value || Math.ceil(runLength/50);
      const fittings = document.getElementById('stormFittings').value || Math.ceil(runLength/10);
      
      // Display results
      const flowUnit = units === 'metric' ? 'L/s' : 'gpm';
      const lengthUnit = units === 'metric' ? 'm' : 'ft';
      const areaUnit = units === 'metric' ? 'm²' : 'ft²';
      const pipeSizeInch = recommendedSize;
      const pipeSizeMM = parseInt(recommendedSize) * 25.4;
      
      let outputHTML = `
        <h3>Storm System Calculation Results</h3>
        <strong>Hydraulic Calculations:</strong>
        Total Drainage Area: ${totalArea.toFixed(1)} ${areaUnit}
        Runoff Coefficient (C): ${C}
        Rainfall Intensity: ${I} ${units === 'metric' ? 'mm/hr' : 'in/hr'}
        Peak Runoff: ${Q.toFixed(2)} ${flowUnit}
        Recommended Pipe Size: ${pipeSizeInch}" (${pipeSizeMM} mm) ${material.toUpperCase()}
        Pipe Slope: ${slope}%
      `;
      
      if (velocityWarning) {
        outputHTML += `<p class="warning">${velocityWarning}</p>`;
      }
      
      outputHTML += `
        <strong>Quantity Takeoff:</strong>
        Total Run Length: ${runLength} ${lengthUnit}
        Commercial Pipe Length: ${pipeLen} m
        Pipe Quantity: ${pipeQty} pcs
        
        <strong>Accessories:</strong>
        Downspouts: ${downspouts}
        Catch Basins: ${catchBasins}
        Manholes: ${manholes}
        Fittings/Elbows: ${fittings}
      `;
      
      document.getElementById('stormOutput').innerHTML = outputHTML;
      
      // Store results for summary
      window.stormResults = {
        totalArea,
        areaUnit,
        flowRate: Q,
        flowUnit,
        pipeSize: pipeSizeInch,
        pipeMaterial: material,
        pipeQty,
        runLength,
        lengthUnit,
        downspouts,
        catchBasins,
        manholes,
        fittings
      };
      
      updateStormSummary();
    }
    
    // Update sanitary summary
    function updateSanitarySummary() {
      if (!window.sanitaryResults) return;
      
      const r = window.sanitaryResults;
      document.getElementById('sanitarySummary').innerHTML = `
        <p><strong>Peak Flow:</strong> ${r.flowRate.toFixed(2)} ${r.flowUnit}</p>
        <p><strong>Pipe System:</strong> ${r.pipeQty} sections of ${r.pipeSize}" ${r.pipeMaterial} pipe (${r.runLength} ${r.lengthUnit} total)</p>
        <p><strong>Accessories:</strong> ${r.traps} traps, ${r.vents} vents, ${r.cleanouts} cleanouts, ${r.manholes} manholes, ${r.fittings} fittings</p>
      `;
    }
    
    // Update storm summary
    function updateStormSummary() {
      if (!window.stormResults) return;
      
      const r = window.stormResults;
      document.getElementById('stormSummary').innerHTML = `
        <p><strong>Peak Runoff:</strong> ${r.flowRate.toFixed(2)} ${r.flowUnit}</p>
        <p><strong>Drainage Area:</strong> ${r.totalArea.toFixed(1)} ${r.areaUnit}</p>
        <p><strong>Pipe System:</strong> ${r.pipeQty} sections of ${r.pipeSize}" ${r.pipeMaterial} pipe (${r.runLength} ${r.lengthUnit} total)</p>
        <p><strong>Accessories:</strong> ${r.downspouts} downspouts, ${r.catchBasins} catch basins, ${r.manholes} manholes, ${r.fittings} fittings</p>
      `;
    }
    
    // Validate costs and labor inputs
    function validateCosts() {
      let isValid = true;
      
      // Reset errors
      document.querySelectorAll('.validation-error').forEach(error => {
        error.style.display = 'none';
      });
      
      const costInputs = [
        'trapCost', 'ventCost', 'cleanoutCost', 'manholeCost', 'fittingCost', 'downspoutCost', 'catchBasinCost',
        'plumberRate', 'helperRate', 'dailyHours', 'wasteFactor', 'overhead', 'profitMargin',
        'customPipeLaying', 'customManhole', 'customCatchBasin', 'customFitting',
        'pipeCrewPlumbers', 'pipeCrewHelpers', 'fittingCrewPlumbers', 'fittingCrewHelpers'
      ];
      
      costInputs.forEach(id => {
        const input = document.getElementById(id);
        if (!input) return; // Skip if input doesn't exist (e.g., custom rates when not selected)
        
        const value = parseFloat(input.value);
        if (isNaN(value) || value < 0) {
          showValidationError(id, `${input.previousElementSibling?.textContent || 'This field'} must be 0 or greater`);
          isValid = false;
        }
        
        if (['wasteFactor', 'overhead', 'profitMargin'].includes(id) && value > 50) {
          showValidationError(id, `${input.previousElementSibling?.textContent || 'This field'} must be 50% or less`);
          isValid = false;
        }
        
        if (id === 'dailyHours' && (value < 1 || value > 12)) {
          showValidationError(id, 'Daily hours must be between 1 and 12');
          isValid = false;
        }
        
        if (id.includes('Crew') && value < 0) {
          showValidationError(id, 'Crew members cannot be negative');
          isValid = false;
        }
      });
      
      return isValid;
    }
    
    // Calculate costs with productivity-based labor
    function calculateCosts() {
      console.log("calculateCosts function called");
      
      // Validate cost inputs
      if (!validateCosts()) return;
      
      // Check if we have calculation results
      if (!window.sanitaryResults && !window.stormResults) {
        document.getElementById('costsOutput').innerHTML = `
          <h3>Cost Calculation Error</h3>
          <p>Please calculate at least one system (Sanitary or Storm) first before calculating costs.</p>
          <p>Go to the Sanitary System or Storm System tab and click the calculate button.</p>
        `;
        return;
      }
      
      const productivityStandard = document.getElementById('productivityStandard').value;
      const plumberRate = parseFloat(document.getElementById('plumberRate').value);
      const helperRate = parseFloat(document.getElementById('helperRate').value);
      const dailyHours = parseInt(document.getElementById('dailyHours').value);
      const wasteFactor = parseFloat(document.getElementById('wasteFactor').value) / 100;
      const overhead = parseFloat(document.getElementById('overhead').value) / 100;
      const profitMargin = parseFloat(document.getElementById('profitMargin').value) / 100;
      
      // Get crew composition
      const pipeCrewPlumbers = parseInt(document.getElementById('pipeCrewPlumbers').value);
      const pipeCrewHelpers = parseInt(document.getElementById('pipeCrewHelpers').value);
      const fittingCrewPlumbers = parseInt(document.getElementById('fittingCrewPlumbers').value);
      const fittingCrewHelpers = parseInt(document.getElementById('fittingCrewHelpers').value);
      
      const costTable = document.getElementById('costTable');
      
      // Clear existing rows (except header)
      while (costTable.rows.length > 1) {
        costTable.deleteRow(1);
      }
      
      let totalMaterialCost = 0;
      let totalLaborDays = 0;
      let totalLaborCost = 0;
      
      // Store BOQ items for export
      const costResults = { items: [] };
      
      // Get productivity rates
      let productivity = {};
      if (productivityStandard === 'custom') {
        productivity = {
          pvcPipe: parseFloat(document.getElementById('customPipeLaying').value),
          hdpPipe: parseFloat(document.getElementById('customPipeLaying').value),
          absPipe: parseFloat(document.getElementById('customPipeLaying').value),
          castIronPipe: parseFloat(document.getElementById('customPipeLaying').value) * 0.7,
          concretePipe: parseFloat(document.getElementById('customPipeLaying').value) * 0.5,
          corrugatedPipe: parseFloat(document.getElementById('customPipeLaying').value) * 0.8,
          manhole: parseFloat(document.getElementById('customManhole').value),
          catchBasin: parseFloat(document.getElementById('customCatchBasin').value),
          fitting: parseFloat(document.getElementById('customFitting').value),
          trap: parseFloat(document.getElementById('customFitting').value) * 1.2,
          vent: parseFloat(document.getElementById('customFitting').value) * 1.2,
          cleanout: parseFloat(document.getElementById('customFitting').value) * 0.8,
          downspout: parseFloat(document.getElementById('customFitting').value) * 0.4
        };
      } else {
        productivity = productivityRates[productivityStandard];
      }
      
      // Add section header for Materials
      addCostRow("Materials", "", "", "", "", true);
      
      // Add sanitary system costs if calculated
      if (window.sanitaryResults) {
        const r = window.sanitaryResults;
        const material = r.pipeMaterial;
        
        // Get material costs for pipes
        const sanitaryPipes = document.querySelectorAll('#sanitaryPipesContainer .pipe-cost-row');
        let totalSanitaryPipeCost = 0;
        
        sanitaryPipes.forEach(pipeRow => {
          const sizeSelect = pipeRow.querySelector('.size-select');
          const costInput = pipeRow.querySelector('.cost-input');
          const size = sizeSelect.value;
          const pipeCost = parseFloat(costInput.value);
          
          // Calculate pipe quantity based on the size
          // For simplicity, we'll assume all pipes are used proportionally
          // In a real application, you would need more sophisticated logic
          const pipeQty = Math.ceil(r.pipeQty / sanitaryPipes.length);
          const pipeMaterialCost = pipeCost * pipeQty;
          totalSanitaryPipeCost += pipeMaterialCost;
          
          const pipeProductivity = productivity[material.toLowerCase() + 'Pipe'] || productivity.pvcPipe;
          const pipeLaborDays = r.runLength / pipeProductivity / sanitaryPipes.length;
          const pipeLaborCost = pipeLaborDays * (plumberRate * pipeCrewPlumbers + helperRate * pipeCrewHelpers) * dailyHours;
          
          addCostRow(`${size}" ${material.toUpperCase()} Pipe`, pipeQty, "pcs", formatCurrency(pipeCost), formatCurrency(pipeMaterialCost));
          costResults.items.push({
            description: `${size}" ${material.toUpperCase()} Pipe`,
            quantity: pipeQty,
            unit: 'pcs',
            unitRate: pipeCost,
            amount: pipeMaterialCost
          });
          totalMaterialCost += pipeMaterialCost;
          totalLaborDays += pipeLaborDays;
          totalLaborCost += pipeLaborCost;
        });
        
        // Get accessory costs
        const fittingCost = parseFloat(document.getElementById('fittingCost').value);
        const trapCost = parseFloat(document.getElementById('trapCost').value);
        const ventCost = parseFloat(document.getElementById('ventCost').value);
        const cleanoutCost = parseFloat(document.getElementById('cleanoutCost').value);
        const manholeCost = parseFloat(document.getElementById('manholeCost').value);
        
        // Fittings cost
        const fittingMaterialCost = fittingCost * r.fittings;
        const fittingLaborDays = r.fittings / productivity.fitting;
        const fittingLaborCost = fittingLaborDays * (plumberRate * fittingCrewPlumbers + helperRate * fittingCrewHelpers) * dailyHours;
        
        addCostRow('Sanitary Fittings', r.fittings, "pcs", formatCurrency(fittingCost), formatCurrency(fittingMaterialCost));
        costResults.items.push({
          description: 'Sanitary Fittings',
          quantity: r.fittings,
          unit: 'pcs',
          unitRate: fittingCost,
          amount: fittingMaterialCost
        });
        totalMaterialCost += fittingMaterialCost;
        totalLaborDays += fittingLaborDays;
        totalLaborCost += fittingLaborCost;
        
        // Traps cost
        const trapMaterialCost = trapCost * r.traps;
        const trapLaborDays = r.traps / productivity.trap;
        const trapLaborCost = trapLaborDays * (plumberRate * fittingCrewPlumbers + helperRate * fittingCrewHelpers) * dailyHours;
        
        addCostRow('Traps', r.traps, "pcs", formatCurrency(trapCost), formatCurrency(trapMaterialCost));
        costResults.items.push({
          description: 'Traps',
          quantity: r.traps,
          unit: 'pcs',
          unitRate: trapCost,
          amount: trapMaterialCost
        });
        totalMaterialCost += trapMaterialCost;
        totalLaborDays += trapLaborDays;
        totalLaborCost += trapLaborCost;
        
        // Vents cost
        const ventMaterialCost = ventCost * r.vents;
        const ventLaborDays = r.vents / productivity.vent;
        const ventLaborCost = ventLaborDays * (plumberRate * fittingCrewPlumbers + helperRate * fittingCrewHelpers) * dailyHours;
        
        addCostRow('Vents', r.vents, "pcs", formatCurrency(ventCost), formatCurrency(ventMaterialCost));
        costResults.items.push({
          description: 'Vents',
          quantity: r.vents,
          unit: 'pcs',
          unitRate: ventCost,
          amount: ventMaterialCost
        });
        totalMaterialCost += ventMaterialCost;
        totalLaborDays += ventLaborDays;
        totalLaborCost += ventLaborCost;
        
        // Cleanouts cost
        const cleanoutMaterialCost = cleanoutCost * r.cleanouts;
        const cleanoutLaborDays = r.cleanouts / productivity.cleanout;
        const cleanoutLaborCost = cleanoutLaborDays * (plumberRate * fittingCrewPlumbers + helperRate * fittingCrewHelpers) * dailyHours;
        
        addCostRow('Cleanouts', r.cleanouts, "pcs", formatCurrency(cleanoutCost), formatCurrency(cleanoutMaterialCost));
        costResults.items.push({
          description: 'Cleanouts',
          quantity: r.cleanouts,
          unit: 'pcs',
          unitRate: cleanoutCost,
          amount: cleanoutMaterialCost
        });
        totalMaterialCost += cleanoutMaterialCost;
        totalLaborDays += cleanoutLaborDays;
        totalLaborCost += cleanoutLaborCost;
        
        // Manholes cost
        const manholeMaterialCost = manholeCost * r.manholes;
        const manholeLaborDays = r.manholes / productivity.manhole;
        const manholeLaborCost = manholeLaborDays * (plumberRate * pipeCrewPlumbers + helperRate * pipeCrewHelpers) * dailyHours;
        
        addCostRow('Manholes', r.manholes, "pcs", formatCurrency(manholeCost), formatCurrency(manholeMaterialCost));
        costResults.items.push({
          description: 'Manholes',
          quantity: r.manholes,
          unit: 'pcs',
          unitRate: manholeCost,
          amount: manholeMaterialCost
        });
        totalMaterialCost += manholeMaterialCost;
        totalLaborDays += manholeLaborDays;
        totalLaborCost += manholeLaborCost;
      }
      
      // Add storm system costs if calculated
      if (window.stormResults) {
        const r = window.stormResults;
        const material = r.pipeMaterial;
        
        // Get material costs for pipes
        const stormPipes = document.querySelectorAll('#stormPipesContainer .pipe-cost-row');
        let totalStormPipeCost = 0;
        
        stormPipes.forEach(pipeRow => {
          const sizeSelect = pipeRow.querySelector('.size-select');
          const costInput = pipeRow.querySelector('.cost-input');
          const size = sizeSelect.value;
          const pipeCost = parseFloat(costInput.value);
          
          // Calculate pipe quantity based on the size
          // For simplicity, we'll assume all pipes are used proportionally
          const pipeQty = Math.ceil(r.pipeQty / stormPipes.length);
          const pipeMaterialCost = pipeCost * pipeQty;
          totalStormPipeCost += pipeMaterialCost;
          
          const pipeProductivity = productivity[material.toLowerCase() + 'Pipe'] || productivity.pvcPipe;
          const pipeLaborDays = r.runLength / pipeProductivity / stormPipes.length;
          const pipeLaborCost = pipeLaborDays * (plumberRate * pipeCrewPlumbers + helperRate * pipeCrewHelpers) * dailyHours;
          
          addCostRow(`${size}" ${material.toUpperCase()} Storm Pipe`, pipeQty, "pcs", formatCurrency(pipeCost), formatCurrency(pipeMaterialCost));
          costResults.items.push({
            description: `${size}" ${material.toUpperCase()} Storm Pipe`,
            quantity: pipeQty,
            unit: 'pcs',
            unitRate: pipeCost,
            amount: pipeMaterialCost
          });
          totalMaterialCost += pipeMaterialCost;
          totalLaborDays += pipeLaborDays;
          totalLaborCost += pipeLaborCost;
        });
        
        // Get accessory costs
        const fittingCost = parseFloat(document.getElementById('fittingCost').value);
        const downspoutCost = parseFloat(document.getElementById('downspoutCost').value);
        const catchBasinCost = parseFloat(document.getElementById('catchBasinCost').value);
        const manholeCost = parseFloat(document.getElementById('manholeCost').value);
        
        // Fittings cost
        const fittingMaterialCost = fittingCost * r.fittings;
        const fittingLaborDays = r.fittings / productivity.fitting;
        const fittingLaborCost = fittingLaborDays * (plumberRate * fittingCrewPlumbers + helperRate * fittingCrewHelpers) * dailyHours;
        
        addCostRow('Storm Fittings', r.fittings, "pcs", formatCurrency(fittingCost), formatCurrency(fittingMaterialCost));
        costResults.items.push({
          description: 'Storm Fittings',
          quantity: r.fittings,
          unit: 'pcs',
          unitRate: fittingCost,
          amount: fittingMaterialCost
        });
        totalMaterialCost += fittingMaterialCost;
        totalLaborDays += fittingLaborDays;
        totalLaborCost += fittingLaborCost;
        
        // Downspouts cost
        const downspoutMaterialCost = downspoutCost * r.downspouts;
        const downspoutLaborDays = r.downspouts / productivity.downspout;
        const downspoutLaborCost = downspoutLaborDays * (plumberRate * fittingCrewPlumbers + helperRate * fittingCrewHelpers) * dailyHours;
        
        addCostRow('Downspouts', r.downspouts, "pcs", formatCurrency(downspoutCost), formatCurrency(downspoutMaterialCost));
        costResults.items.push({
          description: 'Downspouts',
          quantity: r.downspouts,
          unit: 'pcs',
          unitRate: downspoutCost,
          amount: downspoutMaterialCost
        });
        totalMaterialCost += downspoutMaterialCost;
        totalLaborDays += downspoutLaborDays;
        totalLaborCost += downspoutLaborCost;
        
        // Catch basins cost
        const catchBasinMaterialCost = catchBasinCost * r.catchBasins;
        const catchBasinLaborDays = r.catchBasins / productivity.catchBasin;
        const catchBasinLaborCost = catchBasinLaborDays * (plumberRate * pipeCrewPlumbers + helperRate * pipeCrewHelpers) * dailyHours;
        
        addCostRow('Catch Basins', r.catchBasins, "pcs", formatCurrency(catchBasinCost), formatCurrency(catchBasinMaterialCost));
        costResults.items.push({
          description: 'Catch Basins',
          quantity: r.catchBasins,
          unit: 'pcs',
          unitRate: catchBasinCost,
          amount: catchBasinMaterialCost
        });
        totalMaterialCost += catchBasinMaterialCost;
        totalLaborDays += catchBasinLaborDays;
        totalLaborCost += catchBasinLaborCost;
        
        // Manholes cost
        const manholeMaterialCost = manholeCost * r.manholes;
        const manholeLaborDays = r.manholes / productivity.manhole;
        const manholeLaborCost = manholeLaborDays * (plumberRate * pipeCrewPlumbers + helperRate * pipeCrewHelpers) * dailyHours;
        
        addCostRow('Storm Manholes', r.manholes, "pcs", formatCurrency(manholeCost), formatCurrency(manholeMaterialCost));
        costResults.items.push({
          description: 'Storm Manholes',
          quantity: r.manholes,
          unit: 'pcs',
          unitRate: manholeCost,
          amount: manholeMaterialCost
        });
        totalMaterialCost += manholeMaterialCost;
        totalLaborDays += manholeLaborDays;
        totalLaborCost += manholeLaborCost;
      }
      
      // Add Materials Subtotal
      addCostRow("Materials Subtotal", "", "", "", formatCurrency(totalMaterialCost));
      
      // Apply waste factor to materials
      const wasteAmount = totalMaterialCost * wasteFactor;
      const materialWithWaste = totalMaterialCost + wasteAmount;
      
      addCostRow(`Waste (${(wasteFactor*100).toFixed(0)}%)`, "", "", "", formatCurrency(wasteAmount));
      addCostRow("Materials Total", "", "", "", formatCurrency(materialWithWaste));
      
      // Add section header for Labor
      addCostRow("Labor", "", "", "", "", true);
      
      // Calculate labor costs based on productivity
      const plumberLaborDays = totalLaborDays;
      const helperLaborDays = totalLaborDays;
      
      const plumberLaborCost = plumberLaborDays * plumberRate * dailyHours;
      const helperLaborCost = helperLaborDays * helperRate * dailyHours;
      
      addCostRow("Plumber", plumberLaborDays.toFixed(1), "days", formatCurrency(plumberRate * dailyHours), formatCurrency(plumberLaborCost));
      addCostRow("Helper", helperLaborDays.toFixed(1), "days", formatCurrency(helperRate * dailyHours), formatCurrency(helperLaborCost));
      
      totalLaborCost = plumberLaborCost + helperLaborCost;
      
      addCostRow("Labor Total", "", "", "", formatCurrency(totalLaborCost));
      
      // Calculate overhead and profit
      const subtotal = materialWithWaste + totalLaborCost;
      const overheadAmount = subtotal * overhead;
      const profitAmount = (subtotal + overheadAmount) * profitMargin;
      
      const totalProjectCost = subtotal + overheadAmount + profitAmount;
      
      // Add section header for Summary
      addCostRow("Summary", "", "", "", "", true);
      
      // Add summary rows
      addCostRow("Materials + Labor", "", "", "", formatCurrency(subtotal));
      addCostRow(`Overhead (${(overhead*100).toFixed(0)}%)`, "", "", "", formatCurrency(overheadAmount));
      addCostRow(`Profit Margin (${(profitMargin*100).toFixed(0)}%)`, "", "", "", formatCurrency(profitAmount));
      
      // Add total row
      addCostRow("TOTAL PROJECT COST", "", "", "", formatCurrency(totalProjectCost), false, true);
      
      // Update cost summary
      document.getElementById('costSummary').innerHTML = `
        <p><strong>Total Material Cost:</strong> ${formatCurrency(totalMaterialCost)}</p>
        <p><strong>Total Labor Cost:</strong> ${formatCurrency(totalLaborCost)}</p>
        <p><strong>Total Project Cost:</strong> ${formatCurrency(totalProjectCost)}</p>
        <p><strong>Estimated Work Duration:</strong> ${totalLaborDays.toFixed(1)} days (${(totalLaborDays/5).toFixed(1)} weeks)</p>
        <p><strong>Productivity Standard:</strong> ${productivityStandard === 'philippines' ? 'Manual/Low-tech' : productivityStandard === 'international' ? 'Mechanized/High-tech' : 'Custom'}</p>
      `;
      
      // Show success message
      document.getElementById('costsOutput').innerHTML = `
        <h3>Cost Calculation Complete</h3>
        <p>Total project cost calculated: ${formatCurrency(totalProjectCost)}</p>
        <p>Check the Summary tab for detailed breakdown.</p>
      `;
      
      // Store cost results for PDF
      window.costResults = {
        items: costResults.items,
        totalMaterialCost,
        totalLaborCost,
        totalProjectCost,
        wasteAmount,
        overheadAmount,
        profitAmount,
        totalLaborDays,
        productivityStandard,
        plumberLaborDays,
        helperLaborDays,
        plumberLaborCost,
        helperLaborCost,
        subtotal
      };
    }
    
    // Helper function to add a row to the cost table
    function addCostRow(description, quantity, unit, unitRate, amount, isSectionHeader = false, isTotal = false) {
      const costTable = document.getElementById('costTable');
      const row = costTable.insertRow();
      
      if (isSectionHeader) {
        row.innerHTML = `
          <td colspan="5" style="background-color: #e9ecef; font-weight: bold;">${description}</td>
        `;
      } else if (isTotal) {
        row.innerHTML = `
          <td style="font-weight: bold;">${description}</td>
          <td></td>
          <td></td>
          <td></td>
          <td style="font-weight: bold;">${amount}</td>
        `;
      } else {
        row.innerHTML = `
          <td>${description}</td>
          <td>${quantity}</td>
          <td>${unit}</td>
          <td>${unitRate}</td>
          <td>${amount}</td>
        `;
      }
    }
    
    // Format currency based on selection
    function formatCurrency(amount) {
      if (isNaN(amount)) return '';
      const currency = document.getElementById('currency').value;
      const formatter = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: currency,
        minimumFractionDigits: 2
      });
      return formatter.format(amount);
    }
    
    // Input validation
    function validateInputs(system) {
      let isValid = true;
      
      // Reset errors
      document.querySelectorAll('.validation-error').forEach(error => {
        error.style.display = 'none';
      });
      
      // Project name validation
      const projectName = document.getElementById('projectName').value;
      if (!projectName.trim()) {
        document.getElementById('projectNameError').style.display = 'block';
        isValid = false;
      }
      
      // System-specific validation
      if (system === 'sanitary') {
        const runLength = parseFloat(document.getElementById('sanLength').value);
        if (isNaN(runLength) || runLength <= 0) {
          showValidationError('sanLength', 'Length must be greater than 0');
          isValid = false;
        }
      }
      
      if (system === 'storm') {
        const roofArea = parseFloat(document.getElementById('roofArea').value);
        if (isNaN(roofArea) || roofArea < 0) {
          showValidationError('roofArea', 'Area must be 0 or greater');
          isValid = false;
        }
        
        const intensity = parseFloat(document.getElementById('intensity').value);
        if (isNaN(intensity) || intensity <= 0) {
          showValidationError('intensity', 'Intensity must be greater than 0');
          isValid = false;
        }
      }
      
      return isValid;
    }
    
    function showValidationError(fieldId, message) {
      // Create error element if it doesn't exist
      let errorElement = document.getElementById(fieldId + 'Error');
      if (!errorElement) {
        errorElement = document.createElement('div');
        errorElement.className = 'validation-error';
        errorElement.id = fieldId + 'Error';
        document.getElementById(fieldId).parentNode.appendChild(errorElement);
      }
      
      errorElement.textContent = message;
      errorElement.style.display = 'block';
    }
    
    // Save project data
    function saveProject() {
      const projectData = {
        reportTitle: "Sanitary & Storm Drain Calculator Report",
        projectName: document.getElementById('projectName').value,
        clientName: document.getElementById('clientName').value,
        projectLocation: document.getElementById('projectLocation').value,
        preparedBy: document.getElementById('preparedBy').value,
        currency: document.getElementById('currency').value,
        codeStandard: document.getElementById('codeStandard').value,
        units: document.getElementById('units').value,
        sanitaryResults: window.sanitaryResults,
        stormResults: window.stormResults,
        costResults: window.costResults
      };
      
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectData));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", document.getElementById('projectName').value + "_QTO.json");
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
    }
    
    // Load project data
    function loadProject() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
          const projectData = JSON.parse(event.target.result);
          
          // Populate form fields
          document.getElementById('projectName').value = projectData.projectName || '';
          document.getElementById('clientName').value = projectData.clientName || '';
          document.getElementById('projectLocation').value = projectData.projectLocation || '';
          document.getElementById('preparedBy').value = projectData.preparedBy || '';
          document.getElementById('currency').value = projectData.currency || 'PHP';
          document.getElementById('codeStandard').value = projectData.codeStandard || 'rnpcp';
          document.getElementById('units').value = projectData.units || 'metric';
          updateUnits();
          
          // Restore calculation results
          window.sanitaryResults = projectData.sanitaryResults;
          window.stormResults = projectData.stormResults;
          window.costResults = projectData.costResults;
          
          // Update summaries
          updateSanitarySummary();
          updateStormSummary();
          
          alert('Project loaded successfully!');
        };
        reader.readAsText(file);
      };
      input.click();
    }
    
    // Extract BOQ data from stored results
    function extractBOQDataFromDisplay() {
      if (!window.costResults) {
        alert('No calculations performed. Using sample data for export.');
        return getFallbackData();
      }
      
      const r = window.costResults;
      const wasteFactor = parseFloat(document.getElementById('wasteFactor').value) / 100;
      const overhead = parseFloat(document.getElementById('overhead').value) / 100;
      const profitMargin = parseFloat(document.getElementById('profitMargin').value) / 100;
      const plumberRate = parseFloat(document.getElementById('plumberRate').value);
      const helperRate = parseFloat(document.getElementById('helperRate').value);
      const dailyHours = parseInt(document.getElementById('dailyHours').value);
      
      return [
        ['Description', 'Quantity', 'Unit', 'Unit Rate', 'Amount'],
        ...r.items.map(item => [
          item.description,
          item.quantity.toString(),
          item.unit,
          formatCurrency(item.unitRate),
          formatCurrency(item.amount)
        ]),
        ['Materials Subtotal', '', '', '', formatCurrency(r.totalMaterialCost)],
        [`Waste (${(wasteFactor*100).toFixed(0)}%)`, '', '', '', formatCurrency(r.wasteAmount)],
        ['Materials Total', '', '', '', formatCurrency(r.totalMaterialCost + r.wasteAmount)],
        ['Labor', '', '', '', ''],
        ['Plumber', r.plumberLaborDays.toFixed(1), 'days', formatCurrency(plumberRate * dailyHours), formatCurrency(r.plumberLaborCost)],
        ['Helper', r.helperLaborDays.toFixed(1), 'days', formatCurrency(helperRate * dailyHours), formatCurrency(r.helperLaborCost)],
        ['Labor Total', '', '', '', formatCurrency(r.totalLaborCost)],
        ['Summary', '', '', '', ''],
        ['Materials + Labor', '', '', '', formatCurrency(r.subtotal)],
        [`Overhead (${(overhead*100).toFixed(0)}%)`, '', '', '', formatCurrency(r.overheadAmount)],
        [`Profit Margin (${(profitMargin*100).toFixed(0)}%)`, '', '', '', formatCurrency(r.profitAmount)],
        ['TOTAL PROJECT COST', '', '', '', formatCurrency(r.totalProjectCost)]
      ];
    }

    // Export to PDF - FIXED VERSION
    function exportToPDF() {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Get project information
            const projectName = document.getElementById("projectName")?.value || "Sanitary & Storm Project";
            const clientName = document.getElementById("clientName")?.value || "Client Name";
            const projectLocation = document.getElementById("projectLocation")?.value || "Project Location";
            const preparedBy = document.getElementById("preparedBy")?.value || "Prepared By";
            const date = new Date().toLocaleDateString();

            // Get the actual calculated values from the stored BOQ data
            const boqTable = extractBOQDataFromDisplay();
            
            // Remove the header row from the table data since we'll add it manually in autoTable
            const tableBody = boqTable.filter(row => 
                !(row[0] === 'Description' && row[1] === 'Quantity' && row[2] === 'Unit' && row[3] === 'Unit Rate' && row[4] === 'Amount')
            );

            // Set margins and initial position
            const margin = 15;
            let y = margin;

            // Add header information
            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.text("Sanitary & Storm Drain Report", margin, y);
            y += 10;

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Project: ${projectName}`, margin, y);
            doc.text(`Client: ${clientName}`, 100, y);
            y += 5;
            doc.text(`Location: ${projectLocation}`, margin, y);
            doc.text(`Date: ${date}`, 100, y);
            y += 5;
            doc.text(`Prepared by: ${preparedBy}`, margin, y);
            y += 15;

            // Add Bill of Quantities title
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("Bill of Quantities", margin, y);
            y += 8;

            // Configure and draw the table - ONLY use body data, header is defined separately
            doc.autoTable({
                head: [["Description", "Quantity", "Unit", "Unit Rate", "Amount"]],
                body: tableBody,
                startY: y,
                theme: "grid",
                styles: {
                    fontSize: 9,
                    cellPadding: 4,
                    valign: "middle",
                    lineColor: [0, 0, 0],
                    lineWidth: 0.1,
                    textColor: [0, 0, 0]
                },
                columnStyles: {
                    0: { halign: "left", cellWidth: 75 },
                    1: { halign: "center", cellWidth: 25 },
                    2: { halign: "center", cellWidth: 20 },
                    3: { halign: "right", cellWidth: 30 },
                    4: { halign: "right", cellWidth: 35 }
                },
                headStyles: {
                    fillColor: [220, 220, 220],
                    textColor: 0,
                    fontStyle: "bold",
                    lineWidth: 0.1,
                    fontSize: 9
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                },
                didParseCell: function(data) {
                    const cellValue = data.cell.raw ? data.cell.raw.toString() : '';
                    
                    // Remove ± symbols from amounts - FIXED VERSION
                    if ((data.column.index === 3 || data.column.index === 4) && data.cell.text) {
                        // Ensure data.cell.text is a string before calling replace
                        if (typeof data.cell.text === 'string') {
                            data.cell.text = data.cell.text.replace(/±/g, '');
                        } else if (typeof data.cell.text === 'number') {
                            data.cell.text = data.cell.text.toString();
                        }
                    }
                    
                    // Style section headers
                    if (cellValue === "Materials" || cellValue === "Labor" || cellValue === "Summary") {
                        data.cell.styles.fillColor = [224, 224, 224];
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.halign = 'left';
                        data.cell.colSpan = 5;
                    }
                    
                    // Style totals and subtotals
                    if (cellValue.includes("Subtotal") || cellValue.includes("Total") || cellValue.includes("TOTAL") || 
                        cellValue.includes("Overhead") || cellValue.includes("Profit Margin") || 
                        cellValue.includes("Materials + Labor") || cellValue.includes("Waste")) {
                        data.cell.styles.fontStyle = 'bold';
                    }
                    
                    // Style the grand total row
                    if (cellValue.includes("TOTAL PROJECT COST")) {
                        data.cell.styles.fillColor = [200, 200, 200];
                        data.cell.styles.fontStyle = 'bold';
                    }
                },
                didDrawPage: function(data) {
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    doc.text(`Page ${data.pageNumber}`, 
                        doc.internal.pageSize.width - 15, 
                        doc.internal.pageSize.height - 10);
                },
                margin: { top: y, left: margin, right: margin }
            });

            // Save the PDF
            doc.save("Sanitary_Storm_Report.pdf");
        } catch (error) {
            alert("Error generating PDF: " + error.message);
            console.error(error);
        }
    }

    // Fallback data with CORRECTED spelling and structure
    function getFallbackData() {
        return [
            ["Materials", "", "", "", ""],
            ["2\" PVC Pipe", "9", "pcs", "25.00", "225.00"],
            ["Sanitary Fittings", "5", "pcs", "8.00", "40.00"],
            ["Traps", "7", "pcs", "15.00", "105.00"],
            ["Vents", "7", "pcs", "8.00", "56.00"],
            ["Cleanouts", "3", "pcs", "25.00", "75.00"],
            ["Manholes", "1", "pcs", "500.00", "500.00"],
            ["4\" PVC Storm Pipe", "10", "pcs", "15.00", "150.00"],
            ["Storm Fittings", "6", "pcs", "8.00", "48.00"],
            ["Downspouts", "2", "pcs", "45.00", "90.00"],
            ["Catch Basins", "1", "pcs", "150.00", "150.00"],
            ["Storm Manholes", "1", "pcs", "500.00", "500.00"],
            ["Materials Subtotal", "", "", "", "1949.00"],
            ["Waste (5%)", "", "", "", "97.45"],
            ["Materials Total", "", "", "", "2046.45"],
            ["Labor", "", "", "", ""],
            ["Plumber", "5.0", "days", "640.00", "3200.00"],
            ["Helper", "5.0", "days", "400.00", "2000.00"],
            ["Labor Total", "", "", "", "5200.00"],
            ["Summary", "", "", "", ""],
            ["Materials + Labor", "", "", "", "7246.45"],
            ["Overhead (15%)", "", "", "", "1086.97"],
            ["Profit Margin (10%)", "", "", "", "833.34"],
            ["TOTAL PROJECT COST", "", "", "", "9166.76"]
        ];
    }
    
    // Export to Excel
    function exportToExcel() {
      try {
        const wb = XLSX.utils.book_new();
        
        // Project info sheet
        const projectData = [
          ['Project Information', ''],
          ['Project Name', document.getElementById('projectName').value],
          ['Client Name', document.getElementById('clientName').value],
          ['Location', document.getElementById('projectLocation').value],
          ['Prepared By', document.getElementById('preparedBy').value],
          ['Currency', document.getElementById('currency').value],
          ['Code Standard', document.getElementById('codeStandard').value],
          ['Units', document.getElementById('units').value],
          ['', ''],
          ['Generated on', new Date().toLocaleString()]
        ];
        
        const projectWs = XLSX.utils.aoa_to_sheet(projectData);
        XLSX.utils.book_append_sheet(wb, projectWs, "Project Info");
        
        // Sanitary sheet
        if (window.sanitaryResults) {
          const r = window.sanitaryResults;
          const sanitaryData = [
            ['SANITARY SYSTEM QUANTITIES', ''],
            ['Hydraulic Calculations', ''],
            ['Total DFU', r.totalDFU],
            ['Peak Flow', `${r.flowRate.toFixed(2)} ${r.flowUnit}`],
            ['Recommended Pipe Size', `${r.pipeSize}" ${r.pipeMaterial}`],
            ['', ''],
            ['Quantity Takeoff', ''],
            ['Pipe Length', `${r.runLength} ${r.lengthUnit}`],
            ['Pipe Sections', r.pipeQty],
            ['Traps', r.traps],
            ['Vents', r.vents],
            ['Cleanouts', r.cleanouts],
            ['Manholes', r.manholes],
            ['Fittings/Elbows', r.fittings]
          ];
          
          const sanitaryWs = XLSX.utils.aoa_to_sheet(sanitaryData);
          XLSX.utils.book_append_sheet(wb, sanitaryWs, "Sanitary System");
        }
        
        // Storm sheet
        if (window.stormResults) {
          const r = window.stormResults;
          const stormData = [
            ['STORM SYSTEM QUANTITIES', ''],
            ['Hydraulic Calculations', ''],
            ['Total Drainage Area', `${r.totalArea.toFixed(1)} ${r.areaUnit}`],
            ['Peak Runoff', `${r.flowRate.toFixed(2)} ${r.flowUnit}`],
            ['Recommended Pipe Size', `${r.pipeSize}" ${r.pipeMaterial}`],
            ['', ''],
            ['Quantity Takeoff', ''],
            ['Pipe Length', `${r.runLength} ${r.lengthUnit}`],
            ['Pipe Sections', r.pipeQty],
            ['Downspouts', r.downspouts],
            ['Catch Basins', r.catchBasins],
            ['Manholes', r.manholes],
            ['Fittings/Elbows', r.fittings]
          ];
          
          const stormWs = XLSX.utils.aoa_to_sheet(stormData);
          XLSX.utils.book_append_sheet(wb, stormWs, "Storm System");
        }
        
        // Save the Excel file
        XLSX.writeFile(wb, `${document.getElementById('projectName').value}_Report.xlsx`);
      } catch (error) {
        alert('Error generating Excel: ' + error.message);
        console.error(error);
      }
    }
  </script>
</body>
</html>
