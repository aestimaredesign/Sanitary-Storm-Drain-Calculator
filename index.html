<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sanitary & Storm Drain Calculator</title>

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #64748b;
      --light: #f8fafc;
      --dark: #0f172a;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #cbd5e1;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f1f5f9;
      color: var(--dark);
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    h1 {
      font-size: 2.2em;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .subtitle {
      font-size: 1.1em;
      opacity: 0.9;
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    @media (max-width: 900px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }
    
    .section {
      margin-bottom: 25px;
      padding: 20px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .section h2 {
      font-size: 1.5em;
      margin-bottom: 20px;
      color: var(--primary);
      border-bottom: 2px solid var(--border);
      padding-bottom: 10px;
    }
    
    .form-row {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      gap: 15px;
    }
    
    .form-row label {
      flex: 0 0 180px;
      font-weight: 500;
      margin: 0;
      text-align: right;
    }
    
    .form-row .input-group {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .form-row input, .form-row select {
      flex: 1;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid var(--border);
      background-color: white;
      color: var(--dark);
      font-size: 1em;
      min-width: 0;
    }
    
    .form-row input:focus, .form-row select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .form-row .unit {
      flex: 0 0 40px;
      font-weight: 500;
    }
    
    .checkbox-row {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .checkbox-row input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
    }
    
    button {
      padding: 12px 20px;
      border-radius: 5px;
      border: none;
      background-color: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 1em;
    }
    
    button:hover {
      background-color: var(--primary-dark);
    }
    
    button.secondary {
      background-color: var(--secondary);
    }
    
    button.secondary:hover {
      background-color: #475569;
    }
    
    .output {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8fafc;
      border-radius: 8px;
      white-space: pre-line;
      color: var(--dark);
      border-left: 4px solid var(--primary);
    }
    
    .output h3 {
      margin-top: 0;
      color: var(--primary);
    }
    
    .export-section {
      grid-column: 1 / -1;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .validation-error {
      color: var(--danger);
      font-size: 0.9em;
      margin-top: 5px;
      display: none;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      white-space: nowrap;
    }
    
    .tab.active {
      border-bottom: 3px solid var(--primary);
      font-weight: 600;
      color: var(--primary);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .summary-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }
    
    .summary-card h3 {
      margin-top: 0;
      color: var(--primary);
    }
    
    .cost-breakdown {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .cost-breakdown th, .cost-breakdown td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    .cost-breakdown th {
      background-color: #f1f5f9;
      font-weight: 600;
    }
    
    .cost-breakdown tr:last-child td {
      border-bottom: none;
      font-weight: 600;
      background-color: #f1f5f9;
    }
    
    .grey-header {
      background-color: #e0e0e0 !important;
      font-weight: bold !important;
    }
    
    .project-info {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    
    .disclaimer {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-size: 14px;
      color: #000000;
    }
    
    .material-costs {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
    }
    
    .labor-inputs {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
    }
    
    .productivity-info {
      background: #e8f4fd;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
      border-left: 4px solid var(--primary);
    }
    
    .productivity-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9em;
    }
    
    .productivity-table th, .productivity-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    .productivity-table th {
      background-color: #f1f5f9;
    }
    
    .pipe-size-group {
      display: none;
      margin-left: 20px;
      border-left: 2px solid #ddd;
      padding-left: 15px;
    }
    
    .pipe-size-group.active {
      display: block;
    }
    
    .material-type {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .material-type h4 {
      margin: 0 0 10px 0;
      color: var(--primary);
    }
    
    .section-header {
      background-color: #e9ecef;
      padding: 8px 15px;
      margin: 15px 0 10px 0;
      border-radius: 4px;
      font-weight: bold;
    }
    
    .formula-section {
      background: #f0f9ff;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid var(--primary);
    }
    
    .formula {
      font-family: monospace;
      background: #f8fafc;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      border-left: 3px solid var(--primary);
    }
    
    .help-step {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .help-step h4 {
      margin: 0 0 8px 0;
      color: var(--primary);
    }
    
    .reference-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 0.9em;
    }
    
    .reference-table th, .reference-table td {
      padding: 8px;
      text-align: left;
      border: 1px solid #ddd;
    }
    
    .reference-table th {
      background-color: #f1f5f9;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    h3 {
      margin-top: 25px;
      margin-bottom: 15px;
      color: var(--primary);
      font-size: 1.3em;
    }
    
    /* Fix for specific alignment issues */
    .material-costs .form-row {
      align-items: flex-start;
    }
    
    .material-costs .form-row label {
      padding-top: 10px;
    }

    .pipe-size-inputs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    
    .pipe-size-input {
      display: flex;
      flex-direction: column;
    }
    
    .pipe-size-input label {
      font-size: 0.9em;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .warning {
      color: var(--warning);
      font-weight: 500;
    }
    
    .error {
      color: var(--danger);
      font-weight: 500;
    }
    
    .system-costs {
      background: #f0f9ff;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    
    .system-costs h4 {
      margin-top: 0;
      color: var(--primary);
    }
    
    .pipe-cost-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    
    .pipe-cost-row select, .pipe-cost-row input {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }
    
    .pipe-cost-row .size-select {
      width: 80px;
    }
    
    .pipe-cost-row .cost-input {
      width: 120px;
    }
    
    .add-pipe-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    
    .remove-pipe-btn {
      background: var(--danger);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Sanitary & Storm Drain Calculator</h1>
      <div class="subtitle">Professional quantity takeoff for plumbing contractors and estimators</div>
      <div class="disclaimer">
        <strong>Note:</strong> This calculator uses practical approximations based on plumbing codes. 
        For formal design, consult the actual code provisions and a licensed engineer.
      </div>
    </header>
    
    <div class="tabs">
      <div class="tab active" onclick="switchTab('project')">Project Info</div>
      <div class="tab" onclick="switchTab('sanitary')">Sanitary System</div>
      <div class="tab" onclick="switchTab('storm')">Storm System</div>
      <div class="tab" onclick="switchTab('costs')">Costs & Labor</div>
      <div class="tab" onclick="switchTab('summary')">Summary & Export</div>
      <div class="tab" onclick="switchTab('help')">Help & Formulas</div>
    </div>
    
    <!-- Project Information Section -->
    <div id="project-tab" class="tab-content active">
      <div class="section">
        <h2>Project Information</h2>
        <div class="project-info">
          <div class="form-row">
            <label for="projectName">Project Name:</label>
            <div class="input-group">
              <input type="text" id="projectName" placeholder="Enter Project Name" value="Residential Plumbing Project">
            </div>
            <div class="validation-error" id="projectNameError">Project name is required</div>
          </div>
          <div class="form-row">
            <label for="clientName">Client Name:</label>
            <div class="input-group">
              <input type="text" id="clientName" placeholder="Enter Client Name" value="John Dela Cruz">
            </div>
          </div>
          <div class="form-row">
            <label for="projectLocation">Project Location:</label>
            <div class="input-group">
              <input type="text" id="projectLocation" placeholder="Enter Project Location" value="Manila, Philippines">
            </div>
          </div>
          <div class="form-row">
            <label for="preparedBy">Prepared By:</label>
            <div class="input-group">
              <input type="text" id="preparedBy" placeholder="Enter Prepared By" value="Maria Santos, Civil Engineer">
            </div>
          </div>
          <div class="button-group">
            <button onclick="saveProject()">Save Project</button>
            <button class="secondary" onclick="loadProject()">Load Project</button>
            <button class="secondary" onclick="resetCalculator()" style="background-color: var(--danger);">Reset Calculator</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sanitary System Section -->
    <div id="sanitary-tab" class="tab-content">
      <div class="section">
        <h2>Sanitary System</h2>
        <!-- Add form inputs for sanitary system calculations -->
        <div class="form-row">
          <label for="wc">Water Closets:</label>
          <div class="input-group">
            <input type="number" id="wc" value="2">
          </div>
          <div class="unit">units</div>
        </div>
        <div class="form-row">
          <label for="lav">Lavatories:</label>
          <div class="input-group">
            <input type="number" id="lav" value="2">
          </div>
          <div class="unit">units</div>
        </div>
        <div class="form-row">
          <label for="sink">Sinks:</label>
          <div class="input-group">
            <input type="number" id="sink" value="1">
          </div>
          <div class="unit">units</div>
        </div>
        <div class="form-row">
          <label for="shower">Showers:</label>
          <div class="input-group">
            <input type="number" id="shower" value="1">
          </div>
          <div class="unit">units</div>
        </div>
        <div class="form-row">
          <label for="tub">Tubs:</label>
          <div class="input-group">
            <input type="number" id="tub" value="1">
          </div>
          <div class="unit">units</div>
        </div>
        <div class="form-row">
          <label for="urinal">Urinals:</label>
          <div class="input-group">
            <input type="number" id="urinal" value="0">
          </div>
          <div class="unit">units</div>
        </div>
        <div class="form-row">
          <label for="floorDrain">Floor Drains:</label>
          <div class="input-group">
            <input type="number" id="floorDrain" value="2">
          </div>
          <div class="unit">units</div>
        </div>
        <div class="form-row">
          <label for="sanLength">Total Pipe Length:</label>
          <div class="input-group">
            <input type="number" id="sanLength" value="50">
          </div>
          <div class="unit">ft</div>
        </div>
        <div class="form-row">
          <label for="traps">Traps:</label>
          <div class="input-group">
            <input type="number" id="traps" value="">
          </div>
          <div class="unit">units</div>
        </div>
        <div class="form-row">
          <label for="vents">Vents:</label>
          <div class="input-group">
            <input type="number" id="vents" value="">
          </div>
          <div class="unit">units</div>
        </div>
        <div class="form-row">
          <label for="cleanouts">Cleanouts:</label>
          <div class="input-group">
            <input type="number" id="cleanouts" value="">
          </div>
          <div class="unit">units</div>
        </div>
        <div class="form-row">
          <label for="sanManholes">Manholes:</label>
          <div class="input-group">
            <input type="number" id="sanManholes" value="">
          </div>
          <div class="unit">units</div>
        </div>
        <div class="form-row">
          <label for="sanFittings">Fittings:</label>
          <div class="input-group">
            <input type="number" id="sanFittings" value="">
          </div>
          <div class="unit">units</div>
        </div>
        <div class="button-group">
          <button onclick="calculateSanitary()">Calculate Sanitary</button>
        </div>
        <div id="sanitaryOutput" class="output"></div>
      </div>
    </div>

    <!-- Storm System Section -->
    <div id="storm-tab" class="tab-content">
      <div class="section">
        <h2>Storm System</h2>
        <!-- Add form inputs for storm system calculations -->
        <div class="form-row">
          <label for="roofArea">Roof Area:</label>
          <div class="input-group">
            <input type="number" id="roofArea" value="200">
          </div>
          <div class="unit">sq ft</div>
        </div>
        <div class="form-row">
          <label for="pavementArea">Pavement Area:</label>
          <div class="input-group">
            <input type="number" id="pavementArea" value="0">
          </div>
          <div class="unit">sq ft</div>
        </div>
        <div class="form-row">
          <label for="coef">Runoff Coefficient:</label>
          <div class="input-group">
            <input type="number" id="coef" value="0.9" step="0.1">
          </div>
        </div>
        <div class="form-row">
          <label for="intensity">Rainfall Intensity:</label>
          <div class="input-group">
            <input type="number" id="intensity" value="50">
          </div>
          <div class="unit">in/hr</div>
        </div>
        <div class="form-row">
          <label for="stormLength">Total Pipe Length:</label>
          <div class="input-group">
            <input type="number" id="stormLength" value="60">
          </div>
          <div class="unit">ft</div>
        </div>
        <div class="form-row">
          <label for="downspouts">Downspouts:</label>
          <div class="input-group">
            <input type="number" id="downspouts" value="">
          </div>
          <div class="unit">units</div>
        </div>
        <div class="form-row">
          <label for="catchBasins">Catch Basins:</label>
          <div class="input-group">
            <input type="number" id="catchBasins" value="">
          </div>
          <div class="unit">units</div>
        </div>
        <div class="form-row">
          <label for="stormManholes">Manholes:</label>
          <div class="input-group">
            <input type="number" id="stormManholes" value="">
          </div>
          <div class="unit">units</div>
        </div>
        <div class="form-row">
          <label for="stormFittings">Fittings:</label>
          <div class="input-group">
            <input type="number" id="stormFittings" value="">
          </div>
          <div class="unit">units</div>
        </div>
        <div class="button-group">
          <button onclick="calculateStorm()">Calculate Storm</button>
        </div>
        <div id="stormOutput" class="output"></div>
      </div>
    </div>

    <!-- Costs & Labor Section -->
    <div id="costs-tab" class="tab-content">
      <div class="section">
        <h2>Costs & Labor</h2>
        <div class="material-costs">
          <h3>Material Costs</h3>
          <div class="form-row">
            <label for="trapCost">Trap Cost:</label>
            <div class="input-group">
              <input type="number" id="trapCost" value="18">
            </div>
            <div class="unit">$</div>
          </div>
          <div class="form-row">
            <label for="ventCost">Vent Cost:</label>
            <div class="input-group">
              <input type="number" id="ventCost" value="10">
            </div>
            <div class="unit">$</div>
          </div>
          <div class="form-row">
            <label for="cleanoutCost">Cleanout Cost:</label>
            <div class="input-group">
              <input type="number" id="cleanoutCost" value="30">
            </div>
            <div class="unit">$</div>
          </div>
          <div class="form-row">
            <label for="manholeCost">Manhole Cost:</label>
            <div class="input-group">
              <input type="number" id="manholeCost" value="600">
            </div>
            <div class="unit">$</div>
          </div>
          <div class="form-row">
            <label for="fittingCost">Fitting Cost:</label>
            <div class="input-group">
              <input type="number" id="fittingCost" value="10">
            </div>
            <div class="unit">$</div>
          </div>
          <div class="form-row">
            <label for="downspoutCost">Downspout Cost:</label>
            <div class="input-group">
              <input type="number" id="downspoutCost" value="55">
            </div>
            <div class="unit">$</div>
          </div>
          <div class="form-row">
            <label for="catchBasinCost">Catch Basin Cost:</label>
            <div class="input-group">
              <input type="number" id="catchBasinCost" value="180">
            </div>
            <div class="unit">$</div>
          </div>
          <div id="sanitaryPipesContainer"></div>
          <div id="stormPipesContainer"></div>
          <div class="button-group">
            <button onclick="calculateCosts()">Calculate Total Costs</button>
            <button class="secondary" onclick="updateToCurrentPrices()">Update to Current Prices</button>
          </div>
        </div>
        <div class="labor-inputs">
          <h3>Labor Inputs</h3>
          <!-- Add labor input fields as needed -->
        </div>
        <div id="costsOutput" class="output"></div>
      </div>
    </div>

    <!-- Summary & Export Section -->
    <div id="summary-tab" class="tab-content">
      <div class="section">
        <h2>Summary & Export</h2>
        <div class="summary-card">
          <h3>Sanitary System Summary</h3>
          <div id="sanitarySummary"></div>
        </div>
        <div class="summary-card">
          <h3>Storm System Summary</h3>
          <div id="stormSummary"></div>
        </div>
        <div class="summary-card">
          <h3>Cost Summary</h3>
          <table id="costTable" class="cost-breakdown">
            <thead>
              <tr>
                <th>Description</th>
                <th>Quantity</th>
                <th>Unit Cost</th>
                <th>Total Cost</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="costSummary"></div>
        </div>
        <div class="export-section">
          <button onclick="exportToPDF()">Export to PDF</button>
          <button class="secondary" onclick="exportToExcel()">Export to Excel</button>
        </div>
      </div>
    </div>

    <!-- Help & Formulas Section -->
    <div id="help-tab" class="tab-content">
      <div class="section">
        <h2>Help & Formulas</h2>
        <!-- Add help and formula content as needed -->
        <div class="help-step">
          <h4>Step 1: Input Project Details</h4>
          <p>Enter the project name, client name, location, and preparer details in the Project Info tab.</p>
        </div>
        <div class="formula-section">
          <h3>Formulas</h3>
          <div class="formula">Q = C * I * A</div>
          <p>Where Q = Peak Flow, C = Runoff Coefficient, I = Rainfall Intensity, A = Area</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tab switching function
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    // Reset calculator to default values
    function resetCalculator() {
      if (!confirm('Are you sure you want to reset all inputs? This cannot be undone.')) {
        return;
      }
      
      // Reset project info
      document.getElementById('projectName').value = 'Residential Plumbing Project';
      document.getElementById('clientName').value = 'John Dela Cruz';
      document.getElementById('projectLocation').value = 'Manila, Philippines';
      document.getElementById('preparedBy').value = 'Maria Santos, Civil Engineer';
      
      // Reset sanitary system
      document.getElementById('wc').value = '2';
      document.getElementById('lav').value = '2';
      document.getElementById('sink').value = '1';
      document.getElementById('shower').value = '1';
      document.getElementById('tub').value = '1';
      document.getElementById('urinal').value = '0';
      document.getElementById('floorDrain').value = '2';
      document.getElementById('sanLength').value = '50';
      document.getElementById('traps').value = '';
      document.getElementById('vents').value = '';
      document.getElementById('cleanouts').value = '';
      document.getElementById('sanManholes').value = '';
      document.getElementById('sanFittings').value = '';
      
      // Reset storm system
      document.getElementById('roofArea').value = '200';
      document.getElementById('pavementArea').value = '0';
      document.getElementById('coef').value = '0.9';
      document.getElementById('intensity').value = '50';
      document.getElementById('stormLength').value = '60';
      document.getElementById('downspouts').value = '';
      document.getElementById('catchBasins').value = '';
      document.getElementById('stormManholes').value = '';
      document.getElementById('stormFittings').value = '';
      
      // Reset costs with current market prices (update these as needed)
      document.getElementById('trapCost').value = '18';
      document.getElementById('ventCost').value = '10';
      document.getElementById('cleanoutCost').value = '30';
      document.getElementById('manholeCost').value = '600';
      document.getElementById('fittingCost').value = '10';
      document.getElementById('downspoutCost').value = '55';
      document.getElementById('catchBasinCost').value = '180';
      
      // Reset pipe cost containers
      document.getElementById('sanitaryPipesContainer').innerHTML = '';
      document.getElementById('stormPipesContainer').innerHTML = '';
      
      // Reinitialize pipe costs
      initializePipeCosts();
      
      // Clear results
      window.sanitaryResults = null;
      window.stormResults = null;
      window.costResults = null;
      
      document.getElementById('sanitaryOutput').innerHTML = '';
      document.getElementById('stormOutput').innerHTML = '';
      document.getElementById('costsOutput').innerHTML = '';
      document.getElementById('sanitarySummary').innerHTML = '';
      document.getElementById('stormSummary').innerHTML = '';
      document.getElementById('costSummary').innerHTML = '';
      
      // Clear cost table
      const costTable = document.getElementById('costTable');
      while (costTable.rows.length > 1) {
        costTable.deleteRow(1);
      }
      
      alert('Calculator has been reset to default values.');
    }

    // Fix the pipeSizing object
    const pipeSizing = {
      sanitary: {
        pvc: {"2": 21, "3": 42, "4": 120, "6": 500},
        castIron: {"2": 20, "3": 40, "4": 110, "6": 480},
        hdp: {"2": 21, "3": 42, "4": 120, "6": 500},
        abs: {"2": 21, "3": 42, "4": 120, "6": 500}
      },
      storm: {
        pvc: {"4": 25, "6": 75, "8": 180, "10": 320},
        corrugated: {"4": 30, "6": 80, "8": 200, "10": 350},
        concrete: {"4": 25, "6": 75, "8": 180, "10": 320},
        castIron: {"4": 25, "6": 75, "8": 180, "10": 320}
      }
    };

    // Initialize pipe costs
    function initializePipeCosts() {
      // Add default pipe cost rows (example)
      addPipeCostRow('sanitary', 'pvc', '4');
      addPipeCostRow('storm', 'pvc', '6');
    }

    function addPipeCostRow(system, material, size) {
      const container = document.getElementById(`${system}PipesContainer`);
      const row = document.createElement('div');
      row.className = 'pipe-cost-row';
      row.innerHTML = `
        <select class="size-select" onchange="updatePipeCost('${system}', this)">
          <option value="2" ${size === '2' ? 'selected' : ''}>2"</option>
          <option value="3" ${size === '3' ? 'selected' : ''}>3"</option>
          <option value="4" ${size === '4' ? 'selected' : ''}>4"</option>
          <option value="6" ${size === '6' ? 'selected' : ''}>6"</option>
          <option value="8" ${size === '8' ? 'selected' : ''}>8"</option>
          <option value="10" ${size === '10' ? 'selected' : ''}>10"</option>
        </select>
        <input type="number" class="cost-input" value="${pipeSizing[system][material][size] || 0}" onchange="updatePipeCost('${system}', this.parentElement)">
        <button class="remove-pipe-btn" onclick="this.parentElement.remove()">Remove</button>
      `;
      container.appendChild(row);
    }

    function updatePipeCost(system, element) {
      const sizeSelect = element.querySelector('.size-select');
      const costInput = element.querySelector('.cost-input');
      const size = sizeSelect.value;
      const material = document.getElementById(`${system}PipeMaterial`)?.value || 'pvc';
      const newCost = pipeSizing[system][material][size] || costInput.value;
      costInput.value = newCost;
    }

    // Update all prices to current market rates
    function updateToCurrentPrices() {
      if (confirm('Update all material costs to current market prices?')) {
        const currentPrices = {
          trapCost: 18,
          ventCost: 10,
          cleanoutCost: 30,
          manholeCost: 600,
          fittingCost: 10,
          downspoutCost: 55,
          catchBasinCost: 180,
          pvcPipe: { '2': 28, '3': 40, '4': 58, '6': 95 },
          castIronPipe: { '2': 75, '3': 110, '4': 150, '6': 230 },
          hdpPipe: { '2': 35, '3': 50, '4': 75, '6': 125 },
          absPipe: { '2': 32, '3': 45, '4': 62, '6': 100 },
          corrugatedPipe: { '4': 18, '6': 30, '8': 48, '10': 72 },
          concretePipe: { '4': 65, '6': 100, '8': 140, '10': 210 }
        };
        
        // Update accessory costs
        document.getElementById('trapCost').value = currentPrices.trapCost;
        document.getElementById('ventCost').value = currentPrices.ventCost;
        document.getElementById('cleanoutCost').value = currentPrices.cleanoutCost;
        document.getElementById('manholeCost').value = currentPrices.manholeCost;
        document.getElementById('fittingCost').value = currentPrices.fittingCost;
        document.getElementById('downspoutCost').value = currentPrices.downspoutCost;
        document.getElementById('catchBasinCost').value = currentPrices.catchBasinCost;
        
        // Update pipe costs
        updateAllPipeCosts(currentPrices);
        
        alert('Prices updated to current market rates.');
      }
    }

    // Update all pipe costs
    function updateAllPipeCosts(currentPrices) {
      // Update sanitary pipes
      const sanitaryPipes = document.querySelectorAll('#sanitaryPipesContainer .pipe-cost-row');
      sanitaryPipes.forEach(pipeRow => {
        const sizeSelect = pipeRow.querySelector('.size-select');
        const costInput = pipeRow.querySelector('.cost-input');
        const size = sizeSelect.value;
        
        const material = document.getElementById('sanPipeMaterial')?.value || 'pvc';
        const newCost = currentPrices[`${material}Pipe`]?.[size] || costInput.value;
        costInput.value = newCost;
      });
      
      // Update storm pipes
      const stormPipes = document.querySelectorAll('#stormPipesContainer .pipe-cost-row');
      stormPipes.forEach(pipeRow => {
        const sizeSelect = pipeRow.querySelector('.size-select');
        const costInput = pipeRow.querySelector('.cost-input');
        const size = sizeSelect.value;
        
        const material = document.getElementById('stormPipeMaterial')?.value || 'pvc';
        const materialKey = material === 'corrugated' ? 'corrugatedPipe' : `${material}Pipe`;
        const newCost = currentPrices[materialKey]?.[size] || costInput.value;
        costInput.value = newCost;
      });
    }

    // Export to PDF - IMPROVED VERSION
    function exportToPDF() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Get project information
        const projectName = document.getElementById("projectName")?.value || "Sanitary & Storm Project";
        const clientName = document.getElementById("clientName")?.value || "Client Name";
        const projectLocation = document.getElementById("projectLocation")?.value || "Project Location";
        const preparedBy = document.getElementById("preparedBy")?.value || "Prepared By";
        const date = new Date().toLocaleDateString();
        
        // Get BOQ data
        const boqData = extractBOQDataFromDisplay();
        
        // Set margins and initial position
        const margin = 15;
        let y = margin;
        
        // Add header information with better spacing
        doc.setFontSize(16);
        doc.setFont("helvetica", "bold");
        doc.text("Sanitary & Storm Drain Report", margin, y);
        y += 8;
        
        doc.setFontSize(9);
        doc.setFont("helvetica", "normal");
        doc.text(`Project: ${projectName}`, margin, y);
        doc.text(`Client: ${clientName}`, 100, y);
        y += 5;
        doc.text(`Location: ${projectLocation}`, margin, y);
        doc.text(`Date: ${date}`, 100, y);
        y += 5;
        doc.text(`Prepared by: ${preparedBy}`, margin, y);
        y += 12;
        
        // Add Bill of Quantities title
        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.text("Bill of Quantities", margin, y);
        y += 8;
        
        // Configure and draw the table with better formatting
        doc.autoTable({
          head: [["Description", "Quantity", "Unit", "Unit Rate", "Amount"]],
          body: boqData.slice(1), // Skip header row
          startY: y,
          theme: "grid",
          styles: {
            fontSize: 8,
            cellPadding: 3,
            valign: "middle",
            lineColor: [0, 0, 0],
            lineWidth: 0.1,
            textColor: [0, 0, 0],
            minCellHeight: 6
          },
          columnStyles: {
            0: { halign: "left", cellWidth: 70 },
            1: { halign: "center", cellWidth: 22 },
            2: { halign: "center", cellWidth: 18 },
            3: { halign: "right", cellWidth: 28 },
            4: { halign: "right", cellWidth: 32 }
          },
          headStyles: {
            fillColor: [220, 220, 220],
            textColor: 0,
            fontStyle: "bold",
            lineWidth: 0.1,
            fontSize: 8
          },
          alternateRowStyles: {
            fillColor: [245, 245, 245]
          },
          didParseCell: function(data) {
            const cellValue = data.cell.raw ? data.cell.raw.toString() : "";
            
            // Clean currency values - remove ± symbols and ensure proper formatting
            if ((data.column.index === 3 || data.column.index === 4) && data.cell.text) {
              if (typeof data.cell.text === 'string') {
                data.cell.text = data.cell.text.replace(/[±]/g, '').trim();
              }
            }
            
            // Style section headers
            if (cellValue === "Materials" || cellValue === "Labor" || cellValue === "Summary") {
              data.cell.styles.fillColor = [224, 224, 224];
              data.cell.styles.fontStyle = 'bold';
              data.cell.styles.halign = 'left';
              data.cell.colSpan = 5;
            }
            
            // Style totals and subtotals
            if (cellValue.includes("Subtotal") || cellValue.includes("Total") || 
                cellValue.includes("TOTAL") || cellValue.includes("Overhead") || 
                cellValue.includes("Profit Margin") || cellValue.includes("Materials + Labor") || 
                cellValue.includes("Waste")) {
              data.cell.styles.fontStyle = 'bold';
            }
            
            // Style the grand total row
            if (cellValue.includes("TOTAL PROJECT COST")) {
              data.cell.styles.fillColor = [200, 200, 200];
              data.cell.styles.fontStyle = 'bold';
            }
          },
          margin: { top: y, left: margin, right: margin }
        });
        
        // Save the PDF
        doc.save(`${projectName.replace(/[^a-z0-9]/gi, '_')}_Report.pdf`);
      } catch (error) {
        alert("Error generating PDF: " + error.message);
        console.error(error);
      }
    }

    // Helper function to extract BOQ data (placeholder)
    function extractBOQDataFromDisplay() {
      // This is a placeholder. Implement based on actual data structure
      return [
        ["Description", "Quantity", "Unit", "Unit Rate", "Amount"],
        ["Traps", document.getElementById('traps').value || 0, "units", document.getElementById('trapCost').value || 0, (document.getElementById('traps').value || 0) * (document.getElementById('trapCost').value || 0)],
        ["Vents", document.getElementById('vents').value || 0, "units", document.getElementById('ventCost').value || 0, (document.getElementById('vents').value || 0) * (document.getElementById('ventCost').value || 0)]
      ];
    }

    // Placeholder functions for calculations
    function calculateSanitary() {
      // Implement sanitary calculation logic
      document.getElementById('sanitaryOutput').innerHTML = `<h3>Sanitary System Calculation Results</h3><p>Calculation in progress...</p>`;
    }

    function calculateStorm() {
      // Implement storm calculation logic
      document.getElementById('stormOutput').innerHTML = `<h3>Storm System Calculation Results</h3><p>Calculation in progress...</p>`;
    }

    function calculateCosts() {
      // Implement cost calculation logic
      document.getElementById('costsOutput').innerHTML = `<h3>Cost Calculation Results</h3><p>Calculation in progress...</p>`;
    }

    function saveProject() {
      // Implement save functionality
      alert('Project saved!');
    }

    function loadProject() {
      // Implement load functionality
      alert('Project loaded!');
    }

    // Initialize on page load
    window.onload = function() {
      initializePipeCosts();
    };
  </script>
</body>
</html>
