<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sanitary & Storm Drain Calculator</title>

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #64748b;
      --light: #f8fafc;
      --dark: #0f172a;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #cbd5e1;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f1f5f9;
      color: var(--dark);
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    h1 {
      font-size: 2.2em;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .subtitle {
      font-size: 1.1em;
      opacity: 0.9;
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    @media (max-width: 900px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }
    
    .section {
      margin-bottom: 25px;
      padding: 20px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .section h2 {
      font-size: 1.5em;
      margin-bottom: 20px;
      color: var(--primary);
      border-bottom: 2px solid var(--border);
      padding-bottom: 10px;
    }
    
    .form-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .form-row label {
      flex: 1 0 200px;
      font-weight: 500;
      margin: 0;
    }
    
    .form-row input, .form-row select {
      flex: 2 0 250px;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid var(--border);
      background-color: white;
      color: var(--dark);
      font-size: 1em;
    }
    
    .form-row input:focus, .form-row select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .checkbox-row {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .checkbox-row input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
    }
    
    button {
      padding: 12px 20px;
      border-radius: 5px;
      border: none;
      background-color: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 1em;
    }
    
    button:hover {
      background-color: var(--primary-dark);
    }
    
    button.secondary {
      background-color: var(--secondary);
    }
    
    button.secondary:hover {
      background-color: #475569;
    }
    
    .output {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8fafc;
      border-radius: 8px;
      white-space: pre-line;
      color: var(--dark);
      border-left: 4px solid var(--primary);
    }
    
    .output h3 {
      margin-top: 0;
      color: var(--primary);
    }
    
    .export-section {
      grid-column: 1 / -1;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .validation-error {
      color: var(--danger);
      font-size: 0.9em;
      margin-top: 5px;
      display: none;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }
    
    .tab.active {
      border-bottom: 3px solid var(--primary);
      font-weight: 600;
      color: var(--primary);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .summary-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }
    
    .summary-card h3 {
      margin-top: 0;
      color: var(--primary);
    }
    
    .cost-breakdown {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .cost-breakdown th, .cost-breakdown td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    .cost-breakdown th {
      background-color: #f1f5f9;
      font-weight: 600;
    }
    
    .cost-breakdown tr:last-child td {
      border-bottom: none;
      font-weight: 600;
      background-color: #f1f5f9;
    }
    
    .grey-header {
      background-color: #e0e0e0 !important;
      font-weight: bold !important;
    }
    
    .project-info {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    
    .disclaimer {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-size: 14px;
      color: #000000;
    }
    
    .material-costs {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
    }
    
    .labor-inputs {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
    }
    
    .productivity-info {
      background: #e8f4fd;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
      border-left: 4px solid var(--primary);
    }
    
    .productivity-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9em;
    }
    
    .productivity-table th, .productivity-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    .productivity-table th {
      background-color: #f1f5f9;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Sanitary & Storm Drain Calculator</h1>
      <div class="subtitle">Professional quantity takeoff for plumbing contractors and estimators</div>
      <div class="disclaimer">
        <strong>Note:</strong> This calculator uses practical approximations based on plumbing codes. 
        For formal design, consult the actual code provisions and a licensed engineer.
      </div>
    </header>
    
    <div class="tabs">
      <div class="tab active" onclick="switchTab('project')">Project Info</div>
      <div class="tab" onclick="switchTab('sanitary')">Sanitary System</div>
      <div class="tab" onclick="switchTab('storm')">Storm System</div>
      <div class="tab" onclick="switchTab('costs')">Costs & Labor</div>
      <div class="tab" onclick="switchTab('summary')">Summary & Export</div>
    </div>
    
    <!-- Project Information Section -->
    <div id="project-tab" class="tab-content active">
      <div class="section">
        <h2>Project Information</h2>
        <div class="project-info">
          <div class="form-row">
            <label for="projectName">Project Name:</label>
            <input type="text" id="projectName" placeholder="Enter Project Name" value="Residential Plumbing Project">
            <div class="validation-error" id="projectNameError">Project name is required</div>
          </div>
          <div class="form-row">
            <label for="clientName">Client Name:</label>
            <input type="text" id="clientName" placeholder="Enter Client Name" value="John Dela Cruz">
          </div>
          <div class="form-row">
            <label for="projectLocation">Project Location:</label>
            <input type="text" id="projectLocation" placeholder="Enter Location" value="Manila, Philippines">
          </div>
          <div class="form-row">
            <label for="preparedBy">Prepared By:</label>
            <input type="text" id="preparedBy" placeholder="Enter Name" value="Maria Santos, Civil Engineer">
          </div>
          <div class="form-row">
            <label for="currency">Currency:</label>
            <select id="currency">
              <option value="PHP">Philippine Peso (₱)</option>
              <option value="USD">US Dollar ($)</option>
              <option value="EUR">Euro (€)</option>
              <option value="JPY">Japanese Yen (¥)</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <label for="codeStandard">Plumbing Code Standard:</label>
          <select id="codeStandard">
            <option value="rnpcp">RNPCP (Philippines)</option>
            <option value="ipc">IPC (International)</option>
            <option value="upc">UPC (Uniform)</option>
          </select>
        </div>
        
        <div class="form-row">
          <label for="units">Measurement Units:</label>
          <select id="units">
            <option value="metric">Metric (m, mm, L/s)</option>
            <option value="imperial">Imperial (ft, in, gpm)</option>
          </select>
        </div>
        
        <button onclick="saveProject()">Save Project</button>
        <button class="secondary" onclick="loadProject()">Load Project</button>
      </div>
    </div>
    
    <!-- Sanitary Input Section -->
    <div id="sanitary-tab" class="tab-content">
      <div class="section">
        <h2>Sanitary System</h2>
        
        <h3>Fixture Count</h3>
        <div class="form-row">
          <label for="wc">Water Closets:</label>
          <input type="number" id="wc" value="2" min="0">
        </div>
        <div class="form-row">
          <label for="lav">Lavatories:</label>
          <input type="number" id="lav" value="2" min="0">
        </div>
        <div class="form-row">
          <label for="sink">Kitchen Sinks:</label>
          <input type="number" id="sink" value="1" min="0">
        </div>
        <div class="form-row">
          <label for="shower">Showers:</label>
          <input type="number" id="shower" value="1" min="0">
        </div>
        <div class="form-row">
          <label for="tub">Bathtubs:</label>
          <input type="number" id="tub" value="1" min="0">
        </div>
        <div class="form-row">
          <label for="urinal">Urinals:</label>
          <input type="number" id="urinal" value="0" min="0">
        </div>
        <div class="form-row">
          <label for="floorDrain">Floor Drains:</label>
          <input type="number" id="floorDrain" value="2" min="0">
        </div>
        
        <h3>Pipe System</h3>
        <div class="form-row">
          <label for="sanLength">Total Developed Length:</label>
          <input type="number" id="sanLength" value="50" min="0" step="0.1">
          <span id="sanLengthUnit">m</span>
        </div>
        <div class="form-row">
          <label for="sanPipeMaterial">Pipe Material:</label>
          <select id="sanPipeMaterial">
            <option value="pvc">PVC</option>
            <option value="castIron">Cast Iron</option>
            <option value="hdp">HDPE</option>
            <option value="abs">ABS</option>
          </select>
        </div>
        <div class="form-row">
          <label for="sanPipeLength">Commercial Pipe Length:</label>
          <select id="sanPipeLength">
            <option value="3">3 m</option>
            <option value="6" selected>6 m</option>
          </select>
        </div>
        <div class="form-row">
          <label for="sanSlope">Pipe Slope (%):</label>
          <input type="number" id="sanSlope" value="2" min="0.5" max="10" step="0.1">
        </div>
        
        <h3>Accessories (optional - will calculate defaults if empty)</h3>
        <div class="form-row">
          <label for="traps">Traps:</label>
          <input type="number" id="traps" placeholder="Default = # of fixtures" min="0">
        </div>
        <div class="form-row">
          <label for="vents">Vents:</label>
          <input type="number" id="vents" placeholder="Default = 1 per fixture" min="0">
        </div>
        <div class="form-row">
          <label for="cleanouts">Cleanouts:</label>
          <input type="number" id="cleanouts" placeholder="Default = 1 per 30 m + bends" min="0">
        </div>
        <div class="form-row">
          <label for="sanManholes">Manholes:</label>
          <input type="number" id="sanManholes" placeholder="Default = 1 per 50 m" min="0">
        </div>
        <div class="form-row">
          <label for="sanFittings">Fittings/Elbows:</label>
          <input type="number" id="sanFittings" placeholder="Default = 1 per 10 m" min="0">
        </div>
        
        <button onclick="calculateSanitary()">Calculate Sanitary System</button>
        <div class="output" id="sanitaryOutput"></div>
      </div>
    </div>
    
    <!-- Storm Input Section -->
    <div id="storm-tab" class="tab-content">
      <div class="section">
        <h2>Storm Drain System</h2>
        
        <h3>Runoff Calculation</h3>
        <div class="form-row">
          <label for="roofArea">Roof Area:</label>
          <input type="number" id="roofArea" value="200" min="0" step="0.1">
          <span id="roofAreaUnit">m²</span>
        </div>
        <div class="form-row">
          <label for="pavementArea">Pavement Area:</label>
          <input type="number" id="pavementArea" value="0" min="0" step="0.1">
          <span id="pavementAreaUnit">m²</span>
        </div>
        <div class="form-row">
          <label for="coef">Runoff Coefficient (C):</label>
          <input type="number" id="coef" value="0.9" min="0.1" max="1" step="0.05">
        </div>
        <div class="form-row">
          <label for="intensity">Rainfall Intensity:</label>
          <input type="number" id="intensity" value="50" min="1" step="1">
          <span id="intensityUnit">mm/hr</span>
        </div>
        
        <h3>Pipe System</h3>
        <div class="form-row">
          <label for="stormLength">Total Developed Length:</label>
          <input type="number" id="stormLength" value="60" min="0" step="0.1">
          <span id="stormLengthUnit">m</span>
        </div>
        <div class="form-row">
          <label for="stormPipeMaterial">Pipe Material:</label>
          <select id="stormPipeMaterial">
            <option value="pvc">PVC</option>
            <option value="corrugated">Corrugated HDPE</option>
            <option value="concrete">Concrete</option>
            <option value="castIron">Cast Iron</option>
          </select>
        </div>
        <div class="form-row">
          <label for="stormPipeLength">Commercial Pipe Length:</label>
          <select id="stormPipeLength">
            <option value="3">3 m</option>
            <option value="6" selected>6 m</option>
          </select>
        </div>
        <div class="form-row">
          <label for="stormSlope">Pipe Slope (%):</label>
          <input type="number" id="stormSlope" value="1" min="0.5" max="10" step="0.1">
        </div>
        
        <h3>Accessories (optional - will calculate defaults if empty)</h3>
        <div class="form-row">
          <label for="downspouts">Downspouts:</label>
          <input type="number" id="downspouts" placeholder="Default = 1 per 100 m² roof" min="0">
        </div>
        <div class="form-row">
          <label for="catchBasins">Catch Basins:</label>
          <input type="number" id="catchBasins" placeholder="Default = every 60 m" min="0">
        </div>
        <div class="form-row">
          <label for="stormManholes">Manholes:</label>
          <input type="number" id="stormManholes" placeholder="Default = every 50 m" min="0">
        </div>
        <div class="form-row">
          <label for="stormFittings">Fittings/Elbows:</label>
          <input type="number" id="stormFittings" placeholder="Default = 1 per 10 m" min="0">
        </div>
        
        <button onclick="calculateStorm()">Calculate Storm Drain System</button>
        <div class="output" id="stormOutput"></div>
      </div>
    </div>
    
    <!-- Costs & Labor Section -->
    <div id="costs-tab" class="tab-content">
      <div class="section">
        <h2>Costs & Labor Estimation</h2>
        
        <div class="material-costs">
          <h3>Material Costs</h3>
          <div class="form-row">
            <label for="pvcPipeCost2">PVC Pipe 2" Cost (per section):</label>
            <input type="number" id="pvcPipeCost2" value="25" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="pvcPipeCost3">PVC Pipe 3" Cost (per section):</label>
            <input type="number" id="pvcPipeCost3" value="35" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="pvcPipeCost4">PVC Pipe 4" Cost (per section):</label>
            <input type="number" id="pvcPipeCost4" value="50" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="pvcPipeCost6">PVC Pipe 6" Cost (per section):</label>
            <input type="number" id="pvcPipeCost6" value="85" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="castIronPipeCost2">Cast Iron Pipe 2" Cost (per section):</label>
            <input type="number" id="castIronPipeCost2" value="65" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="castIronPipeCost3">Cast Iron Pipe 3" Cost (per section):</label>
            <input type="number" id="castIronPipeCost3" value="95" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="castIronPipeCost4">Cast Iron Pipe 4" Cost (per section):</label>
            <input type="number" id="castIronPipeCost4" value="130" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="castIronPipeCost6">Cast Iron Pipe 6" Cost (per section):</label>
            <input type="number" id="castIronPipeCost6" value="200" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="hdpPipeCost2">HDPE Pipe 2" Cost (per section):</label>
            <input type="number" id="hdpPipeCost2" value="32" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="hdpPipeCost3">HDPE Pipe 3" Cost (per section):</label>
            <input type="number" id="hdpPipeCost3" value="45" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="hdpPipeCost4">HDPE Pipe 4" Cost (per section):</label>
            <input type="number" id="hdpPipeCost4" value="65" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="hdpPipeCost6">HDPE Pipe 6" Cost (per section):</label>
            <input type="number" id="hdpPipeCost6" value="110" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="absPipeCost2">ABS Pipe 2" Cost (per section):</label>
            <input type="number" id="absPipeCost2" value="28" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="absPipeCost3">ABS Pipe 3" Cost (per section):</label>
            <input type="number" id="absPipeCost3" value="40" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="absPipeCost4">ABS Pipe 4" Cost (per section):</label>
            <input type="number" id="absPipeCost4" value="55" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="absPipeCost6">ABS Pipe 6" Cost (per section):</label>
            <input type="number" id="absPipeCost6" value="90" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="corrugatedPipeCost4">Corrugated HDPE 4" Cost (per section):</label>
            <input type="number" id="corrugatedPipeCost4" value="15" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="corrugatedPipeCost6">Corrugated HDPE 6" Cost (per section):</label>
            <input type="number" id="corrugatedPipeCost6" value="25" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="corrugatedPipeCost8">Corrugated HDPE 8" Cost (per section):</label>
            <input type="number" id="corrugatedPipeCost8" value="40" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="corrugatedPipeCost10">Corrugated HDPE 10" Cost (per section):</label>
            <input type="number" id="corrugatedPipeCost10" value="60" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="concretePipeCost4">Concrete Pipe 4" Cost (per section):</label>
            <input type="number" id="concretePipeCost4" value="55" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="concretePipeCost6">Concrete Pipe 6" Cost (per section):</label>
            <input type="number" id="concretePipeCost6" value="85" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="concretePipeCost8">Concrete Pipe 8" Cost (per section):</label>
            <input type="number" id="concretePipeCost8" value="120" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="concretePipeCost10">Concrete Pipe 10" Cost (per section):</label>
            <input type="number" id="concretePipeCost10" value="180" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="trapCost">Trap Cost (each):</label>
            <input type="number" id="trapCost" value="15" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="ventCost">Vent Cost (each):</label>
            <input type="number" id="ventCost" value="8" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="cleanoutCost">Cleanout Cost (each):</label>
            <input type="number" id="cleanoutCost" value="25" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="manholeCost">Manhole Cost (each):</label>
            <input type="number" id="manholeCost" value="500" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="fittingCost">Fitting/Elbow Cost (each):</label>
            <input type="number" id="fittingCost" value="8" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="downspoutCost">Downspout Cost (each):</label>
            <input type="number" id="downspoutCost" value="45" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label for="catchBasinCost">Catch Basin Cost (each):</label>
            <input type="number" id="catchBasinCost" value="150" min="0" step="0.01">
          </div>
        </div>
        
        <div class="labor-inputs">
          <h3>Labor Requirements</h3>
          <div class="form-row">
            <label for="productivityStandard">Productivity Standard:</label>
            <select id="productivityStandard">
              <option value="philippines">Philippines (Manual/Low-tech)</option>
              <option value="international">International (Mechanized/High-tech)</option>
              <option value="custom">Custom Productivity Rates</option>
            </select>
          </div>
          
          <div id="customProductivityRates" style="display: none;">
            <h4>Custom Productivity Rates</h4>
            <div class="form-row">
              <label for="customPipeLaying">Pipe Laying (m/day):</label>
              <input type="number" id="customPipeLaying" value="10" min="1" step="0.1">
            </div>
            <div class="form-row">
              <label for="customManhole">Manhole Construction (units/day):</label>
              <input type="number" id="customManhole" value="0.8" min="0.1" step="0.1">
            </div>
            <div class="form-row">
              <label for="customCatchBasin">Catch Basin (units/day):</label>
              <input type="number" id="customCatchBasin" value="1.2" min="0.1" step="0.1">
            </div>
            <div class="form-row">
              <label for="customFitting">Fittings Installation (units/day):</label>
              <input type="number" id="customFitting" value="20" min="1" step="1">
            </div>
          </div>
          
          <div class="form-row">
            <label for="plumberRate">Plumber Rate (per hour):</label>
            <input type="number" id="plumberRate" value="80" min="0" step="0.1">
          </div>
          <div class="form-row">
            <label for="helperRate">Helper Rate (per hour):</label>
            <input type="number" id="helperRate" value="50" min="0" step="0.1">
          </div>
          <div class="form-row">
            <label for="dailyHours">Daily Work Hours:</label>
            <input type="number" id="dailyHours" value="8" min="1" max="12">
          </div>
          <div class="form-row">
            <label for="wasteFactor">Waste Factor (%):</label>
            <input type="number" id="wasteFactor" value="5" min="0" max="20">
          </div>
          <div class="form-row">
            <label for="overhead">Overhead (%):</label>
            <input type="number" id="overhead" value="15" min="0" max="30">
          </div>
          <div class="form-row">
            <label for="profitMargin">Profit Margin (%):</label>
            <input type="number" id="profitMargin" value="10" min="0" max="30">
          </div>
        </div>
        
        <div class="productivity-info">
          <h3>Productivity Reference</h3>
          <table class="productivity-table">
            <thead>
              <tr>
                <th>Work Item</th>
                <th>Philippines</th>
                <th>International</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>PVC/HDPE Pipe Laying (m/day)</td>
                <td>10-15 m</td>
                <td>20-30 m</td>
              </tr>
              <tr>
                <td>Concrete Pipe Laying (m/day)</td>
                <td>4-6 m</td>
                <td>8-12 m</td>
              </tr>
              <tr>
                <td>Manhole Construction (units/day)</td>
                <td>0.6-1.0</td>
                <td>1-2</td>
              </tr>
              <tr>
                <td>Catch Basin (units/day)</td>
                <td>1-1.5</td>
                <td>2-3</td>
              </tr>
              <tr>
                <td>Fittings Installation (units/day)</td>
                <td>15-25</td>
                <td>30-50</td>
              </tr>
            </tbody>
          </table>
          <p><small>Note: Productivity rates are per crew, not per individual worker. Philippine rates reflect manual labor while international rates assume mechanized equipment.</small></p>
        </div>
        
        <button onclick="calculateCosts()">Calculate Total Costs</button>
        <div class="output" id="costsOutput"></div>
      </div>
    </div>
    
    <!-- Summary Section -->
    <div id="summary-tab" class="tab-content">
      <div class="section">
        <h2>Project Summary</h2>
        
        <div class="summary-card">
          <h3>Sanitary System Summary</h3>
          <div id="sanitarySummary">Calculate sanitary system first</div>
        </div>
        
        <div class="summary-card">
          <h3>Storm System Summary</h3>
          <div id="stormSummary">Calculate storm system first</div>
        </div>
        
        <div class="summary-card">
          <h3>Cost Estimation</h3>
          <div id="costSummary">Calculate costs first</div>
          <table class="cost-breakdown" id="costTable">
            <tr>
              <th>Item</th>
              <th>Quantity</th>
              <th>Unit Cost</th>
              <th>Material Cost</th>
              <th>Labor Days</th>
              <th>Labor Cost</th>
              <th>Total Cost</th>
            </tr>
          </table>
        </div>
        
        <div class="export-section">
          <button onclick="exportToPDF()">Export to PDF</button>
          <button onclick="exportToExcel()">Export to Excel</button>
          <button class="secondary" onclick="generateDetailedReport()">Generate Detailed Report</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize jsPDF
    const { jsPDF } = window.jspdf;
    
    // DFU tables for different codes
    const dfuTables = {
      rnpcp: { wc: 6, lav: 1, sink: 2, shower: 2, tub: 2, urinal: 4, floorDrain: 2 },
      ipc: { wc: 4, lav: 1, sink: 2, shower: 2, tub: 2, urinal: 4, floorDrain: 2 },
      upc: { wc: 4, lav: 1, sink: 2, shower: 2, tub: 2, urinal: 4, floorDrain: 2 }
    };
    
    // Pipe sizing data
    const pipeSizing = {
      sanitary: {
        pvc: { "2": 21, "3": 42, "4": 120, "6": 500 },
        castIron: { "2": 20, "3": 40, "4": 110, "6": 480 }
      },
      storm: {
        pvc: { "4": 25, "6": 75, "8": 180, "10": 320 },
        corrugated: { "4": 30, "6": 80, "8": 200, "10": 350 }
      }
    };
    
    // Productivity rates (per crew per day)
    const productivityRates = {
      philippines: {
        pvcPipe: 12,        // meters per day
        hdpPipe: 12,        // meters per day
        absPipe: 12,        // meters per day
        castIronPipe: 8,    // meters per day
        concretePipe: 5,    // meters per day
        corrugatedPipe: 10, // meters per day
        manhole: 0.8,       // units per day
        catchBasin: 1.2,    // units per day
        fitting: 20,        // units per day
        trap: 25,           // units per day
        vent: 25,           // units per day
        cleanout: 15,       // units per day
        downspout: 8        // units per day
      },
      international: {
        pvcPipe: 25,        // meters per day
        hdpPipe: 25,        // meters per day
        absPipe: 25,        // meters per day
        castIronPipe: 15,   // meters per day
        concretePipe: 10,   // meters per day
        corrugatedPipe: 20, // meters per day
        manhole: 1.5,       // units per day
        catchBasin: 2.5,    // units per day
        fitting: 40,        // units per day
        trap: 50,           // units per day
        vent: 50,           // units per day
        cleanout: 30,       // units per day
        downspout: 15       // units per day
      }
    };

    // Initialize the calculator
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize units
      document.getElementById('units').addEventListener('change', updateUnits);
      updateUnits();
      
      // Productivity standard change handler
      document.getElementById('productivityStandard').addEventListener('change', function() {
        const customRatesDiv = document.getElementById('customProductivityRates');
        if (this.value === 'custom') {
          customRatesDiv.style.display = 'block';
        } else {
          customRatesDiv.style.display = 'none';
        }
      });
    });
    
    // Tab switching function
    function switchTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(tabName + '-tab').classList.add('active');
      
      // Add active class to clicked tab
      event.target.classList.add('active');
    }
    
    // Unit conversion based on selection
    function updateUnits() {
      const units = document.getElementById('units').value;
      const isMetric = units === 'metric';
      
      // Update unit labels
      document.getElementById('sanLengthUnit').textContent = isMetric ? 'm' : 'ft';
      document.getElementById('roofAreaUnit').textContent = isMetric ? 'm²' : 'ft²';
      document.getElementById('pavementAreaUnit').textContent = isMetric ? 'm²' : 'ft²';
      document.getElementById('intensityUnit').textContent = isMetric ? 'mm/hr' : 'in/hr';
      document.getElementById('stormLengthUnit').textContent = isMetric ? 'm' : 'ft';
    }
    
    // Calculate sanitary system
    function calculateSanitary() {
      // Validate inputs
      if (!validateInputs('sanitary')) return;
      
      const code = document.getElementById('codeStandard').value;
      const dfu = dfuTables[code];
      
      // Calculate DFU
      let wc = parseInt(document.getElementById('wc').value) * dfu.wc;
      let lav = parseInt(document.getElementById('lav').value) * dfu.lav;
      let sink = parseInt(document.getElementById('sink').value) * dfu.sink;
      let shower = parseInt(document.getElementById('shower').value) * dfu.shower;
      let tub = parseInt(document.getElementById('tub').value) * dfu.tub;
      let urinal = parseInt(document.getElementById('urinal').value) * dfu.urinal;
      let floorDrain = parseInt(document.getElementById('floorDrain').value) * dfu.floorDrain;
      
      let totalDFU = wc + lav + sink + shower + tub + urinal + floorDrain;
      
      // Calculate flow rate
      let flowRate;
      const units = document.getElementById('units').value;
      
      if (units === 'metric') {
        flowRate = (totalDFU / 2) * 0.06308; // L/s
      } else {
        flowRate = totalDFU / 7.5; // gpm (approximate conversion)
      }
      
      // Determine pipe size based on DFU and slope
      const slope = parseFloat(document.getElementById('sanSlope').value);
      const material = document.getElementById('sanPipeMaterial').value;
      const pipeData = pipeSizing.sanitary[material];
      
      let recommendedSize = "2";
      for (const size in pipeData) {
        if (pipeData[size] * (slope/2) >= totalDFU) {
          recommendedSize = size;
          break;
        }
      }
      
      // If no pipe can handle the load at this slope, use the largest available
      if (recommendedSize === "2" && totalDFU > pipeData["2"] * (slope/2)) {
        const sizes = Object.keys(pipeData);
        recommendedSize = sizes[sizes.length - 1];
      }
      
      // Calculate pipe quantity
      const runLength = parseFloat(document.getElementById('sanLength').value);
      const pipeLen = parseFloat(document.getElementById('sanPipeLength').value);
      const pipeQty = Math.ceil(runLength / pipeLen);
      
      // Calculate accessories with defaults if not provided
      const fixtureCount = parseInt(document.getElementById('wc').value) + 
                          parseInt(document.getElementById('lav').value) + 
                          parseInt(document.getElementById('sink').value) + 
                          parseInt(document.getElementById('shower').value) + 
                          parseInt(document.getElementById('tub').value) + 
                          parseInt(document.getElementById('urinal').value) + 
                          parseInt(document.getElementById('floorDrain').value);
      
      const traps = document.getElementById('traps').value || fixtureCount;
      const vents = document.getElementById('vents').value || fixtureCount;
      const cleanouts = document.getElementById('cleanouts').value || Math.ceil(runLength/30) + Math.ceil(runLength/20);
      const manholes = document.getElementById('sanManholes').value || Math.ceil(runLength/50);
      const fittings = document.getElementById('sanFittings').value || Math.ceil(runLength/10);
      
      // Display results
      const flowUnit = units === 'metric' ? 'L/s' : 'gpm';
      const lengthUnit = units === 'metric' ? 'm' : 'ft';
      const pipeSizeInch = recommendedSize;
      const pipeSizeMM = parseInt(recommendedSize) * 25.4;
      
      document.getElementById('sanitaryOutput').innerHTML = `
        <h3>Sanitary System Calculation Results</h3>
        <strong>Hydraulic Calculations:</strong>
        Total DFU (${code.toUpperCase()}): ${totalDFU}
        Peak Flow: ${flowRate.toFixed(2)} ${flowUnit}
        Recommended Pipe Size: ${pipeSizeInch}" (${pipeSizeMM} mm) ${material.toUpperCase()}
        Pipe Slope: ${slope}%
        
        <strong>Quantity Takeoff:</strong>
        Total Run Length: ${runLength} ${lengthUnit}
        Commercial Pipe Length: ${pipeLen} m
        Pipe Quantity: ${pipeQty} pcs
        
        <strong>Accessories:</strong>
        Traps: ${traps}
        Vents: ${vents}
        Cleanouts: ${cleanouts}
        Manholes: ${manholes}
        Fittings/Elbows: ${fittings}
      `;
      
      // Store results for summary
      window.sanitaryResults = {
        totalDFU,
        flowRate,
        flowUnit,
        pipeSize: pipeSizeInch,
        pipeMaterial: material,
        pipeQty,
        runLength,
        lengthUnit,
        traps,
        vents,
        cleanouts,
        manholes,
        fittings
      };
      
      updateSanitarySummary();
    }
    
    // Calculate storm system
    function calculateStorm() {
      // Validate inputs
      if (!validateInputs('storm')) return;
      
      // Get inputs
      const roofArea = parseFloat(document.getElementById('roofArea').value);
      const pavementArea = parseFloat(document.getElementById('pavementArea').value);
      const C = parseFloat(document.getElementById('coef').value);
      const I = parseFloat(document.getElementById('intensity').value);
      const runLength = parseFloat(document.getElementById('stormLength').value);
      const pipeLen = parseFloat(document.getElementById('stormPipeLength').value);
      const slope = parseFloat(document.getElementById('stormSlope').value);
      const material = document.getElementById('stormPipeMaterial').value;
      
      // Calculate total area and flow
      const totalArea = roofArea + pavementArea;
      
      let Q;
      const units = document.getElementById('units').value;
      
      if (units === 'metric') {
        Q = (C * I * totalArea) / 3600; // L/s
      } else {
        Q = (C * I * totalArea) / 96.23; // gpm (conversion factor)
      }
      
      // Determine pipe size
      const pipeData = pipeSizing.storm[material] || pipeSizing.storm.pvc;
      
      let recommendedSize = "4";
      for (const size in pipeData) {
        if (pipeData[size] * (slope/2) >= Q) {
          recommendedSize = size;
          break;
        }
      }
      
      // If no pipe can handle the load at this slope, use the largest available
      if (recommendedSize === "4" && Q > pipeData["4"] * (slope/2)) {
        const sizes = Object.keys(pipeData);
        recommendedSize = sizes[sizes.length - 1];
      }
      
      // Calculate pipe quantity
      const pipeQty = Math.ceil(runLength / pipeLen);
      
      // Calculate accessories with defaults if not provided
      const downspouts = document.getElementById('downspouts').value || Math.ceil(roofArea/100);
      const catchBasins = document.getElementById('catchBasins').value || Math.ceil(runLength/60);
      const manholes = document.getElementById('stormManholes').value || Math.ceil(runLength/50);
      const fittings = document.getElementById('stormFittings').value || Math.ceil(runLength/10);
      
      // Display results
      const flowUnit = units === 'metric' ? 'L/s' : 'gpm';
      const lengthUnit = units === 'metric' ? 'm' : 'ft';
      const areaUnit = units === 'metric' ? 'm²' : 'ft²';
      const pipeSizeInch = recommendedSize;
      const pipeSizeMM = parseInt(recommendedSize) * 25.4;
      
      document.getElementById('stormOutput').innerHTML = `
        <h3>Storm System Calculation Results</h3>
        <strong>Hydraulic Calculations:</strong>
        Total Drainage Area: ${totalArea.toFixed(1)} ${areaUnit}
        Runoff Coefficient (C): ${C}
        Rainfall Intensity: ${I} ${units === 'metric' ? 'mm/hr' : 'in/hr'}
        Peak Runoff: ${Q.toFixed(2)} ${flowUnit}
        Recommended Pipe Size: ${pipeSizeInch}" (${pipeSizeMM} mm) ${material.toUpperCase()}
        Pipe Slope: ${slope}%
        
        <strong>Quantity Takeoff:</strong>
        Total Run Length: ${runLength} ${lengthUnit}
        Commercial Pipe Length: ${pipeLen} m
        Pipe Quantity: ${pipeQty} pcs
        
        <strong>Accessories:</strong>
        Downspouts: ${downspouts}
        Catch Basins: ${catchBasins}
        Manholes: ${manholes}
        Fittings/Elbows: ${fittings}
      `;
      
      // Store results for summary
      window.stormResults = {
        totalArea,
        areaUnit,
        flowRate: Q,
        flowUnit,
        pipeSize: pipeSizeInch,
        pipeMaterial: material,
        pipeQty,
        runLength,
        lengthUnit,
        downspouts,
        catchBasins,
        manholes,
        fittings
      };
      
      updateStormSummary();
    }
    
    // Update sanitary summary
    function updateSanitarySummary() {
      if (!window.sanitaryResults) return;
      
      const r = window.sanitaryResults;
      document.getElementById('sanitarySummary').innerHTML = `
        <p><strong>Peak Flow:</strong> ${r.flowRate.toFixed(2)} ${r.flowUnit}</p>
        <p><strong>Pipe System:</strong> ${r.pipeQty} sections of ${r.pipeSize}" ${r.pipeMaterial} pipe (${r.runLength} ${r.lengthUnit} total)</p>
        <p><strong>Accessories:</strong> ${r.traps} traps, ${r.vents} vents, ${r.cleanouts} cleanouts, ${r.manholes} manholes, ${r.fittings} fittings</p>
      `;
    }
    
    // Update storm summary
    function updateStormSummary() {
      if (!window.stormResults) return;
      
      const r = window.stormResults;
      document.getElementById('stormSummary').innerHTML = `
        <p><strong>Peak Runoff:</strong> ${r.flowRate.toFixed(2)} ${r.flowUnit}</p>
        <p><strong>Drainage Area:</strong> ${r.totalArea.toFixed(1)} ${r.areaUnit}</p>
        <p><strong>Pipe System:</strong> ${r.pipeQty} sections of ${r.pipeSize}" ${r.pipeMaterial} pipe (${r.runLength} ${r.lengthUnit} total)</p>
        <p><strong>Accessories:</strong> ${r.downspouts} downspouts, ${r.catchBasins} catch basins, ${r.manholes} manholes, ${r.fittings} fittings</p>
      `;
    }
    
    // Helper function to get material cost based on material type and size
    function getMaterialCost(materialType, size) {
      // For pipe materials, we need both material type and size
      if (materialType.includes('Pipe')) {
        const costElement = document.getElementById(materialType.toLowerCase() + 'Cost' + size);
        return costElement ? parseFloat(costElement.value) : getDefaultPipeCost(materialType, size);
      }
      
      // For other materials
      const costElement = document.getElementById(materialType.toLowerCase() + 'Cost');
      return costElement ? parseFloat(costElement.value) : 0;
    }

    // Default pipe costs if specific size is not found
    function getDefaultPipeCost(materialType, size) {
      const baseCosts = {
        'pvcPipe': { '2': 25, '3': 35, '4': 50, '6': 85 },
        'castIronPipe': { '2': 65, '3': 95, '4': 130, '6': 200 },
        'hdpPipe': { '2': 32, '3': 45, '4': 65, '6': 110 },
        'absPipe': { '2': 28, '3': 40, '4': 55, '6': 90 },
        'corrugatedPipe': { '4': 15, '6': 25, '8': 40, '10': 60 },
        'concretePipe': { '4': 55, '6': 85, '8': 120, '10': 180 }
      };
      
      const materialKey = materialType.toLowerCase();
      return baseCosts[materialKey]?.[size] || 0;
    }
    
    // Calculate costs with productivity-based labor
    function calculateCosts() {
      const productivityStandard = document.getElementById('productivityStandard').value;
      const plumberRate = parseFloat(document.getElementById('plumberRate').value);
      const helperRate = parseFloat(document.getElementById('helperRate').value);
      const dailyHours = parseInt(document.getElementById('dailyHours').value);
      const wasteFactor = parseFloat(document.getElementById('wasteFactor').value) / 100;
      const overhead = parseFloat(document.getElementById('overhead').value) / 100;
      const profitMargin = parseFloat(document.getElementById('profitMargin').value) / 100;
      
      const costTable = document.getElementById('costTable');
      
      // Clear existing rows (except header)
      while (costTable.rows.length > 1) {
        costTable.deleteRow(1);
      }
      
      let totalMaterialCost = 0;
      let totalLaborDays = 0;
      let totalLaborCost = 0;
      
      // Get productivity rates
      let productivity = {};
      if (productivityStandard === 'custom') {
        productivity = {
          pvcPipe: parseFloat(document.getElementById('customPipeLaying').value),
          hdpPipe: parseFloat(document.getElementById('customPipeLaying').value),
          absPipe: parseFloat(document.getElementById('customPipeLaying').value),
          castIronPipe: parseFloat(document.getElementById('customPipeLaying').value) * 0.7,
          concretePipe: parseFloat(document.getElementById('customPipeLaying').value) * 0.5,
          corrugatedPipe: parseFloat(document.getElementById('customPipeLaying').value) * 0.8,
          manhole: parseFloat(document.getElementById('customManhole').value),
          catchBasin: parseFloat(document.getElementById('customCatchBasin').value),
          fitting: parseFloat(document.getElementById('customFitting').value),
          trap: parseFloat(document.getElementById('customFitting').value) * 1.2,
          vent: parseFloat(document.getElementById('customFitting').value) * 1.2,
          cleanout: parseFloat(document.getElementById('customFitting').value) * 0.8,
          downspout: parseFloat(document.getElementById('customFitting').value) * 0.4
        };
      } else {
        productivity = productivityRates[productivityStandard];
      }
      
      // Add sanitary system costs if calculated
      if (window.sanitaryResults) {
        const r = window.sanitaryResults;
        const material = r.pipeMaterial;
        
        // Get material costs
        const pipeCost = getMaterialCost(material + 'Pipe', r.pipeSize);
        const fittingCost = parseFloat(document.getElementById('fittingCost').value);
        const trapCost = parseFloat(document.getElementById('trapCost').value);
        const ventCost = parseFloat(document.getElementById('ventCost').value);
        const cleanoutCost = parseFloat(document.getElementById('cleanoutCost').value);
        const manholeCost = parseFloat(document.getElementById('manholeCost').value);
        
        // Pipe cost
        const pipeMaterialCost = pipeCost * r.pipeQty;
        const pipeProductivity = productivity[material.toLowerCase() + 'Pipe'] || productivity.pvcPipe;
        const pipeLaborDays = r.runLength / pipeProductivity;
        const pipeLaborCost = pipeLaborDays * (plumberRate + helperRate * 2) * dailyHours;
        
        addCostRow('Sanitary Pipe', r.pipeQty, formatCurrency(pipeCost), formatCurrency(pipeMaterialCost), pipeLaborDays.toFixed(1), formatCurrency(pipeLaborCost));
        totalMaterialCost += pipeMaterialCost;
        totalLaborDays += pipeLaborDays;
        totalLaborCost += pipeLaborCost;
        
        // Fittings cost
        const fittingMaterialCost = fittingCost * r.fittings;
        const fittingLaborDays = r.fittings / productivity.fitting;
        const fittingLaborCost = fittingLaborDays * (plumberRate + helperRate) * dailyHours;
        
        addCostRow('Sanitary Fittings', r.fittings, formatCurrency(fittingCost), formatCurrency(fittingMaterialCost), fittingLaborDays.toFixed(1), formatCurrency(fittingLaborCost));
        totalMaterialCost += fittingMaterialCost;
        totalLaborDays += fittingLaborDays;
        totalLaborCost += fittingLaborCost;
        
        // Traps cost
        const trapMaterialCost = trapCost * r.traps;
        const trapLaborDays = r.traps / productivity.trap;
        const trapLaborCost = trapLaborDays * (plumberRate + helperRate) * dailyHours;
        
        addCostRow('Traps', r.traps, formatCurrency(trapCost), formatCurrency(trapMaterialCost), trapLaborDays.toFixed(1), formatCurrency(trapLaborCost));
        totalMaterialCost += trapMaterialCost;
        totalLaborDays += trapLaborDays;
        totalLaborCost += trapLaborCost;
        
        // Vents cost
        const ventMaterialCost = ventCost * r.vents;
        const ventLaborDays = r.vents / productivity.vent;
        const ventLaborCost = ventLaborDays * (plumberRate + helperRate) * dailyHours;
        
        addCostRow('Vents', r.vents, formatCurrency(ventCost), formatCurrency(ventMaterialCost), ventLaborDays.toFixed(1), formatCurrency(ventLaborCost));
        totalMaterialCost += ventMaterialCost;
        totalLaborDays += ventLaborDays;
        totalLaborCost += ventLaborCost;
        
        // Cleanouts cost
        const cleanoutMaterialCost = cleanoutCost * r.cleanouts;
        const cleanoutLaborDays = r.cleanouts / productivity.cleanout;
        const cleanoutLaborCost = cleanoutLaborDays * (plumberRate + helperRate) * dailyHours;
        
        addCostRow('Cleanouts', r.cleanouts, formatCurrency(cleanoutCost), formatCurrency(cleanoutMaterialCost), cleanoutLaborDays.toFixed(1), formatCurrency(cleanoutLaborCost));
        totalMaterialCost += cleanoutMaterialCost;
        totalLaborDays += cleanoutLaborDays;
        totalLaborCost += cleanoutLaborCost;
        
        // Manholes cost
        const manholeMaterialCost = manholeCost * r.manholes;
        const manholeLaborDays = r.manholes / productivity.manhole;
        const manholeLaborCost = manholeLaborDays * (plumberRate + helperRate * 2) * dailyHours;
        
        addCostRow('Manholes', r.manholes, formatCurrency(manholeCost), formatCurrency(manholeMaterialCost), manholeLaborDays.toFixed(1), formatCurrency(manholeLaborCost));
        totalMaterialCost += manholeMaterialCost;
        totalLaborDays += manholeLaborDays;
        totalLaborCost += manholeLaborCost;
      }
      
      // Add storm system costs if calculated
      if (window.stormResults) {
        const r = window.stormResults;
        const material = r.pipeMaterial;
        
        // Get material costs
        const pipeCost = getMaterialCost(material + 'Pipe', r.pipeSize);
        const fittingCost = parseFloat(document.getElementById('fittingCost').value);
        const downspoutCost = parseFloat(document.getElementById('downspoutCost').value);
        const catchBasinCost = parseFloat(document.getElementById('catchBasinCost').value);
        const manholeCost = parseFloat(document.getElementById('manholeCost').value);
        
        // Pipe cost
        const pipeMaterialCost = pipeCost * r.pipeQty;
        const pipeProductivity = productivity[material.toLowerCase() + 'Pipe'] || productivity.pvcPipe;
        const pipeLaborDays = r.runLength / pipeProductivity;
        const pipeLaborCost = pipeLaborDays * (plumberRate + helperRate * 2) * dailyHours;
        
        addCostRow('Storm Pipe', r.pipeQty, formatCurrency(pipeCost), formatCurrency(pipeMaterialCost), pipeLaborDays.toFixed(1), formatCurrency(pipeLaborCost));
        totalMaterialCost += pipeMaterialCost;
        totalLaborDays += pipeLaborDays;
        totalLaborCost += pipeLaborCost;
        
        // Fittings cost
        const fittingMaterialCost = fittingCost * r.fittings;
        const fittingLaborDays = r.fittings / productivity.fitting;
        const fittingLaborCost = fittingLaborDays * (plumberRate + helperRate) * dailyHours;
        
        addCostRow('Storm Fittings', r.fittings, formatCurrency(fittingCost), formatCurrency(fittingMaterialCost), fittingLaborDays.toFixed(1), formatCurrency(fittingLaborCost));
        totalMaterialCost += fittingMaterialCost;
        totalLaborDays += fittingLaborDays;
        totalLaborCost += fittingLaborCost;
        
        // Downspouts cost
        const downspoutMaterialCost = downspoutCost * r.downspouts;
        const downspoutLaborDays = r.downspouts / productivity.downspout;
        const downspoutLaborCost = downspoutLaborDays * (plumberRate + helperRate) * dailyHours;
        
        addCostRow('Downspouts', r.downspouts, formatCurrency(downspoutCost), formatCurrency(downspoutMaterialCost), downspoutLaborDays.toFixed(1), formatCurrency(downspoutLaborCost));
        totalMaterialCost += downspoutMaterialCost;
        totalLaborDays += downspoutLaborDays;
        totalLaborCost += downspoutLaborCost;
        
        // Catch basins cost
        const catchBasinMaterialCost = catchBasinCost * r.catchBasins;
        const catchBasinLaborDays = r.catchBasins / productivity.catchBasin;
        const catchBasinLaborCost = catchBasinLaborDays * (plumberRate + helperRate * 2) * dailyHours;
        
        addCostRow('Catch Basins', r.catchBasins, formatCurrency(catchBasinCost), formatCurrency(catchBasinMaterialCost), catchBasinLaborDays.toFixed(1), formatCurrency(catchBasinLaborCost));
        totalMaterialCost += catchBasinMaterialCost;
        totalLaborDays += catchBasinLaborDays;
        totalLaborCost += catchBasinLaborCost;
        
        // Manholes cost
        const manholeMaterialCost = manholeCost * r.manholes;
        const manholeLaborDays = r.manholes / productivity.manhole;
        const manholeLaborCost = manholeLaborDays * (plumberRate + helperRate * 2) * dailyHours;
        
        addCostRow('Storm Manholes', r.manholes, formatCurrency(manholeCost), formatCurrency(manholeMaterialCost), manholeLaborDays.toFixed(1), formatCurrency(manholeLaborCost));
        totalMaterialCost += manholeMaterialCost;
        totalLaborDays += manholeLaborDays;
        totalLaborCost += manholeLaborCost;
      }
      
      // Apply waste factor to materials
      const wasteAmount = totalMaterialCost * wasteFactor;
      const materialWithWaste = totalMaterialCost + wasteAmount;
      
      // Calculate overhead and profit
      const subtotal = materialWithWaste + totalLaborCost;
      const overheadAmount = subtotal * overhead;
      const profitAmount = (subtotal + overheadAmount) * profitMargin;
      
      const totalProjectCost = subtotal + overheadAmount + profitAmount;
      
      // Add summary rows
      addCostRow('Materials Subtotal', '', '', formatCurrency(totalMaterialCost), '', '');
      addCostRow(`Waste (${(wasteFactor*100).toFixed(0)}%)`, '', '', formatCurrency(wasteAmount), '', '');
      addCostRow('Materials Total', '', '', formatCurrency(materialWithWaste), '', '');
      addCostRow('Labor Total', '', '', '', totalLaborDays.toFixed(1), formatCurrency(totalLaborCost));
      addCostRow('Subtotal (Materials + Labor)', '', '', formatCurrency(subtotal), '', '');
      addCostRow(`Overhead (${(overhead*100).toFixed(0)}%)`, '', '', formatCurrency(overheadAmount), '', '');
      addCostRow(`Profit Margin (${(profitMargin*100).toFixed(0)}%)`, '', '', formatCurrency(profitAmount), '', '');
      
      // Add total row
      const totalRow = costTable.insertRow();
      totalRow.innerHTML = `
        <td><strong>TOTAL PROJECT COST</strong></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td><strong>${formatCurrency(totalProjectCost)}</strong></td>
      `;
      
      // Update cost summary
      document.getElementById('costSummary').innerHTML = `
        <p><strong>Total Material Cost:</strong> ${formatCurrency(totalMaterialCost)}</p>
        <p><strong>Total Labor Cost:</strong> ${formatCurrency(totalLaborCost)}</p>
        <p><strong>Total Project Cost:</strong> ${formatCurrency(totalProjectCost)}</p>
        <p><strong>Estimated Work Duration:</strong> ${totalLaborDays.toFixed(1)} days (${(totalLaborDays/5).toFixed(1)} weeks)</p>
        <p><strong>Productivity Standard:</strong> ${productivityStandard === 'philippines' ? 'Philippines (Manual/Low-tech)' : productivityStandard === 'international' ? 'International (Mechanized/High-tech)' : 'Custom'}</p>
      `;
      
      // Store cost results for PDF
      window.costResults = {
        totalMaterialCost,
        totalLaborCost,
        totalProjectCost,
        wasteAmount,
        overheadAmount,
        profitAmount,
        totalLaborDays,
        productivityStandard
      };
    }
    
    // Helper function to add a row to the cost table
    function addCostRow(item, quantity, unitCost, materialCost, laborDays, laborCost) {
      const costTable = document.getElementById('costTable');
      const row = costTable.insertRow();
      row.innerHTML = `
        <td>${item}</td>
        <td>${quantity}</td>
        <td>${unitCost}</td>
        <td>${materialCost}</td>
        <td>${laborDays}</td>
        <td>${laborCost}</td>
        <td>${materialCost && laborCost ? formatCurrency(parseFloat(materialCost.replace(/[^0-9.-]+/g,"")) + parseFloat(laborCost.replace(/[^0-9.-]+/g,""))) : (materialCost || laborCost || '')}</td>
      `;
    }
    
    // Format currency based on selection
    function formatCurrency(amount) {
      if (isNaN(amount)) return '';
      const currency = document.getElementById('currency').value;
      const formatter = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: currency,
        minimumFractionDigits: 2
      });
      return formatter.format(amount);
    }
    
    // Input validation
    function validateInputs(system) {
      let isValid = true;
      
      // Reset errors
      document.querySelectorAll('.validation-error').forEach(error => {
        error.style.display = 'none';
      });
      
      // Project name validation
      const projectName = document.getElementById('projectName').value;
      if (!projectName.trim()) {
        document.getElementById('projectNameError').style.display = 'block';
        isValid = false;
      }
      
      // System-specific validation
      if (system === 'sanitary') {
        const runLength = parseFloat(document.getElementById('sanLength').value);
        if (isNaN(runLength) || runLength <= 0) {
          showValidationError('sanLength', 'Length must be greater than 0');
          isValid = false;
        }
      }
      
      if (system === 'storm') {
        const roofArea = parseFloat(document.getElementById('roofArea').value);
        if (isNaN(roofArea) || roofArea < 0) {
          showValidationError('roofArea', 'Area must be 0 or greater');
          isValid = false;
        }
        
        const intensity = parseFloat(document.getElementById('intensity').value);
        if (isNaN(intensity) || intensity <= 0) {
          showValidationError('intensity', 'Intensity must be greater than 0');
          isValid = false;
        }
      }
      
      return isValid;
    }
    
    function showValidationError(fieldId, message) {
      // Create error element if it doesn't exist
      let errorElement = document.getElementById(fieldId + 'Error');
      if (!errorElement) {
        errorElement = document.createElement('div');
        errorElement.className = 'validation-error';
        errorElement.id = fieldId + 'Error';
        document.getElementById(fieldId).parentNode.appendChild(errorElement);
      }
      
      errorElement.textContent = message;
      errorElement.style.display = 'block';
    }
    
    // Save project data
    function saveProject() {
      const projectData = {
        reportTitle: "Sanitary & Storm Drain Calculator Report",
        projectName: document.getElementById('projectName').value,
        clientName: document.getElementById('clientName').value,
        projectLocation: document.getElementById('projectLocation').value,
        preparedBy: document.getElementById('preparedBy').value,
        currency: document.getElementById('currency').value,
        codeStandard: document.getElementById('codeStandard').value,
        units: document.getElementById('units').value,
        sanitaryResults: window.sanitaryResults,
        stormResults: window.stormResults,
        costResults: window.costResults
      };
      
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectData));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", document.getElementById('projectName').value + "_QTO.json");
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
    }
    
    // Load project data
    function loadProject() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
          const projectData = JSON.parse(event.target.result);
          
          // Populate form fields
          document.getElementById('projectName').value = projectData.projectName || '';
          document.getElementById('clientName').value = projectData.clientName || '';
          document.getElementById('projectLocation').value = projectData.projectLocation || '';
          document.getElementById('preparedBy').value = projectData.preparedBy || '';
          document.getElementById('currency').value = projectData.currency || 'PHP';
          document.getElementById('codeStandard').value = projectData.codeStandard || 'rnpcp';
          document.getElementById('units').value = projectData.units || 'metric';
          updateUnits();
          
          // Restore calculation results
          window.sanitaryResults = projectData.sanitaryResults;
          window.stormResults = projectData.stormResults;
          window.costResults = projectData.costResults;
          
          // Update summaries
          updateSanitarySummary();
          updateStormSummary();
          
          alert('Project loaded successfully!');
        };
        reader.readAsText(file);
      };
      input.click();
    }
    
    // Export to PDF
    function exportToPDF() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Get project information
        const projectName = document.getElementById("projectName")?.value || "Sanitary & Storm Project";
        const clientName = document.getElementById("clientName")?.value || "Client Name";
        const projectLocation = document.getElementById("projectLocation")?.value || "Project Location";
        const preparedBy = document.getElementById("preparedBy")?.value || "Prepared By";
        const date = new Date().toLocaleDateString();

        // Set margins and initial position
        const margin = 15;
        let y = margin;

        // Add header information
        doc.setFontSize(18);
        doc.setFont("helvetica", "bold");
        doc.text("Sanitary & Storm Drain Report", margin, y);
        y += 10;

        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text(`Project: ${projectName}`, margin, y);
        doc.text(`Client: ${clientName}`, 100, y);
        y += 5;
        doc.text(`Location: ${projectLocation}`, margin, y);
        doc.text(`Date: ${date}`, 100, y);
        y += 5;
        doc.text(`Prepared by: ${preparedBy}`, margin, y);
        y += 10;

        // Add system summaries
        if (window.sanitaryResults) {
          const r = window.sanitaryResults;
          doc.setFontSize(11);
          doc.setFont("helvetica", "bold");
          doc.text("Sanitary System Summary", margin, y);
          y += 6;
          doc.setFont("helvetica", "normal");
          doc.text(`Peak Flow: ${r.flowRate.toFixed(2)} ${r.flowUnit}`, margin, y);
          y += 5;
          doc.text(`Pipe: ${r.pipeQty} sections of ${r.pipeSize}" ${r.pipeMaterial} (${r.runLength} ${r.lengthUnit})`, margin, y);
          y += 5;
          doc.text(`Accessories: ${r.traps} traps, ${r.vents} vents, ${r.cleanouts} cleanouts, ${r.manholes} manholes`, margin, y);
          y += 10;
        }
        
        if (window.stormResults) {
          const r = window.stormResults;
          doc.setFontSize(11);
          doc.setFont("helvetica", "bold");
          doc.text("Storm System Summary", margin, y);
          y += 6;
          doc.setFont("helvetica", "normal");
          doc.text(`Peak Runoff: ${r.flowRate.toFixed(2)} ${r.flowUnit}`, margin, y);
          y += 5;
          doc.text(`Drainage Area: ${r.totalArea.toFixed(1)} ${r.areaUnit}`, margin, y);
          y += 5;
          doc.text(`Pipe: ${r.pipeQty} sections of ${r.pipeSize}" ${r.pipeMaterial} (${r.runLength} ${r.lengthUnit})`, margin, y);
          y += 5;
          doc.text(`Accessories: ${r.downspouts} downspouts, ${r.catchBasins} catch basins, ${r.manholes} manholes`, margin, y);
          y += 10;
        }
        
        // Add labor summary if available
        if (window.costResults) {
          const r = window.costResults;
          doc.setFontSize(11);
          doc.setFont("helvetica", "bold");
          doc.text("Labor Summary", margin, y);
          y += 6;
          doc.setFont("helvetica", "normal");
          doc.text(`Work Duration: ${r.totalLaborDays.toFixed(1)} days (${(r.totalLaborDays/5).toFixed(1)} weeks)`, margin, y);
          y += 5;
          doc.text(`Labor Cost: ${formatCurrency(r.totalLaborCost)}`, margin, y);
          y += 5;
          doc.text(`Productivity Standard: ${r.productivityStandard === 'philippines' ? 'Philippines (Manual/Low-tech)' : r.productivityStandard === 'international' ? 'International (Mechanized/High-tech)' : 'Custom'}`, margin, y);
          y += 10;
        }
        
        // Add Bill of Quantities title
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.text("Bill of Quantities", margin, y);
        y += 8;

        // Generate table data
        const tableData = generateBOQTableData();
        
        // Configure and draw the table - ONLY use body data, header is defined separately
        doc.autoTable({
            head: [["Description", "Quantity", "Unit", "Unit Rate", "Amount"]],
            body: tableData,
            startY: y,
            theme: "grid",
            styles: {
                fontSize: 8,
                cellPadding: 3,
                valign: "middle",
                lineColor: [0, 0, 0],
                lineWidth: 0.1
            },
            columnStyles: {
                0: { halign: "left", cellWidth: 70 },
                1: { halign: "center", cellWidth: 25 },
                2: { halign: "center", cellWidth: 20 },
                3: { halign: "right", cellWidth: 30 },
                4: { halign: "right", cellWidth: 35 }
            },
            headStyles: {
                fillColor: [220, 220, 220],
                textColor: 0,
                fontStyle: "bold",
                lineWidth: 0.1
            },
            alternateRowStyles: {
                fillColor: [245, 245, 245]
            },
            didParseCell: function(data) {
                const cellValue = (data.cell.raw || "").toString();
                
                // Style section headers
                if (cellValue === "Materials" || cellValue === "Labor" || cellValue === "Summary") {
                    data.cell.styles.fillColor = [224, 224, 224];
                    data.cell.styles.fontStyle = 'bold';
                    data.cell.styles.halign = 'left';
                    data.cell.colSpan = 5;
                }
                
                // Style totals and subtotals
                if (cellValue.includes("Subtotal") || cellValue.includes("Total") || cellValue.includes("TOTAL") || 
                    cellValue.includes("Overhead") || cellValue.includes("Profit Margin") || 
                    cellValue.includes("Materials + Labor") || cellValue.includes("Waste")) {
                    data.cell.styles.fontStyle = 'bold';
                }
                
                // Style the grand total row
                if (cellValue.includes("TOTAL PROJECT COST")) {
                    data.cell.styles.fillColor = [200, 200, 200];
                    data.cell.styles.fontStyle = 'bold';
                }
            },
            didDrawPage: function(data) {
                doc.setFontSize(8);
                doc.setTextColor(100);
                doc.text(`Page ${data.pageNumber}`, 
                    doc.internal.pageSize.width - 15, 
                    doc.internal.pageSize.height - 10);
            },
            margin: { top: y, left: margin, right: margin }
        });

        // Save the PDF
        doc.save("Sanitary_Storm_Report.pdf");
    } catch (error) {
        alert("Error generating PDF: " + error.message);
        console.error(error);
    }
}

    // Generate BOQ table data for PDF
    function generateBOQTableData() {
      const tableData = [];
      
      // Add sanitary materials
      if (window.sanitaryResults) {
        tableData.push(["Materials", "", "", "", ""]);
        
        const r = window.sanitaryResults;
        const material = r.pipeMaterial;
        
        // Get material costs
        const pipeCost = getMaterialCost(material + 'Pipe', r.pipeSize);
        const fittingCost = parseFloat(document.getElementById('fittingCost').value);
        const trapCost = parseFloat(document.getElementById('trapCost').value);
        const ventCost = parseFloat(document.getElementById('ventCost').value);
        const cleanoutCost = parseFloat(document.getElementById('cleanoutCost').value);
        const manholeCost = parseFloat(document.getElementById('manholeCost').value);
        
        // Pipe
        const pipeMaterialCost = pipeCost * r.pipeQty;
        tableData.push(["Sanitary Pipe", r.pipeQty, "pcs", formatCurrency(pipeCost), formatCurrency(pipeMaterialCost)]);
        
        // Fittings
        const fittingMaterialCost = fittingCost * r.fittings;
        tableData.push(["Sanitary Fittings", r.fittings, "pcs", formatCurrency(fittingCost), formatCurrency(fittingMaterialCost)]);
        
        // Traps
        const trapMaterialCost = trapCost * r.traps;
        tableData.push(["Traps", r.traps, "pcs", formatCurrency(trapCost), formatCurrency(trapMaterialCost)]);
        
        // Vents
        const ventMaterialCost = ventCost * r.vents;
        tableData.push(["Vents", r.vents, "pcs", formatCurrency(ventCost), formatCurrency(ventMaterialCost)]);
        
        // Cleanouts
        const cleanoutMaterialCost = cleanoutCost * r.cleanouts;
        tableData.push(["Cleanouts", r.cleanouts, "pcs", formatCurrency(cleanoutCost), formatCurrency(cleanoutMaterialCost)]);
        
        // Manholes
        const manholeMaterialCost = manholeCost * r.manholes;
        tableData.push(["Manholes", r.manholes, "pcs", formatCurrency(manholeCost), formatCurrency(manholeMaterialCost)]);
      }
      
      // Add storm materials
      if (window.stormResults) {
        const r = window.stormResults;
        const material = r.pipeMaterial;
        
        // Get material costs
        const pipeCost = getMaterialCost(material + 'Pipe', r.pipeSize);
        const fittingCost = parseFloat(document.getElementById('fittingCost').value);
        const downspoutCost = parseFloat(document.getElementById('downspoutCost').value);
        const catchBasinCost = parseFloat(document.getElementById('catchBasinCost').value);
        const manholeCost = parseFloat(document.getElementById('manholeCost').value);
        
        // Pipe
        const pipeMaterialCost = pipeCost * r.pipeQty;
        tableData.push(["Storm Pipe", r.pipeQty, "pcs", formatCurrency(pipeCost), formatCurrency(pipeMaterialCost)]);
        
        // Fittings
        const fittingMaterialCost = fittingCost * r.fittings;
        tableData.push(["Storm Fittings", r.fittings, "pcs", formatCurrency(fittingCost), formatCurrency(fittingMaterialCost)]);
        
        // Downspouts
        const downspoutMaterialCost = downspoutCost * r.downspouts;
        tableData.push(["Downspouts", r.downspouts, "pcs", formatCurrency(downspoutCost), formatCurrency(downspoutMaterialCost)]);
        
        // Catch basins
        const catchBasinMaterialCost = catchBasinCost * r.catchBasins;
        tableData.push(["Catch Basins", r.catchBasins, "pcs", formatCurrency(catchBasinCost), formatCurrency(catchBasinMaterialCost)]);
        
        // Manholes
        const manholeMaterialCost = manholeCost * r.manholes;
        tableData.push(["Storm Manholes", r.manholes, "pcs", formatCurrency(manholeCost), formatCurrency(manholeMaterialCost)]);
      }
      
      // Add cost summary if available
      if (window.costResults) {
        const r = window.costResults;
        const wasteFactor = parseFloat(document.getElementById('wasteFactor').value) / 100;
        const overhead = parseFloat(document.getElementById('overhead').value) / 100;
        const profitMargin = parseFloat(document.getElementById('profitMargin').value) / 100;
        
        const materialWithWaste = r.totalMaterialCost + r.wasteAmount;
        const subtotal = materialWithWaste + r.totalLaborCost;
        
        tableData.push(["Materials Subtotal", "", "", "", formatCurrency(r.totalMaterialCost)]);
        tableData.push([`Waste (${(wasteFactor*100).toFixed(0)}%)`, "", "", "", formatCurrency(r.wasteAmount)]);
        tableData.push(["Materials Total", "", "", "", formatCurrency(materialWithWaste)]);
        tableData.push(["Labor", "", "", "", ""]);
        tableData.push(["Labor Cost", "", "", "", formatCurrency(r.totalLaborCost)]);
        tableData.push(["Summary", "", "", "", ""]);
        tableData.push(["Materials + Labor", "", "", "", formatCurrency(subtotal)]);
        tableData.push([`Overhead (${(overhead*100).toFixed(0)}%)`, "", "", "", formatCurrency(r.overheadAmount)]);
        tableData.push([`Profit Margin (${(profitMargin*100).toFixed(0)}%)`, "", "", "", formatCurrency(r.profitAmount)]);
        tableData.push(["TOTAL PROJECT COST", "", "", "", formatCurrency(r.totalProjectCost)]);
      }
      
      return tableData.length > 0 ? tableData : getFallbackData();
    }
    
    // Fallback data
    function getFallbackData() {
      return [
        ["Materials", "", "", "", ""],
        ["Sanitary Pipe", "9", "pcs", "25.00", "225.00"],
        ["Sanitary Fittings", "5", "pcs", "8.00", "40.00"],
        ["Traps", "7", "pcs", "15.00", "105.00"],
        ["Vents", "7", "pcs", "8.00", "56.00"],
        ["Cleanouts", "3", "pcs", "25.00", "75.00"],
        ["Manholes", "1", "pcs", "500.00", "500.00"],
        ["Storm Pipe", "10", "pcs", "15.00", "150.00"],
        ["Storm Fittings", "6", "pcs", "8.00", "48.00"],
        ["Downspouts", "2", "pcs", "45.00", "90.00"],
        ["Catch Basins", "1", "pcs", "150.00", "150.00"],
        ["Storm Manholes", "1", "pcs", "500.00", "500.00"],
        ["Materials Subtotal", "", "", "", "1949.00"],
        ["Waste (5%)", "", "", "", "97.45"],
        ["Materials Total", "", "", "", "2046.45"],
        ["Labor", "", "", "", ""],
        ["Labor Cost", "", "", "", "4000.00"],
        ["Summary", "", "", "", ""],
        ["Materials + Labor", "", "", "", "6046.45"],
        ["Overhead (15%)", "", "", "", "906.97"],
        ["Profit Margin (10%)", "", "", "", "695.34"],
        ["TOTAL PROJECT COST", "", "", "", "7648.76"]
      ];
    }
    
    // Export to Excel
    function exportToExcel() {
      const wb = XLSX.utils.book_new();
      
      // Project info sheet
      const projectData = [
        ['Project Information', ''],
        ['Project Name', document.getElementById('projectName').value],
        ['Client Name', document.getElementById('clientName').value],
        ['Location', document.getElementById('projectLocation').value],
        ['Prepared By', document.getElementById('preparedBy').value],
        ['Currency', document.getElementById('currency').value],
        ['Code Standard', document.getElementById('codeStandard').value],
        ['Units', document.getElementById('units').value],
        ['', ''],
        ['Generated on', new Date().toLocaleString()]
      ];
      
      const projectWs = XLSX.utils.aoa_to_sheet(projectData);
      XLSX.utils.book_append_sheet(wb, projectWs, "Project Info");
      
      // Sanitary sheet
      if (window.sanitaryResults) {
        const r = window.sanitaryResults;
        const sanitaryData = [
          ['SANITARY SYSTEM QUANTITIES', ''],
          ['Hydraulic Calculations', ''],
          ['Total DFU', r.totalDFU],
          ['Peak Flow', `${r.flowRate.toFixed(2)} ${r.flowUnit}`],
          ['Recommended Pipe Size', `${r.pipeSize}" ${r.pipeMaterial}`],
          ['', ''],
          ['Quantity Takeoff', ''],
          ['Pipe Length', `${r.runLength} ${r.lengthUnit}`],
          ['Pipe Sections', r.pipeQty],
          ['Traps', r.traps],
          ['Vents', r.vents],
          ['Cleanouts', r.cleanouts],
          ['Manholes', r.manholes],
          ['Fittings/Elbows', r.fittings]
        ];
        
        const sanitaryWs = XLSX.utils.aoa_to_sheet(sanitaryData);
        XLSX.utils.book_append_sheet(wb, sanitaryWs, "Sanitary System");
      }
      
      // Storm sheet
      if (window.stormResults) {
        const r = window.stormResults;
        const stormData = [
          ['STORM SYSTEM QUANTITIES', ''],
          ['Hydraulic Calculations', ''],
          ['Total Drainage Area', `${r.totalArea.toFixed(1)} ${r.areaUnit}`],
          ['Peak Runoff', `${r.flowRate.toFixed(2)} ${r.flowUnit}`],
          ['Recommended Pipe Size', `${r.pipeSize}" ${r.pipeMaterial}`],
          ['', ''],
          ['Quantity Takeoff', ''],
          ['Pipe Length', `${r.runLength} ${r.lengthUnit}`],
          ['Pipe Sections', r.pipeQty],
          ['Downspouts', r.downspouts],
          ['Catch Basins', r.catchBasins],
          ['Manholes', r.manholes],
          ['Fittings/Elbows', r.fittings]
        ];
        
        const stormWs = XLSX.utils.aoa_to_sheet(stormData);
        XLSX.utils.book_append_sheet(wb, stormWs, "Storm System");
      }
      
      // Save the Excel file
      XLSX.writeFile(wb, `${document.getElementById('projectName').value}_Report.xlsx`);
    }
    
    // Generate detailed report
    function generateDetailedReport() {
      // Create a comprehensive report with calculations and analysis
      const reportWindow = window.open('', '_blank');
      const projectName = document.getElementById('projectName').value || 'Sanitary & Storm Project';
      
      reportWindow.document.write(`
        <html>
          <head>
            <title>Detailed Report - ${projectName}</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
              h1, h2, h3 { color: #2563eb; }
              .section { margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
              table { width: 100%; border-collapse: collapse; margin: 10px 0; }
              th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd; }
              th { background-color: #f1f5f9; }
              .calculation { background-color: #f8fafc; padding: 10px; border-radius: 4px; margin: 10px 0; }
            </style>
          </head>
          <body>
            <h1>Detailed Sanitary & Storm Drain Analysis</h1>
            <p><strong>Project:</strong> ${projectName}</p>
            <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
            
            ${window.sanitaryResults ? `
            <div class="section">
              <h2>Sanitary System Analysis</h2>
              <h3>Hydraulic Calculations</h3>
              <div class="calculation">
                <p><strong>Total DFU:</strong> ${window.sanitaryResults.totalDFU}</p>
                <p><strong>Peak Flow:</strong> ${window.sanitaryResults.flowRate.toFixed(2)} ${window.sanitaryResults.flowUnit}</p>
                <p><strong>Pipe Sizing:</strong> Based on ${window.sanitaryResults.totalDFU} DFU at ${document.getElementById('sanSlope').value}% slope</p>
                <p><strong>Recommended Pipe:</strong> ${window.sanitaryResults.pipeSize}" ${window.sanitaryResults.pipeMaterial}</p>
              </div>
              
              <h3>Material Quantities</h3>
              <table>
                <tr><th>Item</th><th>Quantity</th><th>Unit</th></tr>
                <tr><td>Pipe</td><td>${window.sanitaryResults.pipeQty}</td><td>sections</td></tr>
                <tr><td>Traps</td><td>${window.sanitaryResults.traps}</td><td>pcs</td></tr>
                <tr><td>Vents</td><td>${window.sanitaryResults.vents}</td><td>pcs</td></tr>
                <tr><td>Cleanouts</td><td>${window.sanitaryResults.cleanouts}</td><td>pcs</td></tr>
                <tr><td>Manholes</td><td>${window.sanitaryResults.manholes}</td><td>pcs</td></tr>
                <tr><td>Fittings</td><td>${window.sanitaryResults.fittings}</td><td>pcs</td></tr>
              </table>
            </div>
            ` : ''}
            
            ${window.stormResults ? `
            <div class="section">
              <h2>Storm System Analysis</h2>
              <h3>Hydraulic Calculations</h3>
              <div class="calculation">
                <p><strong>Drainage Area:</strong> ${window.stormResults.totalArea.toFixed(1)} ${window.stormResults.areaUnit}</p>
                <p><strong>Runoff Coefficient:</strong> ${document.getElementById('coef').value}</p>
                <p><strong>Rainfall Intensity:</strong> ${document.getElementById('intensity').value} ${document.getElementById('units').value === 'metric' ? 'mm/hr' : 'in/hr'}</p>
                <p><strong>Peak Runoff:</strong> ${window.stormResults.flowRate.toFixed(2)} ${window.stormResults.flowUnit}</p>
                <p><strong>Recommended Pipe:</strong> ${window.stormResults.pipeSize}" ${window.stormResults.pipeMaterial}</p>
              </div>
              
              <h3>Material Quantities</h3>
              <table>
                <tr><th>Item</th><th>Quantity</th><th>Unit</th></tr>
                <tr><td>Pipe</td><td>${window.stormResults.pipeQty}</td><td>sections</td></tr>
                <tr><td>Downspouts</td><td>${window.stormResults.downspouts}</td><td>pcs</td></tr>
                <tr><td>Catch Basins</td><td>${window.stormResults.catchBasins}</td><td>pcs</td></tr>
                <tr><td>Manholes</td><td>${window.stormResults.manholes}</td><td>pcs</td></tr>
                <tr><td>Fittings</td><td>${window.stormResults.fittings}</td><td>pcs</td></tr>
              </table>
            </div>
            ` : ''}
            
            ${window.costResults ? `
            <div class="section">
              <h2>Cost Analysis</h2>
              <table>
                <tr><th>Item</th><th>Amount</th></tr>
                <tr><td>Total Material Cost</td><td>${formatCurrency(window.costResults.totalMaterialCost)}</td></tr>
                <tr><td>Total Labor Cost</td><td>${formatCurrency(window.costResults.totalLaborCost)}</td></tr>
                <tr><td>Waste</td><td>${formatCurrency(window.costResults.wasteAmount)}</td></tr>
                <tr><td>Overhead</td><td>${formatCurrency(window.costResults.overheadAmount)}</td></tr>
                <tr><td>Profit Margin</td><td>${formatCurrency(window.costResults.profitAmount)}</td></tr>
                <tr><td><strong>Total Project Cost</strong></td><td><strong>${formatCurrency(window.costResults.totalProjectCost)}</strong></td></tr>
              </table>
              
              <h3>Labor Requirements</h3>
              <p><strong>Estimated Duration:</strong> ${window.costResults.totalLaborDays.toFixed(1)} days (${(window.costResults.totalLaborDays/5).toFixed(1)} weeks)</p>
              <p><strong>Productivity Standard:</strong> ${window.costResults.productivityStandard === 'philippines' ? 'Philippines (Manual/Low-tech)' : window.costResults.productivityStandard === 'international' ? 'International (Mechanized/High-tech)' : 'Custom'}</p>
            </div>
            ` : ''}
            
            <div class="section">
              <h2>Design Standards & Assumptions</h2>
              <p><strong>Plumbing Code:</strong> ${document.getElementById('codeStandard').value.toUpperCase()}</p>
              <p><strong>Units:</strong> ${document.getElementById('units').value}</p>
              <p><strong>Currency:</strong> ${document.getElementById('currency').value}</p>
              <p><strong>Labor Rate:</strong> Plumber: ${formatCurrency(parseFloat(document.getElementById('plumberRate').value || 80))}/hour, Helper: ${formatCurrency(parseFloat(document.getElementById('helperRate').value || 50))}/hour</p>
            </div>
            
            <div class="section">
              <h2>Recommendations</h2>
              <ul>
                <li>Verify all calculations with local building codes and regulations</li>
                <li>Consider soil conditions and groundwater levels for pipe installation</li>
                <li>Include appropriate safety factors for extreme weather conditions</li>
                <li>Consult with a licensed engineer for final design approval</li>
              </ul>
            </div>
          </body>
        </html>
      `);
      
      reportWindow.document.close();
    }
  </script>
</body>
</html>
