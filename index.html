const tabs = document.getElementsByClassName('tab');
for (let i = 0; i < tabs.length; i++) {
tabs[i].classList.remove('active');
}
document.getElementById(tabName + '-tab').classList.add('active');
event.currentTarget.classList.add('active');
}

function addSanitaryPipe() {
const container = document.getElementById('sanitaryPipesContainer');
const pipeDiv = document.createElement('div');
pipeDiv.className = 'pipe-cost-row';
pipeDiv.innerHTML = `
<select class="size-select">
<option value="50">50 mm</option>
<option value="75">75 mm</option>
<option value="100" selected>100 mm</option>
<option value="150">150 mm</option>
<option value="200">200 mm</option>
</select>
<input type="number" class="cost-input" placeholder="Unit Cost" min="0" step="0.01" value="1500">
<button class="remove-pipe-btn" onclick="this.parentElement.remove()">Remove</button>
`;
container.appendChild(pipeDiv);
}

function addStormPipe() {
const container = document.getElementById('stormPipesContainer');
const pipeDiv = document.createElement('div');
pipeDiv.className = 'pipe-cost-row';
pipeDiv.innerHTML = `
<select class="size-select">
<option value="75">75 mm</option>
<option value="100" selected>100 mm</option>
<option value="150">150 mm</option>
<option value="200">200 mm</option>
<option value="250">250 mm</option>
</select>
<input type="number" class="cost-input" placeholder="Unit Cost" min="0" step="0.01" value="1200">
<button class="remove-pipe-btn" onclick="this.parentElement.remove()">Remove</button>
`;
container.appendChild(pipeDiv);
}

function formatNumber(num, decimalPlaces = 2) {
if (typeof num !== 'number' || isNaN(num)) return '';
const factor = Math.pow(10, decimalPlaces);
let roundedNum = Math.round((num + Number.EPSILON) * factor) / factor;
let str = roundedNum.toFixed(decimalPlaces).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
str = str.replace(/[\+\u00B1]/g, '');
return str;
}

function formatCurrency(num) {
if (typeof num !== 'number' || isNaN(num)) return '';
const currency = document.getElementById('currency').value;
let symbol = '';
switch (currency) {
case 'PHP': symbol = '₱'; break;
case 'USD': symbol = '$'; break;
case 'EUR': symbol = '€'; break;
case 'JPY': symbol = '¥'; break;
}
return symbol + formatNumber(num, 2);
}

function formatCurrencyForPDF(num) {
if (typeof num !== 'number' || isNaN(num)) return '';
const currency = document.getElementById('currency').value;
let symbol = '';
switch (currency) {
case 'PHP': symbol = 'PHP '; break;
case 'USD': symbol = '$ '; break;
case 'EUR': symbol = 'EUR '; break;
case 'JPY': symbol = 'JPY '; break;
}
return symbol + formatNumber(num, 2);
}

function calculateSanitary() {
const wc = parseInt(document.getElementById('wc').value) || 0;
const lav = parseInt(document.getElementById('lav').value) || 0;
const sink = parseInt(document.getElementById('sink').value) || 0;
const shower = parseInt(document.getElementById('shower').value) || 0;
const tub = parseInt(document.getElementById('tub').value) || 0;
const urinal = parseInt(document.getElementById('urinal').value) || 0;
const floorDrain = parseInt(document.getElementById('floorDrain').value) || 0;
const sanLength = parseFloat(document.getElementById('sanLength').value) || 0;
const sanPipeLength = parseFloat(document.getElementById('sanPipeLength').value) || 6;

const fixtureUnits = { wc: 6, lav: 1, sink: 2, shower: 2, tub: 2, urinal: 4, floorDrain: 2 };

let totalFixtureUnits = (wc * fixtureUnits.wc) + (lav * fixtureUnits.lav) + (sink * fixtureUnits.sink) + 
(shower * fixtureUnits.shower) + (tub * fixtureUnits.tub) + (urinal * fixtureUnits.urinal) + 
(floorDrain * fixtureUnits.floorDrain);

const drainageLoad = totalFixtureUnits * 0.8;

let pipeSize;
if (totalFixtureUnits <= 21) pipeSize = 50;
else if (totalFixtureUnits <= 40) pipeSize = 75;
else if (totalFixtureUnits <= 180) pipeSize = 100;
else if (totalFixtureUnits <= 800) pipeSize = 150;
else pipeSize = 200;

const pipeQuantity = Math.ceil(sanLength / sanPipeLength);
const traps = wc + lav + sink + shower + tub + urinal + floorDrain;
const vents = wc + lav + sink + shower + tub + urinal;
const cleanouts = Math.ceil(sanLength / 30);
const sanManholes = Math.ceil(sanLength / 50);
const sanFittings = Math.ceil(sanLength / 10);

sanitaryResults = {
totalFixtureUnits, drainageLoad, pipeSize, pipeQuantity, pipeLength: sanLength,
traps, vents, cleanouts, manholes: sanManholes, fittings: sanFittings
};

const output = document.getElementById('sanitaryOutput');
output.innerHTML = `
<h3>Sanitary System Results</h3>
<p><strong>Total Fixture Units:</strong> ${formatNumber(totalFixtureUnits, 0)}</p>
<p><strong>Drainage Load:</strong> ${formatNumber(drainageLoad, 2)} L/s</p>
<p><strong>Recommended Pipe Size:</strong> ${pipeSize} mm</p>
<p><strong>Pipe Quantity:</strong> ${pipeQuantity} pieces (${sanPipeLength} m each)</p>
<p><strong>Accessories:</strong></p>
<ul>
<li>Traps: ${traps}</li>
<li>Vents: ${vents}</li>
<li>Cleanouts: ${cleanouts}</li>
<li>Manholes: ${sanManholes}</li>
<li>Fittings/Elbows: ${sanFittings}</li>
</ul>
`;
output.style.display = 'block';
}

function calculateStorm() {
const roofArea = parseFloat(document.getElementById('roofArea').value) || 0;
const pavementArea = parseFloat(document.getElementById('pavementArea').value) || 0;
const coef = parseFloat(document.getElementById('coef').value) || 0.9;
const intensity = parseFloat(document.getElementById('intensity').value) || 50;
const stormLength = parseFloat(document.getElementById('stormLength').value) || 0;
const stormPipeLength = parseFloat(document.getElementById('stormPipeLength').value) || 6;

const totalArea = roofArea + pavementArea;
const runoff = coef * intensity * totalArea / 360;

let pipeSize;
if (runoff <= 1.2) pipeSize = 75;
else if (runoff <= 2.5) pipeSize = 100;
else if (runoff <= 5.3) pipeSize = 150;
else if (runoff <= 15.0) pipeSize = 200;
else pipeSize = 250;

const pipeQuantity = Math.ceil(stormLength / stormPipeLength);
const downspouts = Math.ceil(roofArea / 100);
const catchBasins = Math.ceil(stormLength / 60);
const stormManholes = Math.ceil(stormLength / 50);
const stormFittings = Math.ceil(stormLength / 10);

stormResults = {
totalArea, runoff, pipeSize, pipeQuantity, pipeLength: stormLength,
downspouts, catchBasins, manholes: stormManholes, fittings: stormFittings
};

const output = document.getElementById('stormOutput');
output.innerHTML = `
<h3>Storm Drain System Results</h3>
<p><strong>Total Area:</strong> ${formatNumber(totalArea, 2)} m²</p>
<p><strong>Runoff Coefficient:</strong> ${formatNumber(coef, 2)}</p>
<p><strong>Rainfall Intensity:</strong> ${formatNumber(intensity, 0)} mm/hr</p>
<p><strong>Runoff:</strong> ${formatNumber(runoff, 2)} L/s</p>
<p><strong>Recommended Pipe Size:</strong> ${pipeSize} mm</p>
<p><strong>Pipe Quantity:</strong> ${pipeQuantity} pieces (${stormPipeLength} m each)</p>
<p><strong>Accessories:</strong></p>
<ul>
<li>Downspouts: ${downspouts}</li>
<li>Catch Basins: ${catchBasins}</li>
<li>Manholes: ${stormManholes}</li>
<li>Fittings/Elbows: ${stormFittings}</li>
</ul>
`;
output.style.display = 'block';
}

function calculateCosts() {
if (!sanitaryResults || !stormResults) {
alert('Please calculate Sanitary and Storm Systems first.');
return;
}

const plumberRate = parseFloat(document.getElementById('plumberRate').value) || 80;
const helperRate = parseFloat(document.getElementById('helperRate').value) || 50;
const dailyHours = parseFloat(document.getElementById('dailyHours').value) || 8;
const wasteFactor = parseFloat(document.getElementById('wasteFactor').value) || 5;
const overhead = parseFloat(document.getElementById('overhead').value) || 15;
const profitMargin = parseFloat(document.getElementById('profitMargin').value) || 10;

const trapCost = parseFloat(document.getElementById('trapCost').value) || 0;
const ventCost = parseFloat(document.getElementById('ventCost').value) || 0;
const cleanoutCost = parseFloat(document.getElementById('cleanoutCost').value) || 0;
const manholeCost = parseFloat(document.getElementById('manholeCost').value) || 0;
const fittingCost = parseFloat(document.getElementById('fittingCost').value) || 0;
const downspoutCost = parseFloat(document.getElementById('downspoutCost').value) || 0;
const catchBasinCost = parseFloat(document.getElementById('catchBasinCost').value) || 0;

let sanitaryPipeCost = 0;
const sanitaryPipes = document.getElementById('sanitaryPipesContainer').getElementsByClassName('pipe-cost-row');
for (let pipe of sanitaryPipes) {
const size = parseFloat(pipe.querySelector('.size-select').value);
const cost = parseFloat(pipe.querySelector('.cost-input').value) || 0;
if (size === sanitaryResults.pipeSize) {
sanitaryPipeCost = cost * sanitaryResults.pipeQuantity;
break;
}
}

let stormPipeCost = 0;
const stormPipes = document.getElementById('stormPipesContainer').getElementsByClassName('pipe-cost-row');
for (let pipe of stormPipes) {
const size = parseFloat(pipe.querySelector('.size-select').value);
const cost = parseFloat(pipe.querySelector('.cost-input').value) || 0;
if (size === stormResults.pipeSize) {
stormPipeCost = cost * stormResults.pipeQuantity;
break;
}
}

const sanitaryMaterialCost = sanitaryPipeCost + (sanitaryResults.traps * trapCost) + 
(sanitaryResults.vents * ventCost) + (sanitaryResults.cleanouts * cleanoutCost) + 
(sanitaryResults.manholes * manholeCost) + (sanitaryResults.fittings * fittingCost);

const stormMaterialCost = stormPipeCost + (stormResults.downspouts * downspoutCost) + 
(stormResults.catchBasins * catchBasinCost) + (stormResults.manholes * manholeCost) + 
(stormResults.fittings * fittingCost);

const totalMaterialCost = sanitaryMaterialCost + stormMaterialCost;

const totalPipeLength = sanitaryResults.pipeLength + stormResults.pipeLength;
const totalManholes = sanitaryResults.manholes + stormResults.manholes;
const totalFittings = sanitaryResults.fittings + stormResults.fittings;

const pipeLayingDays = totalPipeLength / 10;
const manholeDays = totalManholes / 0.8;
const fittingDays = totalFittings / 20;
const totalLaborDays = pipeLayingDays + manholeDays + fittingDays;
const totalLaborHours = totalLaborDays * dailyHours;

const plumberHours = totalLaborHours * 0.7;
const helperHours = totalLaborHours * 0.3;
const plumberCost = plumberHours * plumberRate;
const helperCost = helperHours * helperRate;
const totalLaborCost = plumberCost + helperCost;

const costWithWaste = totalMaterialCost * (1 + wasteFactor/100);
const costWithOverhead = (costWithWaste + totalLaborCost) * (1 + overhead/100);
const totalCost = costWithOverhead * (1 + profitMargin/100);

costResults = {
sanitaryMaterialCost, stormMaterialCost, totalMaterialCost, totalLaborCost, totalCost,
sanitaryPipeCost, stormPipeCost,
sanitaryTrapsCost: sanitaryResults.traps * trapCost,
sanitaryVentsCost: sanitaryResults.vents * ventCost,
sanitaryCleanoutsCost: sanitaryResults.cleanouts * cleanoutCost,
sanitaryManholesCost: sanitaryResults.manholes * manholeCost,
sanitaryFittingsCost: sanitaryResults.fittings * fittingCost,
stormDownspoutsCost: stormResults.downspouts * downspoutCost,
stormCatchBasinsCost: stormResults.catchBasins * catchBasinCost,
stormManholesCost: stormResults.manholes * manholeCost,
stormFittingsCost: stormResults.fittings * fittingCost
};

laborResults = {
totalLaborHours, plumberHours, helperHours, totalManDays: totalLaborDays,
plumberCost, helperCost, totalLaborCost
};

const output = document.getElementById('costsOutput');
output.innerHTML = `
<h3>Cost & Labor Results</h3>
<p><strong>Total Material Cost:</strong> ${formatCurrency(totalMaterialCost)}</p>
<p><strong>Total Labor Cost:</strong> ${formatCurrency(totalLaborCost)}</p>
<p><strong>Total Cost (with waste, overhead & profit):</strong> ${formatCurrency(totalCost)}</p>
<p><strong>Labor Requirements:</strong></p>
<ul>
<li>Total Labor Hours: ${formatNumber(totalLaborHours, 1)} hours</li>
<li>Plumber Hours: ${formatNumber(plumberHours, 1)} hours</li>
<li>Helper Hours: ${formatNumber(helperHours, 1)} hours</li>
<li>Equivalent Man-Days: ${formatNumber(totalLaborDays, 1)} days</li>
</ul>
`;
output.style.display = 'block';
}

function generateSummary() {
if (!sanitaryResults || !stormResults || !costResults) {
alert('Please complete all calculations first.');
return;
}

document.getElementById('projectSummaryCard').style.display = 'block';
document.getElementById('sanitarySummaryCard').style.display = 'block';
document.getElementById('stormSummaryCard').style.display = 'block';
document.getElementById('costBreakdownCard').style.display = 'block';
document.getElementById('laborSummaryCard').style.display = 'block';

document.getElementById('projectSummary').innerHTML = `
<p><strong>Project Name:</strong> ${document.getElementById('projectName').value}</p>
<p><strong>Client:</strong> ${document.getElementById('clientName').value}</p>
<p><strong>Location:</strong> ${document.getElementById('projectLocation').value}</p>
<p><strong>Prepared By:</strong> ${document.getElementById('preparedBy').value}</p>
<p><strong>Currency:</strong> ${document.getElementById('currency').value}</p>
`;

document.getElementById('sanitarySummary').innerHTML = `
<p><strong>Total Fixture Units:</strong> ${formatNumber(sanitaryResults.totalFixtureUnits, 0)}</p>
<p><strong>Drainage Load:</strong> ${formatNumber(sanitaryResults.drainageLoad, 2)} L/s</p>
<p><strong>Pipe Size:</strong> ${sanitaryResults.pipeSize} mm</p>
<p><strong>Pipe Quantity:</strong> ${sanitaryResults.pipeQuantity} pieces</p>
<p><strong>Pipe Length:</strong> ${formatNumber(sanitaryResults.pipeLength, 1)} m</p>
`;

document.getElementById('stormSummary').innerHTML = `
<p><strong>Total Area:</strong> ${formatNumber(stormResults.totalArea, 2)} m²</p>
<p><strong>Runoff:</strong> ${formatNumber(stormResults.runoff, 2)} L/s</p>
<p><strong>Pipe Size:</strong> ${stormResults.pipeSize} mm</p>
<p><strong>Pipe Quantity:</strong> ${stormResults.pipeQuantity} pieces</p>
<p><strong>Pipe Length:</strong> ${formatNumber(stormResults.pipeLength, 1)} m</p>
`;

const costBreakdown = document.getElementById('costBreakdown').getElementsByTagName('tbody')[0];
costBreakdown.innerHTML = '';

addCostRow(costBreakdown, 'Sanitary Pipes', sanitaryResults.pipeQuantity, 'pcs', 
costResults.sanitaryPipeCost / sanitaryResults.pipeQuantity, costResults.sanitaryPipeCost);
addCostRow(costBreakdown, 'Sanitary Traps', sanitaryResults.traps, 'pcs', 
parseFloat(document.getElementById('trapCost').value), costResults.sanitaryTrapsCost);
addCostRow(costBreakdown, 'Sanitary Vents', sanitaryResults.vents, 'pcs', 
parseFloat(document.getElementById('ventCost').value), costResults.sanitaryVentsCost);
addCostRow(costBreakdown, 'Sanitary Cleanouts', sanitaryResults.cleanouts, 'pcs', 
parseFloat(document.getElementById('cleanoutCost').value), costResults.sanitaryCleanoutsCost);
addCostRow(costBreakdown, 'Sanitary Manholes', sanitaryResults.manholes, 'pcs', 
parseFloat(document.getElementById('manholeCost').value), costResults.sanitaryManholesCost);
addCostRow(costBreakdown, 'Sanitary Fittings', sanitaryResults.fittings, 'pcs', 
parseFloat(document.getElementById('fittingCost').value), costResults.sanitaryFittingsCost);

addCostRow(costBreakdown, 'Storm Pipes', stormResults.pipeQuantity, 'pcs', 
costResults.stormPipeCost / stormResults.pipeQuantity, costResults.stormPipeCost);
addCostRow(costBreakdown, 'Downspouts', stormResults.downspouts, 'pcs', 
parseFloat(document.getElementById('downspoutCost').value), costResults.stormDownspoutsCost);
addCostRow(costBreakdown, 'Catch Basins', stormResults.catchBasins, 'pcs', 
parseFloat(document.getElementById('catchBasinCost').value), costResults.stormCatchBasinsCost);
addCostRow(costBreakdown, 'Storm Manholes', stormResults.manholes, 'pcs', 
parseFloat(document.getElementById('manholeCost').value), costResults.stormManholesCost);
addCostRow(costBreakdown, 'Storm Fittings', stormResults.fittings, 'pcs', 
parseFloat(document.getElementById('fittingCost').value), costResults.stormFittingsCost);

addCostRow(costBreakdown, 'Subtotal - Materials', '', '', '', costResults.totalMaterialCost);
addCostRow(costBreakdown, 'Labor Cost', '', '', '', costResults.totalLaborCost);

const wasteFactor = parseFloat(document.getElementById('wasteFactor').value);
const overhead = parseFloat(document.getElementById('overhead').value);
const profitMargin = parseFloat(document.getElementById('profitMargin').value);

addCostRow(costBreakdown, `Waste Factor (${wasteFactor}%)`, '', '', '',
costResults.totalMaterialCost * (wasteFactor/100));
addCostRow(costBreakdown, `Overhead (${overhead}%)`, '', '', '',
(costResults.totalMaterialCost * (1 + wasteFactor/100) + costResults.totalLaborCost) * (overhead/100));
addCostRow(costBreakdown, `Profit Margin (${profitMargin}%)`, '', '', '',
costResults.totalCost - ((costResults.totalMaterialCost * (1 + wasteFactor/100) + 
costResults.totalLaborCost) * (1 + overhead/100)));
addCostRow(costBreakdown, 'TOTAL PROJECT COST', '', '', '', costResults.totalCost, true);

document.getElementById('laborSummary').innerHTML = `
<p><strong>Total Labor Hours:</strong> ${formatNumber(laborResults.totalLaborHours, 1)} hours</p>
<p><strong>Plumber Hours:</strong> ${formatNumber(laborResults.plumberHours, 1)} hours</p>
<p><strong>Helper Hours:</strong> ${formatNumber(laborResults.helperHours, 1)} hours</p>
<p><strong>Equivalent Man-Days:</strong> ${formatNumber(laborResults.totalManDays, 1)} days</p>
<p><strong>Total Labor Cost:</strong> ${formatCurrency(laborResults.totalLaborCost)}</p>
`;
}

function addCostRow(table, item, quantity, unit, unitCost, totalCost, isTotal = false) {
const row = table.insertRow();
if (isTotal) row.className = 'grey-header';
row.insertCell(0).textContent = item;
row.insertCell(1).textContent = quantity ? `${formatNumber(quantity, 0)} ${unit}` : '';
row.insertCell(2).textContent = unitCost ? formatCurrency(unitCost) : '';
row.insertCell(3).textContent = formatCurrency(totalCost);
}

function extractBOQDataFromDisplay() {
if (!costResults) return getFallbackData();
const r = costResults;
const wasteFactor = parseFloat(document.getElementById('wasteFactor').value) || 5;
const overhead = parseFloat(document.getElementById('overhead').value) || 15;
const profitMargin = parseFloat(document.getElementById('profitMargin').value) || 10;

const wasteAmount = r.totalMaterialCost * (wasteFactor / 100);
const materialWithWaste = r.totalMaterialCost + wasteAmount;
const subtotal = materialWithWaste + r.totalLaborCost;
const overheadAmount = subtotal * (overhead / 100);
const profitAmount = (subtotal + overheadAmount) * (profitMargin / 100);
const totalProjectCost = subtotal + overheadAmount + profitAmount;

return [
["Description", "Quantity", "Unit", "Unit Rate", "Amount"],
["Materials", "", "", "", ""],
["Sanitary Pipes", sanitaryResults.pipeQuantity.toString(), "pcs",
formatCurrencyForPDF(sanitaryResults.pipeQuantity > 0 ? r.sanitaryPipeCost / sanitaryResults.pipeQuantity : 0),
formatCurrencyForPDF(r.sanitaryPipeCost)],
["Sanitary Traps", sanitaryResults.traps.toString(), "pcs",
formatCurrencyForPDF(parseFloat(document.getElementById('trapCost').value)),
formatCurrencyForPDF(r.sanitaryTrapsCost)],
["Sanitary Vents", sanitaryResults.vents.toString(), "pcs",
formatCurrencyForPDF(parseFloat(document.getElementById('ventCost').value)),
formatCurrencyForPDF(r.sanitaryVentsCost)],
["Sanitary Cleanouts", sanitaryResults.cleanouts.toString(), "pcs",
formatCurrencyForPDF(parseFloat(document.getElementById('cleanoutCost').value)),
formatCurrencyForPDF(r.sanitaryCleanoutsCost)],
["Sanitary Manholes", sanitaryResults.manholes.toString(), "pcs",
formatCurrencyForPDF(parseFloat(document.getElementById('manholeCost').value)),
formatCurrencyForPDF(r.sanitaryManholesCost)],
["Sanitary Fittings", sanitaryResults.fittings.toString(), "pcs",
formatCurrencyForPDF(parseFloat(document.getElementById('fittingCost').value)),
formatCurrencyForPDF(r.sanitaryFittingsCost)],
["Storm Pipes", stormResults.pipeQuantity.toString(), "pcs",
formatCurrencyForPDF(stormResults.pipeQuantity > 0 ? r.stormPipeCost / stormResults.pipeQuantity : 0),
formatCurrencyForPDF(r.stormPipeCost)],
["Downspouts", stormResults.downspouts.toString(), "pcs",
formatCurrencyForPDF(parseFloat(document.getElementById('downspoutCost').value)),
formatCurrencyForPDF(r.stormDownspoutsCost)],
["Catch Basins", stormResults.catchBasins.toString(), "pcs",
formatCurrencyForPDF(parseFloat(document.getElementById('catchBasinCost').value)),
formatCurrencyForPDF(r.stormCatchBasinsCost)],
["Storm Manholes", stormResults.manholes.toString(), "pcs",
formatCurrencyForPDF(parseFloat(document.getElementById('manholeCost').value)),
formatCurrencyForPDF(r.stormManholesCost)],
["Storm Fittings", stormResults.fittings.toString(), "pcs",
formatCurrencyForPDF(parseFloat(document.getElementById('fittingCost').value)),
formatCurrencyForPDF(r.stormFittingsCost)],
["Materials Subtotal", "", "", "", formatCurrencyForPDF(r.totalMaterialCost)],
["Waste (" + wasteFactor + "%)", "", "", "", formatCurrencyForPDF(wasteAmount)],
["Materials Total", "", "", "", formatCurrencyForPDF(materialWithWaste)],
["Labor", "", "", "", ""],
["Plumber", laborResults.plumberHours.toFixed(1), "hours",
formatCurrencyForPDF(parseFloat(document.getElementById('plumberRate').value)),
formatCurrencyForPDF(laborResults.plumberCost)],
["Helper", laborResults.helperHours.toFixed(1), "hours",
formatCurrencyForPDF(parseFloat(document.getElementById('helperRate').value)),
formatCurrencyForPDF(laborResults.helperCost)],
["Labor Total", "", "", "", formatCurrencyForPDF(r.totalLaborCost)],
["Summary", "", "", "", ""],
["Materials + Labor", "", "", "", formatCurrencyForPDF(subtotal)],
["Overhead (" + overhead + "%)", "", "", "", formatCurrencyForPDF(overheadAmount)],
["Profit Margin (" + profitMargin + "%)", "", "", "", formatCurrencyForPDF(profitAmount)],
["TOTAL PROJECT COST", "", "", "", formatCurrencyForPDF(totalProjectCost)]
];
}

function getFallbackData() {
return [["Description", "Quantity", "Unit", "Unit Rate", "Amount"]];
}

function exportToPDF() {
try {
const { jsPDF } = window.jspdf;
const doc = new jsPDF();

const projectName = document.getElementById("projectName")?.value || "Sanitary & Storm Drain Project";
const clientName = document.getElementById("clientName")?.value || "John Dela Cruz";
const projectLocation = document.getElementById("projectLocation")?.value || "Manila, Philippines";
const preparedBy = document.getElementById("preparedBy")?.value || "Maria Santos, Civil Engineer";
const date = new Date().toLocaleDateString();

const boqData = extractBOQDataFromDisplay();
const tableBody = boqData.filter(row =>
!(row[0] === 'Description' && row[1] === 'Quantity' && row[2] === 'Unit' && row[3] === 'Unit Rate' && row[4] === 'Amount')
);

const margin = 15;
let y = margin;

doc.setFontSize(18);
doc.setFont("helvetica", "bold");
doc.text("Sanitary & Storm Drain Report", margin, y);
y += 10;

doc.setFontSize(10);
doc.setFont("helvetica", "normal");
doc.text(`Project: ${projectName}`, margin, y);
doc.text(`Client: ${clientName}`, 100, y);
y += 5;
doc.text(`Location: ${projectLocation}`, margin, y);
doc.text(`Date: ${date}`, 100, y);
y += 5;
doc.text(`Prepared by: ${preparedBy}`, margin, y);
y += 10;

const sanLength = document.getElementById('sanLength').value || '50';
const stormLength = document.getElementById('stormLength').value || '60';
doc.setFontSize(11);
doc.text(`Sanitary Pipe Length: ${sanLength}m`, margin, y);
y += 5;
doc.text(`Storm Pipe Length: ${stormLength}m`, margin, y);
y += 10;

doc.setFontSize(14);
doc.setFont("helvetica", "bold");
doc.text("Bill of Quantities", margin, y);
y += 8;

doc.autoTable({
head: [["Description", "Quantity", "Unit", "Unit Rate", "Amount"]],
body: tableBody,
startY: y,
theme: "grid",
styles: {
fontSize: 9,
cellPadding: 3,
valign: "middle",
lineColor: [0, 0, 0],
lineWidth: 0.1,
overflow: 'linebreak',
cellWidth: 'wrap'
},
columnStyles: {
0: { halign: "left", cellWidth: 65 },
1: { halign: "center", cellWidth: 22 },
  2: { halign: "center", cellWidth: 18 },
3: { halign: "right", cellWidth: 38 },
4: { halign: "right", cellWidth: 38 }
},
headStyles: {
fillColor: [220, 220, 220],
textColor: 0,
fontStyle: "bold",
lineWidth: 0.1
},
alternateRowStyles: {
fillColor: [245, 245, 245]
},
didParseCell: function(data) {
const cellValue = (data.cell.raw || "").toString();
if (cellValue === "Materials" || cellValue === "Labor" || cellValue === "Summary") {
data.cell.styles.fillColor = [224, 224, 224];
data.cell.styles.fontStyle = 'bold';
data.cell.styles.halign = 'left';
data.cell.colSpan = 5;
}
if (cellValue.includes("Subtotal") || cellValue.includes("Total") || cellValue.includes("TOTAL") ||
cellValue.includes("Overhead") || cellValue.includes("Profit Margin") ||
cellValue.includes("Materials + Labor") || cellValue.includes("Waste")) {
data.cell.styles.fontStyle = 'bold';
}
if (cellValue.includes("TOTAL PROJECT COST")) {
data.cell.styles.fillColor = [200, 200, 200];
data.cell.styles.fontStyle = 'bold';
}
},
didDrawPage: function(data) {
doc.setFontSize(8);
doc.setTextColor(100);
doc.text(`Page ${data.pageNumber}`, doc.internal.pageSize.width - 15, doc.internal.pageSize.height - 10);
},
margin: { top: y, left: margin, right: margin }
});

let finalY = doc.autoTable.previous.finalY;
finalY += 10;
doc.setFontSize(14);
doc.setFont("helvetica", "bold");
doc.text('Labor Requirements Summary', margin, finalY);

const laborData = [
['Total Labor Hours:', `${formatNumber(laborResults.totalLaborHours, 1)} hrs`],
['Plumber Hours:', `${formatNumber(laborResults.plumberHours, 1)} hrs`],
['Helper Hours:', `${formatNumber(laborResults.helperHours, 1)} hrs`],
['Equivalent Man-Days:', `${formatNumber(laborResults.totalManDays, 1)} days`],
['Total Labor Cost:', `${formatCurrencyForPDF(laborResults.totalLaborCost)}`]
];

doc.autoTable({
startY: finalY + 5,
head: [],
body: laborData,
theme: 'plain',
styles: {
fontSize: 10,
cellPadding: 3
},
columnStyles: {
0: { fontStyle: 'bold', cellWidth: 70 },
1: { halign: 'right', cellWidth: 50 }
},
margin: { left: margin, right: margin }
});

doc.save(`${projectName.replace(/[^a-z0-9]/gi, '_')}_Report.pdf`);
} catch (error) {
alert("Error generating PDF: " + error.message);
console.error(error);
}
}

function exportToExcel() {
if (!sanitaryResults || !stormResults || !costResults) {
alert('Please run all calculations before exporting.');
return;
}

const wb = XLSX.utils.book_new();
const projectData = [
['Sanitary & Storm Drain System Report'],
[],
['Project Information'],
['Project Name:', document.getElementById('projectName').value],
['Client:', document.getElementById('clientName').value],
['Location:', document.getElementById('projectLocation').value],
['Prepared By:', document.getElementById('preparedBy').value],
['Currency:', document.getElementById('currency').value],
['Date:', new Date().toLocaleDateString()],
[],
['Sanitary System Summary'],
['Metric', 'Value', 'Unit'],
['Total Fixture Units', sanitaryResults.totalFixtureUnits, 'FU'],
['Drainage Load', sanitaryResults.drainageLoad, 'L/s'],
['Pipe Size', sanitaryResults.pipeSize, 'mm'],
['Pipe Quantity', sanitaryResults.pipeQuantity, 'pcs'],
['Pipe Length', sanitaryResults.pipeLength, 'm'],
['Traps', sanitaryResults.traps, 'pcs'],
['Vents', sanitaryResults.vents, 'pcs'],
['Cleanouts', sanitaryResults.cleanouts, 'pcs'],
['Manholes', sanitaryResults.manholes, 'pcs'],
['Fittings', sanitaryResults.fittings, 'pcs'],
[],
['Storm Drain System Summary'],
['Metric', 'Value', 'Unit'],
['Total Area', stormResults.totalArea, 'm²'],
['Runoff', stormResults.runoff, 'L/s'],
['Pipe Size', stormResults.pipeSize, 'mm'],
['Pipe Quantity', stormResults.pipeQuantity, 'pcs'],
['Pipe Length', stormResults.pipeLength, 'm'],
['Downspouts', stormResults.downspouts, 'pcs'],
['Catch Basins', stormResults.catchBasins, 'pcs'],
['Manholes', stormResults.manholes, 'pcs'],
['Fittings', stormResults.fittings, 'pcs'],
[],
['Cost Breakdown'],
['Item', 'Quantity', 'Unit Cost', 'Total Cost'],
['Sanitary Pipes', sanitaryResults.pipeQuantity, '', costResults.sanitaryPipeCost],
['Sanitary Traps', sanitaryResults.traps, '', costResults.sanitaryTrapsCost],
['Sanitary Vents', sanitaryResults.vents, '', costResults.sanitaryVentsCost],
['Sanitary Cleanouts', sanitaryResults.cleanouts, '', costResults.sanitaryCleanoutsCost],
['Sanitary Manholes', sanitaryResults.manholes, '', costResults.sanitaryManholesCost],
['Sanitary Fittings', sanitaryResults.fittings, '', costResults.sanitaryFittingsCost],
['Storm Pipes', stormResults.pipeQuantity, '', costResults.stormPipeCost],
['Downspouts', stormResults.downspouts, '', costResults.stormDownspoutsCost],
['Catch Basins', stormResults.catchBasins, '', costResults.stormCatchBasinsCost],
['Storm Manholes', stormResults.manholes, '', costResults.stormManholesCost],
['Storm Fittings', stormResults.fittings, '', costResults.stormFittingsCost],
['Subtotal - Materials', '', '', costResults.totalMaterialCost],
['Labor Cost', '', '', costResults.totalLaborCost],
['TOTAL COST', '', '', costResults.totalCost],
[],
['Labor Requirements'],
['Metric', 'Value', 'Unit'],
['Total Labor Hours', laborResults.totalLaborHours, 'hours'],
['Plumber Hours', laborResults.plumberHours, 'hours'],
['Helper Hours', laborResults.helperHours, 'hours'],
['Equivalent Man-Days', laborResults.totalManDays, 'days'],
['Total Labor Cost', laborResults.totalLaborCost, '']
];

const ws = XLSX.utils.aoa_to_sheet(projectData);
XLSX.utils.book_append_sheet(wb, ws, 'Project Report');
const projectName = document.getElementById('projectName').value;
XLSX.writeFile(wb, `Sanitary_Storm_Report_${projectName.replace(/\s/g, '_')}.xlsx`);
}

function saveProject() {
const projectData = {
projectName: document.getElementById('projectName').value,
clientName: document.getElementById('clientName').value,
projectLocation: document.getElementById('projectLocation').value,
preparedBy: document.getElementById('preparedBy').value,
currency: document.getElementById('currency').value,
codeStandard: document.getElementById('codeStandard').value,
units: document.getElementById('units').value
};
localStorage.setItem('sanitaryStormProject', JSON.stringify(projectData));
alert('Project saved successfully!');
}

function loadProject() {
const savedProject = localStorage.getItem('sanitaryStormProject');
if (savedProject) {
const projectData = JSON.parse(savedProject);
document.getElementById('projectName').value = projectData.projectName || '';
document.getElementById('clientName').value = projectData.clientName || '';
document.getElementById('projectLocation').value = projectData.projectLocation || '';
document.getElementById('preparedBy').value = projectData.preparedBy || '';
document.getElementById('currency').value = projectData.currency || 'PHP';
document.getElementById('codeStandard').value = projectData.codeStandard || 'mpcp';
document.getElementById('units').value = projectData.units || 'metric';
alert('Project loaded successfully!');
} else {
alert('No saved project found.');
}
}

function resetCalculator() {
if (confirm('Are you sure you want to reset all inputs? This action cannot be undone.')) {
document.getElementById('projectName').value = 'Residential Plumbing Project';
document.getElementById('clientName').value = 'John Dela Cruz';
document.getElementById('projectLocation').value = 'Manila, Philippines';
document.getElementById('preparedBy').value = 'Maria Santos, Civil Engineer';
document.getElementById('currency').value = 'PHP';
document.getElementById('codeStandard').value = 'mpcp';
document.getElementById('units').value = 'metric';

document.getElementById('wc').value = '2';
document.getElementById('lav').value = '2';
document.getElementById('sink').value = '1';
document.getElementById('shower').value = '1';
document.getElementById('tub').value = '1';
document.getElementById('urinal').value = '0';
document.getElementById('floorDrain').value = '2';
document.getElementById('sanLength').value = '50';
document.getElementById('sanPipeMaterial').value = 'pvc';
document.getElementById('sanPipeLength').value = '6';
document.getElementById('sanSlope').value = '2';

document.getElementById('roofArea').value = '200';
document.getElementById('pavementArea').value = '0';
document.getElementById('coef').value = '0.9';
document.getElementById('intensity').value = '50';
document.getElementById('stormLength').value = '60';
document.getElementById('stormPipeMaterial').value = 'pvc';
document.getElementById('stormPipeLength').value = '6';
document.getElementById('stormSlope').value = '1';

document.getElementById('sanitaryPipesContainer').innerHTML = '';
document.getElementById('stormPipesContainer').innerHTML = '';
addSanitaryPipe();
addStormPipe();

document.getElementById('trapCost').value = '150';
document.getElementById('ventCost').value = '100';
document.getElementById('cleanoutCost').value = '200';
document.getElementById('manholeCost').value = '5000';
document.getElementById('fittingCost').value = '80';
document.getElementById('downspoutCost').value = '300';
document.getElementById('catchBasinCost').value = '2500';
document.getElementById('plumberRate').value = '80';
document.getElementById('helperRate').value = '50';
document.getElementById('dailyHours').value = '8';
document.getElementById('wasteFactor').value = '5';
document.getElementById('overhead').value = '15';
document.getElementById('profitMargin').value = '10';

sanitaryResults = null;
stormResults = null;
costResults = null;
laborResults = null;

document.getElementById('sanitaryOutput').innerHTML = '';
document.getElementById('sanitaryOutput').style.display = 'none';
document.getElementById('stormOutput').innerHTML = '';
document.getElementById('stormOutput').style.display = 'none';
document.getElementById('costsOutput').innerHTML = '';
document.getElementById('costsOutput').style.display = 'none';
document.getElementById('projectSummary').innerHTML = '';
document.getElementById('sanitarySummary').innerHTML = '';
document.getElementById('stormSummary').innerHTML = '';
document.getElementById('costBreakdown').getElementsByTagName('tbody')[0].innerHTML = '';
document.getElementById('laborSummary').innerHTML = '';

document.getElementById('projectSummaryCard').style.display = 'none';
document.getElementById('sanitarySummaryCard').style.display = 'none';
document.getElementById('stormSummaryCard').style.display = 'none';
document.getElementById('costBreakdownCard').style.display = 'none';
document.getElementById('laborSummaryCard').style.display = 'none';

alert('Calculator has been reset to default values.');
}
}
</script>
</body>
</html>
